



<!doctype html>
<html lang="zh" class="no-js">
  <head>

      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <meta http-equiv="x-ua-compatible" content="ie=edge">

        <meta name="description" content="CTF Wiki">


        <link rel="canonical" href="https://ctf-wiki.github.io/ctf-wiki/pwn/linux/glibc-heap/heap_structure/">


        <meta name="author" content="CTF Wiki Team">


        <meta name="lang:clipboard.copy" content="复制">

        <meta name="lang:clipboard.copied" content="已复制">

        <meta name="lang:search.language" content="jp">

        <meta name="lang:search.pipeline.stopwords" content="True">

        <meta name="lang:search.pipeline.trimmer" content="True">

        <meta name="lang:search.result.none" content="没有找到符合条件的结果">

        <meta name="lang:search.result.one" content="找到 1 个符合条件的结果">

        <meta name="lang:search.result.other" content="# 个符合条件的结果">

        <meta name="lang:search.tokenizer" content="[\uff0c\u3002]+">

      <link rel="shortcut icon" href="../../../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.0.4, mkdocs-material-4.6.2">



        <title>Heap structure - CTF Wiki</title>



      <link rel="stylesheet" href="../../../../assets/stylesheets/application.adb8469c.css">

        <link rel="stylesheet" href="../../../../assets/stylesheets/application-palette.a8b3c06d.css">




        <meta name="theme-color" content="">



      <script src="../../../../assets/javascripts/modernizr.86422ebf.js"></script>



        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Noto+Sans:300,400,400i,700%7CSource+Code+Pro&display=fallback">
        <style>body,input{font-family:"Noto Sans","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Source Code Pro","Courier New",Courier,monospace}</style>


    <link rel="stylesheet" href="../../../../assets/fonts/material-icons.css">


      <link rel="stylesheet" href="../../../../stylesheets/dark_theme.css">

      <link rel="stylesheet" href="../../../../stylesheets/codehilite.css">

      <link rel="stylesheet" href="../../../../_static/css/extra.css">





<meta name="theme-color" content="#212121">

<link rel='icon' href='/assets/images/favicon.ico'>

<meta name='apple-mobile-web-app-capable' content='yes'>
<meta name='mobile-web-app-capable' content='yes'>
<link rel="manifest" href="/manifest.json">

  </head>



    <body dir="ltr" data-md-color-primary="blue" data-md-color-accent="red">

    <svg class="md-svg">
      <defs>


          <svg xmlns="http://www.w3.org/2000/svg" width="416" height="448" viewBox="0 0 416 448" id="__github"><path fill="currentColor" d="M160 304q0 10-3.125 20.5t-10.75 19T128 352t-18.125-8.5-10.75-19T96 304t3.125-20.5 10.75-19T128 256t18.125 8.5 10.75 19T160 304zm160 0q0 10-3.125 20.5t-10.75 19T288 352t-18.125-8.5-10.75-19T256 304t3.125-20.5 10.75-19T288 256t18.125 8.5 10.75 19T320 304zm40 0q0-30-17.25-51T296 232q-10.25 0-48.75 5.25Q229.5 240 208 240t-39.25-2.75Q130.75 232 120 232q-29.5 0-46.75 21T56 304q0 22 8 38.375t20.25 25.75 30.5 15 35 7.375 37.25 1.75h42q20.5 0 37.25-1.75t35-7.375 30.5-15 20.25-25.75T360 304zm56-44q0 51.75-15.25 82.75-9.5 19.25-26.375 33.25t-35.25 21.5-42.5 11.875-42.875 5.5T212 416q-19.5 0-35.5-.75t-36.875-3.125-38.125-7.5-34.25-12.875T37 371.5t-21.5-28.75Q0 312 0 260q0-59.25 34-99-6.75-20.5-6.75-42.5 0-29 12.75-54.5 27 0 47.5 9.875t47.25 30.875Q171.5 96 212 96q37 0 70 8 26.25-20.5 46.75-30.25T376 64q12.75 25.5 12.75 54.5 0 21.75-6.75 42 34 40 34 99.5z"/></svg>

      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" data-md-component="overlay" for="__drawer"></label>

      <a href="#related-data-structure" tabindex="0" class="md-skip">
        跳转至
      </a>


      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex">
      <div class="md-flex__cell md-flex__cell--shrink">
        <a href="https://ctf-wiki.github.io/ctf-wiki/" title="CTF Wiki" aria-label="CTF Wiki" class="md-header-nav__button md-logo">

            <i class="md-icon">school</i>

        </a>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="__drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">

            <span class="md-header-nav__topic">
              CTF Wiki
            </span>
            <span class="md-header-nav__topic">

                Heap structure

            </span>

        </div>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">

          <label class="md-icon md-icon--search md-header-nav__button" for="__search"></label>

<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" aria-label="search" name="query" placeholder="搜索" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query" data-md-state="active">
      <label class="md-icon md-search__icon" for="__search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">
        &#xE5CD;
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result">
          <div class="md-search-result__meta">
            键入以开始搜索
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>

      </div>

        <div class="md-flex__cell md-flex__cell--shrink">
          <div class="md-header-nav__source">





<a href="https://github.com/ctf-wiki/ctf-wiki/" title="前往 Github 仓库" class="md-source" data-md-source="github">

    <div class="md-source__icon">
      <svg viewBox="0 0 24 24" width="24" height="24">
        <use xlink:href="#__github" width="24" height="24"></use>
      </svg>
    </div>

  <div class="md-source__repository">
    ctf-wiki/ctf-wiki
  </div>
</a>
          </div>
        </div>

    </div>
  </nav>
</header>

    <div class="md-container">






<nav class="md-tabs" data-md-component="tabs">
  <div class="md-tabs__inner md-grid">
    <ul class="md-tabs__list">




    <li class="md-tabs__item">

        <a href="../../../.." class="md-tabs__link">
          Introduction
        </a>

    </li>






    <li class="md-tabs__item">

        <a href="../../../../misc/introduction-zh/" class="md-tabs__link">
          Misc
        </a>

    </li>






    <li class="md-tabs__item">

        <a href="../../../../crypto/introduction-zh/" class="md-tabs__link">
          Crypto
        </a>

    </li>






    <li class="md-tabs__item">

        <a href="../../../../web/introduction-zh/" class="md-tabs__link">
          Web
        </a>

    </li>






    <li class="md-tabs__item">

        <a href="../../../../assembly/x86-x64/readme-zh/" class="md-tabs__link">
          Assembly
        </a>

    </li>










    <li class="md-tabs__item">

        <a href="../../../../executable/elf/elf-structure-zh/" class="md-tabs__link">
          Executable
        </a>

    </li>












    <li class="md-tabs__item">

        <a href="../../../../reverse/introduction-zh/" class="md-tabs__link">
          Reverse Engineering
        </a>

    </li>












    <li class="md-tabs__item">

        <a href="../../../readme-zh/" class="md-tabs__link">
          Pwn
        </a>

    </li>








    <li class="md-tabs__item">

        <a href="../../../../android/basic_develop/basic_develop-zh/" class="md-tabs__link">
          Android
        </a>

    </li>






    <li class="md-tabs__item">

        <a href="../../../../ics/ctfs-zh/" class="md-tabs__link">
          ICS
        </a>

    </li>



    </ul>
  </div>
</nav>

      <main class="md-main" role="main">
        <div class="md-main__inner md-grid" data-md-component="container">


              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="__drawer">
    <a href="https://ctf-wiki.github.io/ctf-wiki/" title="CTF Wiki" class="md-nav__button md-logo">

        <i class="md-icon">school</i>

    </a>
    CTF Wiki
  </label>

    <div class="md-nav__source">





<a href="https://github.com/ctf-wiki/ctf-wiki/" title="前往 Github 仓库" class="md-source" data-md-source="github">

    <div class="md-source__icon">
      <svg viewBox="0 0 24 24" width="24" height="24">
        <use xlink:href="#__github" width="24" height="24"></use>
      </svg>
    </div>

  <div class="md-source__repository">
    ctf-wiki/ctf-wiki
  </div>
</a>
    </div>

  <ul class="md-nav__list" data-md-scrollfix>






  <li class="md-nav__item md-nav__item--nested">

      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-1" type="checkbox" id="nav-1">

    <label class="md-nav__link" for="nav-1">
      Introduction
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-1">
        Introduction
      </label>
      <ul class="md-nav__list" data-md-scrollfix>







  <li class="md-nav__item">
    <a href="../../../.." title="Getting Started" class="md-nav__link">
      Getting Started
    </a>
  </li>







  <li class="md-nav__item">
    <a href="../../../../introduction/history-zh/" title="CTF History" class="md-nav__link">
      CTF History
    </a>
  </li>







  <li class="md-nav__item">
    <a href="../../../../introduction/mode-zh/" title="Introduction to CTF Competition Form" class="md-nav__link">
      Introduction to CTF Competition Form
    </a>
  </li>







  <li class="md-nav__item">
    <a href="../../../../introduction/content-zh/" title="CTF Contest Content" class="md-nav__link">
      CTF Contest Content
    </a>
  </li>







  <li class="md-nav__item">
    <a href="../../../../introduction/experience-zh/" title="Offline Attack and Defense Experience Summary" class="md-nav__link">
      Offline Attack and Defense Experience Summary
    </a>
  </li>







  <li class="md-nav__item">
    <a href="../../../../introduction/cgc-zh/" title="CGC Super Challenge" class="md-nav__link">
      CGC Super Challenge
    </a>
  </li>







  <li class="md-nav__item">
    <a href="../../../../introduction/resources-zh/" title="Learning Resources" class="md-nav__link">
      Learning Resources
    </a>
  </li>


      </ul>
    </nav>
  </li>







  <li class="md-nav__item md-nav__item--nested">

      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-2" type="checkbox" id="nav-2">

    <label class="md-nav__link" for="nav-2">
      Misc
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-2">
        Misc
      </label>
      <ul class="md-nav__list" data-md-scrollfix>







  <li class="md-nav__item">
    <a href="../../../../misc/introduction-zh/" title="Miscellaneous Introduction" class="md-nav__link">
      Miscellaneous Introduction
    </a>
  </li>







  <li class="md-nav__item">
    <a href="../../../../misc/recon-zh/" title="Information Gathering Technology" class="md-nav__link">
      Information Gathering Technology
    </a>
  </li>







  <li class="md-nav__item md-nav__item--nested">

      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-2-3" type="checkbox" id="nav-2-3">

    <label class="md-nav__link" for="nav-2-3">
      Code Analysis
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-2-3">
        Code Analysis
      </label>
      <ul class="md-nav__list" data-md-scrollfix>







  <li class="md-nav__item">
    <a href="../../../../misc/encode/communication-zh/" title="Commonly Used Coding in the Communication Field" class="md-nav__link">
      Commonly Used Coding in the Communication Field
    </a>
  </li>







  <li class="md-nav__item">
    <a href="../../../../misc/encode/computer-zh/" title="Computer Related Coding" class="md-nav__link">
      Computer Related Coding
    </a>
  </li>







  <li class="md-nav__item">
    <a href="../../../../misc/encode/modern-zh/" title="Commonly Used Encodings in the Real World" class="md-nav__link">
      Commonly Used Encodings in the Real World
    </a>
  </li>


      </ul>
    </nav>
  </li>







  <li class="md-nav__item">
    <a href="../../../../misc/prefix-zh/" title="Forensic Steganography" class="md-nav__link">
      Forensic Steganography
    </a>
  </li>







  <li class="md-nav__item md-nav__item--nested">

      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-2-5" type="checkbox" id="nav-2-5">

    <label class="md-nav__link" for="nav-2-5">
      Image Analysis
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-2-5">
        Image Analysis
      </label>
      <ul class="md-nav__list" data-md-scrollfix>







  <li class="md-nav__item">
    <a href="../../../../misc/picture/introduction-zh/" title="Introduction to Image Analysis" class="md-nav__link">
      Introduction to Image Analysis
    </a>
  </li>







  <li class="md-nav__item">
    <a href="../../../../misc/picture/png-zh/" title="PNG" class="md-nav__link">
      PNG
    </a>
  </li>







  <li class="md-nav__item">
    <a href="../../../../misc/picture/jpg-zh/" title="JPG" class="md-nav__link">
      JPG
    </a>
  </li>







  <li class="md-nav__item">
    <a href="../../../../misc/picture/gif-zh/" title="GIF" class="md-nav__link">
      GIF
    </a>
  </li>


      </ul>
    </nav>
  </li>







  <li class="md-nav__item md-nav__item--nested">

      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-2-6" type="checkbox" id="nav-2-6">

    <label class="md-nav__link" for="nav-2-6">
      Traffic Packet Analysis
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-2-6">
        Traffic Packet Analysis
      </label>
      <ul class="md-nav__list" data-md-scrollfix>







  <li class="md-nav__item">
    <a href="../../../../misc/traffic/introduction-zh/" title="Introduction to Traffic Packet Analysis" class="md-nav__link">
      Introduction to Traffic Packet Analysis
    </a>
  </li>







  <li class="md-nav__item">
    <a href="../../../../misc/traffic/fix-zh/" title="PCAP File Repairing" class="md-nav__link">
      PCAP File Repairing
    </a>
  </li>







  <li class="md-nav__item md-nav__item--nested">

      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-2-6-3" type="checkbox" id="nav-2-6-3">

    <label class="md-nav__link" for="nav-2-6-3">
      Protocol Analysis
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="3">
      <label class="md-nav__title" for="nav-2-6-3">
        Protocol Analysis
      </label>
      <ul class="md-nav__list" data-md-scrollfix>







  <li class="md-nav__item">
    <a href="../../../../misc/traffic/protocols/README-zh/" title="Overview of Protocol Analysis" class="md-nav__link">
      Overview of Protocol Analysis
    </a>
  </li>







  <li class="md-nav__item">
    <a href="../../../../misc/traffic/protocols/Wireshark-zh/" title="Wireshark" class="md-nav__link">
      Wireshark
    </a>
  </li>







  <li class="md-nav__item">
    <a href="../../../../misc/traffic/protocols/HTTP-zh/" title="HTTP" class="md-nav__link">
      HTTP
    </a>
  </li>







  <li class="md-nav__item">
    <a href="../../../../misc/traffic/protocols/HTTPS-zh/" title="HTTPS" class="md-nav__link">
      HTTPS
    </a>
  </li>







  <li class="md-nav__item">
    <a href="../../../../misc/traffic/protocols/FTP-zh/" title="FTP" class="md-nav__link">
      FTP
    </a>
  </li>







  <li class="md-nav__item">
    <a href="../../../../misc/traffic/protocols/DNS-zh/" title="DNS" class="md-nav__link">
      DNS
    </a>
  </li>







  <li class="md-nav__item">
    <a href="../../../../misc/traffic/protocols/WIFI-zh/" title="WIFI" class="md-nav__link">
      WIFI
    </a>
  </li>







  <li class="md-nav__item">
    <a href="../../../../misc/traffic/protocols/USB-zh/" title="USB" class="md-nav__link">
      USB
    </a>
  </li>


      </ul>
    </nav>
  </li>







  <li class="md-nav__item">
    <a href="../../../../misc/traffic/data-zh/" title="Data Extraction" class="md-nav__link">
      Data Extraction
    </a>
  </li>


      </ul>
    </nav>
  </li>







  <li class="md-nav__item md-nav__item--nested">

      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-2-7" type="checkbox" id="nav-2-7">

    <label class="md-nav__link" for="nav-2-7">
      Compressed Package Analysis
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-2-7">
        Compressed Package Analysis
      </label>
      <ul class="md-nav__list" data-md-scrollfix>







  <li class="md-nav__item">
    <a href="../../../../misc/archive/zip-zh/" title="ZIP Format" class="md-nav__link">
      ZIP Format
    </a>
  </li>







  <li class="md-nav__item">
    <a href="../../../../misc/archive/rar-zh/" title="RAR Format" class="md-nav__link">
      RAR Format
    </a>
  </li>


      </ul>
    </nav>
  </li>







  <li class="md-nav__item">
    <a href="../../../../misc/audio/introduction-zh/" title="Audio Steganography" class="md-nav__link">
      Audio Steganography
    </a>
  </li>







  <li class="md-nav__item md-nav__item--nested">

      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-2-9" type="checkbox" id="nav-2-9">

    <label class="md-nav__link" for="nav-2-9">
      Disk Memory Analysis
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-2-9">
        Disk Memory Analysis
      </label>
      <ul class="md-nav__list" data-md-scrollfix>







  <li class="md-nav__item">
    <a href="../../../../misc/disk-memory/introduction-zh/" title="Introduction" class="md-nav__link">
      Introduction
    </a>
  </li>







  <li class="md-nav__item">
    <a href="../../../../misc/disk-memory/problem-zh/" title="Title" class="md-nav__link">
      Title
    </a>
  </li>


      </ul>
    </nav>
  </li>







  <li class="md-nav__item md-nav__item--nested">

      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-2-10" type="checkbox" id="nav-2-10">

    <label class="md-nav__link" for="nav-2-10">
      Other
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-2-10">
        Other
      </label>
      <ul class="md-nav__list" data-md-scrollfix>







  <li class="md-nav__item">
    <a href="../../../../misc/other/pyc-zh/" title="pyc File" class="md-nav__link">
      pyc File
    </a>
  </li>


      </ul>
    </nav>
  </li>


      </ul>
    </nav>
  </li>







  <li class="md-nav__item md-nav__item--nested">

      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3" type="checkbox" id="nav-3">

    <label class="md-nav__link" for="nav-3">
      Crypto
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-3">
        Crypto
      </label>
      <ul class="md-nav__list" data-md-scrollfix>







  <li class="md-nav__item">
    <a href="../../../../crypto/introduction-zh/" title="Introduction to Cryptography" class="md-nav__link">
      Introduction to Cryptography
    </a>
  </li>







  <li class="md-nav__item md-nav__item--nested">

      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3-2" type="checkbox" id="nav-3-2">

    <label class="md-nav__link" for="nav-3-2">
      Basic Mathematics
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-3-2">
        Basic Mathematics
      </label>
      <ul class="md-nav__list" data-md-scrollfix>







  <li class="md-nav__item">
    <a href="../../../../crypto/basic/introduction-zh/" title="Introduction" class="md-nav__link">
      Introduction
    </a>
  </li>


      </ul>
    </nav>
  </li>







  <li class="md-nav__item md-nav__item--nested">

      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3-3" type="checkbox" id="nav-3-3">

    <label class="md-nav__link" for="nav-3-3">
      Classical Cryptography
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-3-3">
        Classical Cryptography
      </label>
      <ul class="md-nav__list" data-md-scrollfix>







  <li class="md-nav__item">
    <a href="../../../../crypto/classical/introduction-zh/" title="Introduction to Classical Cryptography" class="md-nav__link">
      Introduction to Classical Cryptography
    </a>
  </li>







  <li class="md-nav__item">
    <a href="../../../../crypto/classical/monoalphabetic-zh/" title="Single table Substitution Cipher" class="md-nav__link">
      Single table Substitution Cipher
    </a>
  </li>







  <li class="md-nav__item">
    <a href="../../../../crypto/classical/polyalphabetic-zh/" title="Multi-table Substitution Cipher" class="md-nav__link">
      Multi-table Substitution Cipher
    </a>
  </li>







  <li class="md-nav__item">
    <a href="../../../../crypto/classical/others-zh/" title="Other Types of Cipher" class="md-nav__link">
      Other Types of Cipher
    </a>
  </li>







  <li class="md-nav__item">
    <a href="../../../../crypto/classical/summary-zh/" title="Summary" class="md-nav__link">
      Summary
    </a>
  </li>


      </ul>
    </nav>
  </li>







  <li class="md-nav__item md-nav__item--nested">

      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3-4" type="checkbox" id="nav-3-4">

    <label class="md-nav__link" for="nav-3-4">
      Stream Cipher
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-3-4">
        Stream Cipher
      </label>
      <ul class="md-nav__list" data-md-scrollfix>







  <li class="md-nav__item">
    <a href="../../../../crypto/streamcipher/intro-zh/" title="Introduction" class="md-nav__link">
      Introduction
    </a>
  </li>







  <li class="md-nav__item md-nav__item--nested">

      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3-4-2" type="checkbox" id="nav-3-4-2">

    <label class="md-nav__link" for="nav-3-4-2">
      Pseudo Random Number Generator
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="3">
      <label class="md-nav__title" for="nav-3-4-2">
        Pseudo Random Number Generator
      </label>
      <ul class="md-nav__list" data-md-scrollfix>







  <li class="md-nav__item">
    <a href="../../../../crypto/streamcipher/prng/intro-zh/" title="Introduction" class="md-nav__link">
      Introduction
    </a>
  </li>







  <li class="md-nav__item">
    <a href="../../../../crypto/streamcipher/prng/csprng-zh/" title="Cryptographic Security Pseudo-random Number Generator" class="md-nav__link">
      Cryptographic Security Pseudo-random Number Generator
    </a>
  </li>







  <li class="md-nav__item">
    <a href="../../../../crypto/streamcipher/prng/problem-zh/" title="Challenge Examples" class="md-nav__link">
      Challenge Examples
    </a>
  </li>


      </ul>
    </nav>
  </li>







  <li class="md-nav__item md-nav__item--nested">

      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3-4-3" type="checkbox" id="nav-3-4-3">

    <label class="md-nav__link" for="nav-3-4-3">
      Linear Congruence Generator
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="3">
      <label class="md-nav__title" for="nav-3-4-3">
        Linear Congruence Generator
      </label>
      <ul class="md-nav__list" data-md-scrollfix>







  <li class="md-nav__item">
    <a href="../../../../crypto/streamcipher/lcg/intro-zh/" title="Introduction" class="md-nav__link">
      Introduction
    </a>
  </li>







  <li class="md-nav__item">
    <a href="../../../../crypto/streamcipher/lcg/challenge-zh/" title="Example" class="md-nav__link">
      Example
    </a>
  </li>


      </ul>
    </nav>
  </li>







  <li class="md-nav__item md-nav__item--nested">

      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3-4-4" type="checkbox" id="nav-3-4-4">

    <label class="md-nav__link" for="nav-3-4-4">
      Feedback Shift Register
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="3">
      <label class="md-nav__title" for="nav-3-4-4">
        Feedback Shift Register
      </label>
      <ul class="md-nav__list" data-md-scrollfix>







  <li class="md-nav__item">
    <a href="../../../../crypto/streamcipher/fsr/intro-zh/" title="Introduction" class="md-nav__link">
      Introduction
    </a>
  </li>







  <li class="md-nav__item">
    <a href="../../../../crypto/streamcipher/fsr/lfsr-zh/" title="Linear Feedback Shift Register" class="md-nav__link">
      Linear Feedback Shift Register
    </a>
  </li>







  <li class="md-nav__item">
    <a href="../../../../crypto/streamcipher/fsr/nfsr-zh/" title="Nonlinear Feedback Shift Register" class="md-nav__link">
      Nonlinear Feedback Shift Register
    </a>
  </li>


      </ul>
    </nav>
  </li>







  <li class="md-nav__item md-nav__item--nested">

      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3-4-5" type="checkbox" id="nav-3-4-5">

    <label class="md-nav__link" for="nav-3-4-5">
      Special Stream Cipher
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="3">
      <label class="md-nav__title" for="nav-3-4-5">
        Special Stream Cipher
      </label>
      <ul class="md-nav__list" data-md-scrollfix>







  <li class="md-nav__item">
    <a href="../../../../crypto/streamcipher/special/rc4-zh/" title="RC4" class="md-nav__link">
      RC4
    </a>
  </li>


      </ul>
    </nav>
  </li>


      </ul>
    </nav>
  </li>







  <li class="md-nav__item md-nav__item--nested">

      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3-5" type="checkbox" id="nav-3-5">

    <label class="md-nav__link" for="nav-3-5">
      Block Cipher
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-3-5">
        Block Cipher
      </label>
      <ul class="md-nav__list" data-md-scrollfix>







  <li class="md-nav__item">
    <a href="../../../../crypto/blockcipher/introduction-zh/" title="Introduction to Block Cipher" class="md-nav__link">
      Introduction to Block Cipher
    </a>
  </li>







  <li class="md-nav__item">
    <a href="../../../../crypto/blockcipher/arx-operations-zh/" title="ARX" class="md-nav__link">
      ARX
    </a>
  </li>







  <li class="md-nav__item">
    <a href="../../../../crypto/blockcipher/des-zh/" title="DES" class="md-nav__link">
      DES
    </a>
  </li>







  <li class="md-nav__item">
    <a href="../../../../crypto/blockcipher/idea-zh/" title="IDEA" class="md-nav__link">
      IDEA
    </a>
  </li>







  <li class="md-nav__item">
    <a href="../../../../crypto/blockcipher/aes-zh/" title="AES" class="md-nav__link">
      AES
    </a>
  </li>







  <li class="md-nav__item">
    <a href="../../../../crypto/blockcipher/simon-speck-zh/" title="Simon and Speck" class="md-nav__link">
      Simon and Speck
    </a>
  </li>







  <li class="md-nav__item md-nav__item--nested">

      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3-5-7" type="checkbox" id="nav-3-5-7">

    <label class="md-nav__link" for="nav-3-5-7">
      Group Mode
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="3">
      <label class="md-nav__title" for="nav-3-5-7">
        Group Mode
      </label>
      <ul class="md-nav__list" data-md-scrollfix>







  <li class="md-nav__item">
    <a href="../../../../crypto/blockcipher/mode/introduction-zh/" title="Introduction" class="md-nav__link">
      Introduction
    </a>
  </li>







  <li class="md-nav__item">
    <a href="../../../../crypto/blockcipher/mode/padding-zh/" title="Padding Methods" class="md-nav__link">
      Padding Methods
    </a>
  </li>







  <li class="md-nav__item">
    <a href="../../../../crypto/blockcipher/mode/ecb-zh/" title="ECB" class="md-nav__link">
      ECB
    </a>
  </li>







  <li class="md-nav__item">
    <a href="../../../../crypto/blockcipher/mode/cbc-zh/" title="CBC" class="md-nav__link">
      CBC
    </a>
  </li>







  <li class="md-nav__item">
    <a href="../../../../crypto/blockcipher/mode/pcbc-zh/" title="PCBC" class="md-nav__link">
      PCBC
    </a>
  </li>







  <li class="md-nav__item">
    <a href="../../../../crypto/blockcipher/mode/cfb-zh/" title="CFB" class="md-nav__link">
      CFB
    </a>
  </li>







  <li class="md-nav__item">
    <a href="../../../../crypto/blockcipher/mode/ofb-zh/" title="OFB" class="md-nav__link">
      OFB
    </a>
  </li>







  <li class="md-nav__item">
    <a href="../../../../crypto/blockcipher/mode/ctr-zh/" title="CTR" class="md-nav__link">
      CTR
    </a>
  </li>







  <li class="md-nav__item">
    <a href="../../../../crypto/blockcipher/mode/padding-oracle-attack-zh/" title="Padding Oracle Attack" class="md-nav__link">
      Padding Oracle Attack
    </a>
  </li>


      </ul>
    </nav>
  </li>


      </ul>
    </nav>
  </li>







  <li class="md-nav__item md-nav__item--nested">

      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3-6" type="checkbox" id="nav-3-6">

    <label class="md-nav__link" for="nav-3-6">
      Asymmetric Cryptography
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-3-6">
        Asymmetric Cryptography
      </label>
      <ul class="md-nav__list" data-md-scrollfix>







  <li class="md-nav__item">
    <a href="../../../../crypto/asymmetric/introduction-zh/" title="Introduction to Asymmetric Cryptography" class="md-nav__link">
      Introduction to Asymmetric Cryptography
    </a>
  </li>







  <li class="md-nav__item md-nav__item--nested">

      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3-6-2" type="checkbox" id="nav-3-6-2">

    <label class="md-nav__link" for="nav-3-6-2">
      RSA
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="3">
      <label class="md-nav__title" for="nav-3-6-2">
        RSA
      </label>
      <ul class="md-nav__list" data-md-scrollfix>







  <li class="md-nav__item">
    <a href="../../../../crypto/asymmetric/rsa/rsa_theory-zh/" title="RSA Introduction" class="md-nav__link">
      RSA Introduction
    </a>
  </li>







  <li class="md-nav__item">
    <a href="../../../../crypto/asymmetric/rsa/rsa_module_attack-zh/" title="Modulo-related Attacks" class="md-nav__link">
      Modulo-related Attacks
    </a>
  </li>







  <li class="md-nav__item">
    <a href="../../../../crypto/asymmetric/rsa/rsa_e_attack-zh/" title="Public Key Index Related Attacks" class="md-nav__link">
      Public Key Index Related Attacks
    </a>
  </li>







  <li class="md-nav__item">
    <a href="../../../../crypto/asymmetric/rsa/rsa_d_attack-zh/" title="Private Key d Related Attacks" class="md-nav__link">
      Private Key d Related Attacks
    </a>
  </li>







  <li class="md-nav__item">
    <a href="../../../../crypto/asymmetric/rsa/rsa_coppersmith_attack-zh/" title="Coppersmith Related Attacks" class="md-nav__link">
      Coppersmith Related Attacks
    </a>
  </li>







  <li class="md-nav__item">
    <a href="../../../../crypto/asymmetric/rsa/rsa_chosen_plain_cipher-zh/" title="Chosen Plain Cipher Attack" class="md-nav__link">
      Chosen Plain Cipher Attack
    </a>
  </li>







  <li class="md-nav__item">
    <a href="../../../../crypto/asymmetric/rsa/rsa_side_channel-zh/" title="Side Channel Attack" class="md-nav__link">
      Side Channel Attack
    </a>
  </li>







  <li class="md-nav__item">
    <a href="../../../../crypto/asymmetric/rsa/rsa_pkcs_attack-zh/" title="Bleichenbacher Attack" class="md-nav__link">
      Bleichenbacher Attack
    </a>
  </li>







  <li class="md-nav__item">
    <a href="../../../../crypto/asymmetric/rsa/rsa_complex-zh/" title="Challenge Examples" class="md-nav__link">
      Challenge Examples
    </a>
  </li>


      </ul>
    </nav>
  </li>







  <li class="md-nav__item">
    <a href="../../../../crypto/asymmetric/knapsack/knapsack-zh/" title="Knapsack Cipher" class="md-nav__link">
      Knapsack Cipher
    </a>
  </li>







  <li class="md-nav__item md-nav__item--nested">

      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3-6-4" type="checkbox" id="nav-3-6-4">

    <label class="md-nav__link" for="nav-3-6-4">
      Discrete Log Correlation
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="3">
      <label class="md-nav__title" for="nav-3-6-4">
        Discrete Log Correlation
      </label>
      <ul class="md-nav__list" data-md-scrollfix>







  <li class="md-nav__item">
    <a href="../../../../crypto/asymmetric/discrete-log/discrete-log-zh/" title="Discrete Logarithm" class="md-nav__link">
      Discrete Logarithm
    </a>
  </li>







  <li class="md-nav__item">
    <a href="../../../../crypto/asymmetric/discrete-log/elgamal-zh/" title="Elgamal" class="md-nav__link">
      Elgamal
    </a>
  </li>







  <li class="md-nav__item">
    <a href="../../../../crypto/asymmetric/discrete-log/ecc-zh/" title="ECC" class="md-nav__link">
      ECC
    </a>
  </li>


      </ul>
    </nav>
  </li>







  <li class="md-nav__item md-nav__item--nested">

      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3-6-5" type="checkbox" id="nav-3-6-5">

    <label class="md-nav__link" for="nav-3-6-5">
      Lattice-based Cryptography
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="3">
      <label class="md-nav__title" for="nav-3-6-5">
        Lattice-based Cryptography
      </label>
      <ul class="md-nav__list" data-md-scrollfix>







  <li class="md-nav__item">
    <a href="../../../../crypto/asymmetric/lattice/overview-zh/" title="Lattice Overview" class="md-nav__link">
      Lattice Overview
    </a>
  </li>







  <li class="md-nav__item">
    <a href="../../../../crypto/asymmetric/lattice/introduction-zh/" title="Introduction to Lattices" class="md-nav__link">
      Introduction to Lattices
    </a>
  </li>







  <li class="md-nav__item">
    <a href="../../../../crypto/asymmetric/lattice/lattice-reduction-zh/" title="Lattice-based Algorithm" class="md-nav__link">
      Lattice-based Algorithm
    </a>
  </li>







  <li class="md-nav__item">
    <a href="../../../../crypto/asymmetric/lattice/cvp-zh/" title="CVP" class="md-nav__link">
      CVP
    </a>
  </li>


      </ul>
    </nav>
  </li>


      </ul>
    </nav>
  </li>







  <li class="md-nav__item md-nav__item--nested">

      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3-7" type="checkbox" id="nav-3-7">

    <label class="md-nav__link" for="nav-3-7">
      Hash Function
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-3-7">
        Hash Function
      </label>
      <ul class="md-nav__list" data-md-scrollfix>







  <li class="md-nav__item">
    <a href="../../../../crypto/hash/introduction-zh/" title="Introduction to the Hash Function" class="md-nav__link">
      Introduction to the Hash Function
    </a>
  </li>







  <li class="md-nav__item">
    <a href="../../../../crypto/hash/md5-zh/" title="MD5" class="md-nav__link">
      MD5
    </a>
  </li>







  <li class="md-nav__item">
    <a href="../../../../crypto/hash/sha1-zh/" title="SHA1" class="md-nav__link">
      SHA1
    </a>
  </li>







  <li class="md-nav__item">
    <a href="../../../../crypto/hash/fnv-zh/" title="FNV" class="md-nav__link">
      FNV
    </a>
  </li>







  <li class="md-nav__item">
    <a href="../../../../crypto/hash/attack-zh/" title="Hash Attack" class="md-nav__link">
      Hash Attack
    </a>
  </li>







  <li class="md-nav__item">
    <a href="../../../../crypto/hash/complex-zh/" title="Challenge Examples" class="md-nav__link">
      Challenge Examples
    </a>
  </li>


      </ul>
    </nav>
  </li>







  <li class="md-nav__item md-nav__item--nested">

      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3-8" type="checkbox" id="nav-3-8">

    <label class="md-nav__link" for="nav-3-8">
      Digital Signature
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-3-8">
        Digital Signature
      </label>
      <ul class="md-nav__list" data-md-scrollfix>







  <li class="md-nav__item">
    <a href="../../../../crypto/signature/introduction-zh/" title="Introduction to Digital Signatures" class="md-nav__link">
      Introduction to Digital Signatures
    </a>
  </li>







  <li class="md-nav__item">
    <a href="../../../../crypto/signature/rsa-zh/" title="RSA Digital Signature" class="md-nav__link">
      RSA Digital Signature
    </a>
  </li>







  <li class="md-nav__item">
    <a href="../../../../crypto/signature/elgamal-zh/" title="ElGamal Digital Signature" class="md-nav__link">
      ElGamal Digital Signature
    </a>
  </li>







  <li class="md-nav__item">
    <a href="../../../../crypto/signature/dsa-zh/" title="DSA Digital Signature" class="md-nav__link">
      DSA Digital Signature
    </a>
  </li>


      </ul>
    </nav>
  </li>







  <li class="md-nav__item md-nav__item--nested">

      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3-9" type="checkbox" id="nav-3-9">

    <label class="md-nav__link" for="nav-3-9">
      Summary of Attack Techniques
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-3-9">
        Summary of Attack Techniques
      </label>
      <ul class="md-nav__list" data-md-scrollfix>







  <li class="md-nav__item">
    <a href="../../../../crypto/attack-summary/attack-mode-zh/" title="Introduction" class="md-nav__link">
      Introduction
    </a>
  </li>







  <li class="md-nav__item">
    <a href="../../../../crypto/attack-summary/meet-in-the-middle-zh/" title="Intermediate Encounter Attack" class="md-nav__link">
      Intermediate Encounter Attack
    </a>
  </li>







  <li class="md-nav__item">
    <a href="../../../../crypto/attack-summary/bit-attack-zh/" title="Bit attack" class="md-nav__link">
      Bit attack
    </a>
  </li>


      </ul>
    </nav>
  </li>







  <li class="md-nav__item">
    <a href="../../../../crypto/certificate/introduction-zh/" title="Certificate Format" class="md-nav__link">
      Certificate Format
    </a>
  </li>


      </ul>
    </nav>
  </li>







  <li class="md-nav__item md-nav__item--nested">

      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-4" type="checkbox" id="nav-4">

    <label class="md-nav__link" for="nav-4">
      Web
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-4">
        Web
      </label>
      <ul class="md-nav__list" data-md-scrollfix>







  <li class="md-nav__item">
    <a href="../../../../web/introduction-zh/" title="Introduction to Web Applications" class="md-nav__link">
      Introduction to Web Applications
    </a>
  </li>







  <li class="md-nav__item">
    <a href="../../../../web/sqli-zh/" title="SQL Injection" class="md-nav__link">
      SQL Injection
    </a>
  </li>







  <li class="md-nav__item">
    <a href="../../../../web/xss-zh/" title="XSS Cross-site Scripting Attack" class="md-nav__link">
      XSS Cross-site Scripting Attack
    </a>
  </li>







  <li class="md-nav__item">
    <a href="../../../../web/csrf-zh/" title="CSRF Cross-site Request Forgery" class="md-nav__link">
      CSRF Cross-site Request Forgery
    </a>
  </li>







  <li class="md-nav__item">
    <a href="../../../../web/ssrf-zh/" title="SSRF Server Request Forgery" class="md-nav__link">
      SSRF Server Request Forgery
    </a>
  </li>







  <li class="md-nav__item">
    <a href="../../../../web/php/php-zh/" title="PHP Code Auditing" class="md-nav__link">
      PHP Code Auditing
    </a>
  </li>


      </ul>
    </nav>
  </li>







  <li class="md-nav__item md-nav__item--nested">

      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-5" type="checkbox" id="nav-5">

    <label class="md-nav__link" for="nav-5">
      Assembly
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-5">
        Assembly
      </label>
      <ul class="md-nav__list" data-md-scrollfix>







  <li class="md-nav__item">
    <a href="../../../../assembly/x86-x64/readme-zh/" title="x86_x64" class="md-nav__link">
      x86_x64
    </a>
  </li>







  <li class="md-nav__item">
    <a href="../../../../assembly/mips/readme-zh/" title="mips" class="md-nav__link">
      mips
    </a>
  </li>







  <li class="md-nav__item">
    <a href="../../../../assembly/arm/readme-zh/" title="arm" class="md-nav__link">
      arm
    </a>
  </li>


      </ul>
    </nav>
  </li>







  <li class="md-nav__item md-nav__item--nested">

      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-6" type="checkbox" id="nav-6">

    <label class="md-nav__link" for="nav-6">
      Executable
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-6">
        Executable
      </label>
      <ul class="md-nav__list" data-md-scrollfix>







  <li class="md-nav__item md-nav__item--nested">

      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-6-1" type="checkbox" id="nav-6-1">

    <label class="md-nav__link" for="nav-6-1">
      ELF file
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-6-1">
        ELF file
      </label>
      <ul class="md-nav__list" data-md-scrollfix>







  <li class="md-nav__item">
    <a href="../../../../executable/elf/elf-structure-zh/" title="ELF File Basic Structure" class="md-nav__link">
      ELF File Basic Structure
    </a>
  </li>







  <li class="md-nav__item">
    <a href="../../../../executable/elf/program-loading-zh/" title="Program Loading" class="md-nav__link">
      Program Loading
    </a>
  </li>







  <li class="md-nav__item">
    <a href="../../../../executable/elf/program-linking-zh/" title="Program Link" class="md-nav__link">
      Program Link
    </a>
  </li>







  <li class="md-nav__item">
    <a href="../../../../executable/elf/running-overview-zh/" title="Program Execution Flow" class="md-nav__link">
      Program Execution Flow
    </a>
  </li>


      </ul>
    </nav>
  </li>







  <li class="md-nav__item md-nav__item--nested">

      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-6-2" type="checkbox" id="nav-6-2">

    <label class="md-nav__link" for="nav-6-2">
      PE file
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-6-2">
        PE file
      </label>
      <ul class="md-nav__list" data-md-scrollfix>







  <li class="md-nav__item">
    <a href="../../../../executable/pe/pe-excutable-zh/" title="PE File Basic Structure" class="md-nav__link">
      PE File Basic Structure
    </a>
  </li>







  <li class="md-nav__item">
    <a href="../../../../executable/pe/pe-import-table-zh/" title="PE Import Table" class="md-nav__link">
      PE Import Table
    </a>
  </li>







  <li class="md-nav__item">
    <a href="../../../../executable/pe/pe-export-table-zh/" title="PE Export Table" class="md-nav__link">
      PE Export Table
    </a>
  </li>







  <li class="md-nav__item">
    <a href="../../../../executable/pe/pe-relocation-table-zh/" title="PE Relocation Table" class="md-nav__link">
      PE Relocation Table
    </a>
  </li>


      </ul>
    </nav>
  </li>


      </ul>
    </nav>
  </li>







  <li class="md-nav__item md-nav__item--nested">

      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-7" type="checkbox" id="nav-7">

    <label class="md-nav__link" for="nav-7">
      Reverse Engineering
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-7">
        Reverse Engineering
      </label>
      <ul class="md-nav__list" data-md-scrollfix>







  <li class="md-nav__item md-nav__item--nested">

      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-7-1" type="checkbox" id="nav-7-1">

    <label class="md-nav__link" for="nav-7-1">
      Reverse Overview
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-7-1">
        Reverse Overview
      </label>
      <ul class="md-nav__list" data-md-scrollfix>







  <li class="md-nav__item">
    <a href="../../../../reverse/introduction-zh/" title="Software Reverse Engineering Introduction" class="md-nav__link">
      Software Reverse Engineering Introduction
    </a>
  </li>







  <li class="md-nav__item">
    <a href="../../../../reverse/Identify-Encode-Encryption/introduction-zh/" title="Common Encryption Algorithms and Code Recognition" class="md-nav__link">
      Common Encryption Algorithms and Code Recognition
    </a>
  </li>







  <li class="md-nav__item">
    <a href="../../../../reverse/maze/maze-zh/" title="Labyrinth Problem" class="md-nav__link">
      Labyrinth Problem
    </a>
  </li>







  <li class="md-nav__item">
    <a href="../../../../reverse/vm/vm-zh/" title="Virtual Machine Command Analysis" class="md-nav__link">
      Virtual Machine Command Analysis
    </a>
  </li>







  <li class="md-nav__item">
    <a href="../../../../reverse/unicorn/introduction-zh/" title="Unicorn Engine Introduction" class="md-nav__link">
      Unicorn Engine Introduction
    </a>
  </li>


      </ul>
    </nav>
  </li>







  <li class="md-nav__item md-nav__item--nested">

      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-7-2" type="checkbox" id="nav-7-2">

    <label class="md-nav__link" for="nav-7-2">
      Linux Reverse
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-7-2">
        Linux Reverse
      </label>
      <ul class="md-nav__list" data-md-scrollfix>







  <li class="md-nav__item md-nav__item--nested">

      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-7-2-1" type="checkbox" id="nav-7-2-1">

    <label class="md-nav__link" for="nav-7-2-1">
      Linux Reverse Technology
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="3">
      <label class="md-nav__title" for="nav-7-2-1">
        Linux Reverse Technology
      </label>
      <ul class="md-nav__list" data-md-scrollfix>







  <li class="md-nav__item">
    <a href="../../../../reverse/linux/ld_preload-zh/" title="LD_PRELOAD" class="md-nav__link">
      LD_PRELOAD
    </a>
  </li>







  <li class="md-nav__item">
    <a href="../../../../reverse/linux/false-disasm-zh/" title="Incorrect Disassembly Fix" class="md-nav__link">
      Incorrect Disassembly Fix
    </a>
  </li>







  <li class="md-nav__item">
    <a href="../../../../reverse/linux/detect-bp-zh/" title="Detecting Breakpoints Bypassing" class="md-nav__link">
      Detecting Breakpoints Bypassing
    </a>
  </li>







  <li class="md-nav__item">
    <a href="../../../../reverse/linux/detect-dbg-zh/" title="Detecting Debugging Bypassing" class="md-nav__link">
      Detecting Debugging Bypassing
    </a>
  </li>


      </ul>
    </nav>
  </li>


      </ul>
    </nav>
  </li>







  <li class="md-nav__item md-nav__item--nested">

      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-7-3" type="checkbox" id="nav-7-3">

    <label class="md-nav__link" for="nav-7-3">
      Windows Reverse
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-7-3">
        Windows Reverse
      </label>
      <ul class="md-nav__list" data-md-scrollfix>







  <li class="md-nav__item md-nav__item--nested">

      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-7-3-1" type="checkbox" id="nav-7-3-1">

    <label class="md-nav__link" for="nav-7-3-1">
      Shelling Technology
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="3">
      <label class="md-nav__title" for="nav-7-3-1">
        Shelling Technology
      </label>
      <ul class="md-nav__list" data-md-scrollfix>







  <li class="md-nav__item">
    <a href="../../../../reverse/windows/unpack/packer-introduction-zh/" title="Introduction to the Protective case" class="md-nav__link">
      Introduction to the Protective case
    </a>
  </li>







  <li class="md-nav__item">
    <a href="../../../../reverse/windows/unpack/trace-zh/" title="Single Step Tracking Method" class="md-nav__link">
      Single Step Tracking Method
    </a>
  </li>







  <li class="md-nav__item">
    <a href="../../../../reverse/windows/unpack/esp-zh/" title="ESP Law" class="md-nav__link">
      ESP Law
    </a>
  </li>







  <li class="md-nav__item">
    <a href="../../../../reverse/windows/unpack/direct-oep-zh/" title="One Step to the OEP Method" class="md-nav__link">
      One Step to the OEP Method
    </a>
  </li>







  <li class="md-nav__item">
    <a href="../../../../reverse/windows/unpack/memory-zh/" title="Memory Mirroring Method" class="md-nav__link">
      Memory Mirroring Method
    </a>
  </li>







  <li class="md-nav__item">
    <a href="../../../../reverse/windows/unpack/last-exception-zh/" title="Last Exception Method" class="md-nav__link">
      Last Exception Method
    </a>
  </li>







  <li class="md-nav__item">
    <a href="../../../../reverse/windows/unpack/sfx-zh/" title="SFX Method" class="md-nav__link">
      SFX Method
    </a>
  </li>







  <li class="md-nav__item">
    <a href="../../../../reverse/windows/unpack/fix-iat-zh/" title="DUMP and IAT Reconstruction" class="md-nav__link">
      DUMP and IAT Reconstruction
    </a>
  </li>







  <li class="md-nav__item">
    <a href="../../../../reverse/windows/unpack/manually-fix-iat-zh/" title="Manually Find the IAT and Rebuild It Using ImportREC" class="md-nav__link">
      Manually Find the IAT and Rebuild It Using ImportREC
    </a>
  </li>







  <li class="md-nav__item">
    <a href="../../../../reverse/windows/unpack/unpack-dll-zh/" title="DLL File Unpacking" class="md-nav__link">
      DLL File Unpacking
    </a>
  </li>


      </ul>
    </nav>
  </li>







  <li class="md-nav__item md-nav__item--nested">

      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-7-3-2" type="checkbox" id="nav-7-3-2">

    <label class="md-nav__link" for="nav-7-3-2">
      Anti-debugging Technology
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="3">
      <label class="md-nav__title" for="nav-7-3-2">
        Anti-debugging Technology
      </label>
      <ul class="md-nav__list" data-md-scrollfix>







  <li class="md-nav__item">
    <a href="../../../../reverse/windows/anti-debug/ntglobalflag-zh/" title="NtGlobalFlag" class="md-nav__link">
      NtGlobalFlag
    </a>
  </li>







  <li class="md-nav__item">
    <a href="../../../../reverse/windows/anti-debug/heap-flags-zh/" title="Heap Flags" class="md-nav__link">
      Heap Flags
    </a>
  </li>







  <li class="md-nav__item">
    <a href="../../../../reverse/windows/anti-debug/the-heap-zh/" title="The Heap" class="md-nav__link">
      The Heap
    </a>
  </li>







  <li class="md-nav__item">
    <a href="../../../../reverse/windows/anti-debug/int-3-zh/" title="Interrupt 3" class="md-nav__link">
      Interrupt 3
    </a>
  </li>







  <li class="md-nav__item">
    <a href="../../../../reverse/windows/anti-debug/isdebuggerpresent-zh/" title="IsDebuggerPresent" class="md-nav__link">
      IsDebuggerPresent
    </a>
  </li>







  <li class="md-nav__item">
    <a href="../../../../reverse/windows/anti-debug/checkremotedebuggerpresent-zh/" title="CheckRemoteDebuggerPresent" class="md-nav__link">
      CheckRemoteDebuggerPresent
    </a>
  </li>







  <li class="md-nav__item">
    <a href="../../../../reverse/windows/anti-debug/ntqueryinformationprocess-zh/" title="NtQueryInformationProcess" class="md-nav__link">
      NtQueryInformationProcess
    </a>
  </li>







  <li class="md-nav__item">
    <a href="../../../../reverse/windows/anti-debug/junk-code-zh/" title="Flower command" class="md-nav__link">
      Flower command
    </a>
  </li>







  <li class="md-nav__item">
    <a href="../../../../reverse/windows/anti-debug/example-zh/" title="Anti-debug technical example" class="md-nav__link">
      Anti-debug technical example
    </a>
  </li>


      </ul>
    </nav>
  </li>


      </ul>
    </nav>
  </li>


      </ul>
    </nav>
  </li>







  <li class="md-nav__item md-nav__item--nested">

      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-8" type="checkbox" id="nav-8">

    <label class="md-nav__link" for="nav-8">
      Pwn
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-8">
        Pwn
      </label>
      <ul class="md-nav__list" data-md-scrollfix>







  <li class="md-nav__item md-nav__item--nested">

      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-8-1" type="checkbox" id="nav-8-1">

    <label class="md-nav__link" for="nav-8-1">
      Pwn Overview
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-8-1">
        Pwn Overview
      </label>
      <ul class="md-nav__list" data-md-scrollfix>







  <li class="md-nav__item">
    <a href="../../../readme-zh/" title="Readme zh" class="md-nav__link">
      Readme zh
    </a>
  </li>


      </ul>
    </nav>
  </li>







  <li class="md-nav__item md-nav__item--nested">

      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-8-2" type="checkbox" id="nav-8-2">

    <label class="md-nav__link" for="nav-8-2">
      Linux Pwn
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-8-2">
        Linux Pwn
      </label>
      <ul class="md-nav__list" data-md-scrollfix>







  <li class="md-nav__item md-nav__item--nested">

      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-8-2-1" type="checkbox" id="nav-8-2-1">

    <label class="md-nav__link" for="nav-8-2-1">
      Security Protection Mechanism
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="3">
      <label class="md-nav__title" for="nav-8-2-1">
        Security Protection Mechanism
      </label>
      <ul class="md-nav__list" data-md-scrollfix>







  <li class="md-nav__item">
    <a href="../../mitigation/canary-zh/" title="Canary" class="md-nav__link">
      Canary
    </a>
  </li>


      </ul>
    </nav>
  </li>







  <li class="md-nav__item md-nav__item--nested">

      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-8-2-2" type="checkbox" id="nav-8-2-2">

    <label class="md-nav__link" for="nav-8-2-2">
      Stack Overflow
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="3">
      <label class="md-nav__title" for="nav-8-2-2">
        Stack Overflow
      </label>
      <ul class="md-nav__list" data-md-scrollfix>







  <li class="md-nav__item">
    <a href="../../stackoverflow/stack-intro-zh/" title="Stack Introduction" class="md-nav__link">
      Stack Introduction
    </a>
  </li>







  <li class="md-nav__item">
    <a href="../../stackoverflow/stackoverflow-basic-zh/" title="Stack Overflow Principle" class="md-nav__link">
      Stack Overflow Principle
    </a>
  </li>







  <li class="md-nav__item">
    <a href="../../stackoverflow/basic-rop-zh/" title="Basic ROP" class="md-nav__link">
      Basic ROP
    </a>
  </li>







  <li class="md-nav__item">
    <a href="../../stackoverflow/medium-rop-zh/" title="Intermediate ROP" class="md-nav__link">
      Intermediate ROP
    </a>
  </li>







  <li class="md-nav__item">
    <a href="../../stackoverflow/advanced-rop-zh/" title="Advanced ROP" class="md-nav__link">
      Advanced ROP
    </a>
  </li>







  <li class="md-nav__item">
    <a href="../../stackoverflow/fancy-rop-zh/" title="ROP Tricks" class="md-nav__link">
      ROP Tricks
    </a>
  </li>


      </ul>
    </nav>
  </li>







  <li class="md-nav__item md-nav__item--nested">

      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-8-2-3" type="checkbox" id="nav-8-2-3">

    <label class="md-nav__link" for="nav-8-2-3">
      Format String Vulnerability
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="3">
      <label class="md-nav__title" for="nav-8-2-3">
        Format String Vulnerability
      </label>
      <ul class="md-nav__list" data-md-scrollfix>







  <li class="md-nav__item">
    <a href="../../fmtstr/fmtstr_intro-zh/" title="Format String Vulnerability Principle" class="md-nav__link">
      Format String Vulnerability Principle
    </a>
  </li>







  <li class="md-nav__item">
    <a href="../../fmtstr/fmtstr_exploit-zh/" title="Format String Exploit" class="md-nav__link">
      Format String Exploit
    </a>
  </li>







  <li class="md-nav__item">
    <a href="../../fmtstr/fmtstr_example-zh/" title="Format String Vulnerability Example" class="md-nav__link">
      Format String Vulnerability Example
    </a>
  </li>







  <li class="md-nav__item">
    <a href="../../fmtstr/fmtstr_detect-zh/" title="Format String Vulnerability Detection" class="md-nav__link">
      Format String Vulnerability Detection
    </a>
  </li>


      </ul>
    </nav>
  </li>







  <li class="md-nav__item md-nav__item--nested">

      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-8-2-4" type="checkbox" id="nav-8-2-4">

    <label class="md-nav__link" for="nav-8-2-4">
      Glibc Heap Related
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="3">
      <label class="md-nav__title" for="nav-8-2-4">
        Glibc Heap Related
      </label>
      <ul class="md-nav__list" data-md-scrollfix>







  <li class="md-nav__item">
    <a href="../introduction-zh/" title="Introduction to Heap" class="md-nav__link">
      Introduction to Heap
    </a>
  </li>







  <li class="md-nav__item">
    <a href="../heap_overview-zh/" title="Heap Overview" class="md-nav__link">
      Heap Overview
    </a>
  </li>







  <li class="md-nav__item">
    <a href="../heap_structure-zh/" title="Heap Related Data Structure" class="md-nav__link">
      Heap Related Data Structure
    </a>
  </li>







  <li class="md-nav__item md-nav__item--nested">

      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-8-2-4-4" type="checkbox" id="nav-8-2-4-4">

    <label class="md-nav__link" for="nav-8-2-4-4">
      In-depth Understanding of Ptmalloc2
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="4">
      <label class="md-nav__title" for="nav-8-2-4-4">
        In-depth Understanding of Ptmalloc2
      </label>
      <ul class="md-nav__list" data-md-scrollfix>







  <li class="md-nav__item">
    <a href="../implementation/overview-zh/" title="Implementation" class="md-nav__link">
      Implementation
    </a>
  </li>







  <li class="md-nav__item">
    <a href="../implementation/basic-zh/" title="Basic Functions in the heap implementation" class="md-nav__link">
      Basic Functions in the heap implementation
    </a>
  </li>







  <li class="md-nav__item">
    <a href="../implementation/heap-init-zh/" title="Heap Initialization" class="md-nav__link">
      Heap Initialization
    </a>
  </li>







  <li class="md-nav__item">
    <a href="../implementation/malloc-zh/" title="Allocate Heap Memory" class="md-nav__link">
      Allocate Heap Memory
    </a>
  </li>







  <li class="md-nav__item">
    <a href="../implementation/free-zh/" title="Free Heap Memory" class="md-nav__link">
      Free Heap Memory
    </a>
  </li>







  <li class="md-nav__item">
    <a href="../implementation/tcache-zh/" title="Tcache" class="md-nav__link">
      Tcache
    </a>
  </li>







  <li class="md-nav__item">
    <a href="../implementation/malloc_state-zh/" title="malloc_state" class="md-nav__link">
      malloc_state
    </a>
  </li>







  <li class="md-nav__item">
    <a href="../implementation/misc-zh/" title="Other" class="md-nav__link">
      Other
    </a>
  </li>


      </ul>
    </nav>
  </li>







  <li class="md-nav__item">
    <a href="../heapoverflow_basic-zh/" title="Heap Overflow" class="md-nav__link">
      Heap Overflow
    </a>
  </li>







  <li class="md-nav__item">
    <a href="../off_by_one-zh/" title="Heap-based Off-By-One" class="md-nav__link">
      Heap-based Off-By-One
    </a>
  </li>







  <li class="md-nav__item">
    <a href="../chunk_extend_overlapping-zh/" title="Chunk Extend/Overlapping" class="md-nav__link">
      Chunk Extend/Overlapping
    </a>
  </li>







  <li class="md-nav__item">
    <a href="../unlink-zh/" title="Unlink" class="md-nav__link">
      Unlink
    </a>
  </li>







  <li class="md-nav__item">
    <a href="../use_after_free-zh/" title="Use After Free" class="md-nav__link">
      Use After Free
    </a>
  </li>







  <li class="md-nav__item">
    <a href="../fastbin_attack-zh/" title="Fastbin Attack" class="md-nav__link">
      Fastbin Attack
    </a>
  </li>







  <li class="md-nav__item">
    <a href="../unsorted_bin_attack-zh/" title="Unsorted Bin Attack" class="md-nav__link">
      Unsorted Bin Attack
    </a>
  </li>







  <li class="md-nav__item">
    <a href="../large_bin_attack-zh/" title="Large Bin Attack" class="md-nav__link">
      Large Bin Attack
    </a>
  </li>







  <li class="md-nav__item">
    <a href="../tcache_attack-zh/" title="Tcache Attack" class="md-nav__link">
      Tcache Attack
    </a>
  </li>







  <li class="md-nav__item">
    <a href="../house_of_einherjar-zh/" title="House of Einherjar" class="md-nav__link">
      House of Einherjar
    </a>
  </li>







  <li class="md-nav__item">
    <a href="../house_of_force-zh/" title="House of Force" class="md-nav__link">
      House of Force
    </a>
  </li>







  <li class="md-nav__item">
    <a href="../house_of_lore-zh/" title="House of Lore" class="md-nav__link">
      House of Lore
    </a>
  </li>







  <li class="md-nav__item">
    <a href="../house_of_orange-zh/" title="House of Orange" class="md-nav__link">
      House of Orange
    </a>
  </li>







  <li class="md-nav__item">
    <a href="../house_of_rabbit-zh/" title="House of Rabbit" class="md-nav__link">
      House of Rabbit
    </a>
  </li>







  <li class="md-nav__item">
    <a href="../house_of_roman-zh/" title="House of Roman" class="md-nav__link">
      House of Roman
    </a>
  </li>


      </ul>
    </nav>
  </li>







  <li class="md-nav__item md-nav__item--nested">

      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-8-2-5" type="checkbox" id="nav-8-2-5">

    <label class="md-nav__link" for="nav-8-2-5">
      IO_FILE Related
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="3">
      <label class="md-nav__title" for="nav-8-2-5">
        IO_FILE Related
      </label>
      <ul class="md-nav__list" data-md-scrollfix>







  <li class="md-nav__item">
    <a href="../../io_file/introduction-zh/" title="FILE Structure Description" class="md-nav__link">
      FILE Structure Description
    </a>
  </li>







  <li class="md-nav__item">
    <a href="../../io_file/fake-vtable-exploit-zh/" title="Forged Vtable to Hijack Control Flow" class="md-nav__link">
      Forged Vtable to Hijack Control Flow
    </a>
  </li>







  <li class="md-nav__item">
    <a href="../../io_file/fsop-zh/" title="FSOP" class="md-nav__link">
      FSOP
    </a>
  </li>







  <li class="md-nav__item">
    <a href="../../io_file/exploit-in-libc2.24-zh/" title="Use of IO_FILE Under Glibc 2.24" class="md-nav__link">
      Use of IO_FILE Under Glibc 2.24
    </a>
  </li>


      </ul>
    </nav>
  </li>







  <li class="md-nav__item md-nav__item--nested">

      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-8-2-6" type="checkbox" id="nav-8-2-6">

    <label class="md-nav__link" for="nav-8-2-6">
      Race Condition
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="3">
      <label class="md-nav__title" for="nav-8-2-6">
        Race Condition
      </label>
      <ul class="md-nav__list" data-md-scrollfix>







  <li class="md-nav__item">
    <a href="../../race-condition/introduction-zh/" title="Race Condition Introduction" class="md-nav__link">
      Race Condition Introduction
    </a>
  </li>







  <li class="md-nav__item">
    <a href="../../race-condition/problem-zh/" title="Example" class="md-nav__link">
      Example
    </a>
  </li>


      </ul>
    </nav>
  </li>







  <li class="md-nav__item md-nav__item--nested">

      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-8-2-7" type="checkbox" id="nav-8-2-7">

    <label class="md-nav__link" for="nav-8-2-7">
      Integer Overflow
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="3">
      <label class="md-nav__title" for="nav-8-2-7">
        Integer Overflow
      </label>
      <ul class="md-nav__list" data-md-scrollfix>







  <li class="md-nav__item">
    <a href="../../integeroverflow/intof-zh/" title="Introduction to The Principle of Integer Overflow" class="md-nav__link">
      Introduction to The Principle of Integer Overflow
    </a>
  </li>


      </ul>
    </nav>
  </li>







  <li class="md-nav__item md-nav__item--nested">

      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-8-2-8" type="checkbox" id="nav-8-2-8">

    <label class="md-nav__link" for="nav-8-2-8">
      Sandbox Escape
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="3">
      <label class="md-nav__title" for="nav-8-2-8">
        Sandbox Escape
      </label>
      <ul class="md-nav__list" data-md-scrollfix>







  <li class="md-nav__item">
    <a href="../../sandbox/python-sandbox-escape-zh/" title="Python Sandbox Escape" class="md-nav__link">
      Python Sandbox Escape
    </a>
  </li>


      </ul>
    </nav>
  </li>







  <li class="md-nav__item md-nav__item--nested">

      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-8-2-9" type="checkbox" id="nav-8-2-9">

    <label class="md-nav__link" for="nav-8-2-9">
      Linux Kernel
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="3">
      <label class="md-nav__title" for="nav-8-2-9">
        Linux Kernel
      </label>
      <ul class="md-nav__list" data-md-scrollfix>







  <li class="md-nav__item">
    <a href="../../kernel/environment-zh/" title="Environment Setup" class="md-nav__link">
      Environment Setup
    </a>
  </li>







  <li class="md-nav__item">
    <a href="../../kernel/basic_knowledge-zh/" title="Basics" class="md-nav__link">
      Basics
    </a>
  </li>







  <li class="md-nav__item">
    <a href="../../kernel/kernel_uaf-zh/" title="Kernel-UAF" class="md-nav__link">
      Kernel-UAF
    </a>
  </li>







  <li class="md-nav__item">
    <a href="../../kernel/kernel_rop-zh/" title="Kernel-ROP" class="md-nav__link">
      Kernel-ROP
    </a>
  </li>







  <li class="md-nav__item">
    <a href="../../kernel/ret2usr-zh/" title="ret2usr" class="md-nav__link">
      ret2usr
    </a>
  </li>







  <li class="md-nav__item">
    <a href="../../kernel/bypass_smep-zh/" title="bypass-smep" class="md-nav__link">
      bypass-smep
    </a>
  </li>







  <li class="md-nav__item">
    <a href="../../kernel/double-fetch-zh/" title="Double Fetch" class="md-nav__link">
      Double Fetch
    </a>
  </li>


      </ul>
    </nav>
  </li>







  <li class="md-nav__item md-nav__item--nested">

      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-8-2-10" type="checkbox" id="nav-8-2-10">

    <label class="md-nav__link" for="nav-8-2-10">
      arm-pwn
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="3">
      <label class="md-nav__title" for="nav-8-2-10">
        arm-pwn
      </label>
      <ul class="md-nav__list" data-md-scrollfix>







  <li class="md-nav__item">
    <a href="../../arm/environment-zh/" title="Environment Setup" class="md-nav__link">
      Environment Setup
    </a>
  </li>







  <li class="md-nav__item">
    <a href="../../arm/arm_rop-zh/" title="arm-rop" class="md-nav__link">
      arm-rop
    </a>
  </li>


      </ul>
    </nav>
  </li>







  <li class="md-nav__item md-nav__item--nested">

      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-8-2-11" type="checkbox" id="nav-8-2-11">

    <label class="md-nav__link" for="nav-8-2-11">
      Summary
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="3">
      <label class="md-nav__title" for="nav-8-2-11">
        Summary
      </label>
      <ul class="md-nav__list" data-md-scrollfix>







  <li class="md-nav__item">
    <a href="../../summary/get-address-zh/" title="Address Leaking" class="md-nav__link">
      Address Leaking
    </a>
  </li>







  <li class="md-nav__item">
    <a href="../../summary/hijack-control-flow-zh/" title="Hijack Control Flow" class="md-nav__link">
      Hijack Control Flow
    </a>
  </li>







  <li class="md-nav__item">
    <a href="../../summary/get-shell-zh/" title="Get Shell" class="md-nav__link">
      Get Shell
    </a>
  </li>


      </ul>
    </nav>
  </li>


      </ul>
    </nav>
  </li>







  <li class="md-nav__item md-nav__item--nested">

      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-8-3" type="checkbox" id="nav-8-3">

    <label class="md-nav__link" for="nav-8-3">
      Windows Pwn
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-8-3">
        Windows Pwn
      </label>
      <ul class="md-nav__list" data-md-scrollfix>







  <li class="md-nav__item">
    <a href="../../../windows/readme-zh/" title="Overview" class="md-nav__link">
      Overview
    </a>
  </li>







  <li class="md-nav__item md-nav__item--nested">

      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-8-3-2" type="checkbox" id="nav-8-3-2">

    <label class="md-nav__link" for="nav-8-3-2">
      Stack Overflow
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="3">
      <label class="md-nav__title" for="nav-8-3-2">
        Stack Overflow
      </label>
      <ul class="md-nav__list" data-md-scrollfix>







  <li class="md-nav__item">
    <a href="../../../windows/stackoverflow/stack-introduce-zh/" title="Stack Introduction" class="md-nav__link">
      Stack Introduction
    </a>
  </li>







  <li class="md-nav__item">
    <a href="../../../windows/stackoverflow/stackoverflow-basic-zh/" title="Stack Overflow Principle" class="md-nav__link">
      Stack Overflow Principle
    </a>
  </li>







  <li class="md-nav__item">
    <a href="../../../windows/stackoverflow/shellcode-in-stack-zh/" title="shellcode-in-stack" class="md-nav__link">
      shellcode-in-stack
    </a>
  </li>


      </ul>
    </nav>
  </li>


      </ul>
    </nav>
  </li>


      </ul>
    </nav>
  </li>







  <li class="md-nav__item md-nav__item--nested">

      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-9" type="checkbox" id="nav-9">

    <label class="md-nav__link" for="nav-9">
      Android
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-9">
        Android
      </label>
      <ul class="md-nav__list" data-md-scrollfix>







  <li class="md-nav__item">
    <a href="../../../../android/basic_develop/basic_develop-zh/" title="Android Development Basics" class="md-nav__link">
      Android Development Basics
    </a>
  </li>







  <li class="md-nav__item md-nav__item--nested">

      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-9-2" type="checkbox" id="nav-9-2">

    <label class="md-nav__link" for="nav-9-2">
      Android Application Operating Mechanism Brief
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-9-2">
        Android Application Operating Mechanism Brief
      </label>
      <ul class="md-nav__list" data-md-scrollfix>







  <li class="md-nav__item">
    <a href="../../../../android/basic_operating_mechanism/readme-zh/" title="Basics" class="md-nav__link">
      Basics
    </a>
  </li>







  <li class="md-nav__item md-nav__item--nested">

      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-9-2-2" type="checkbox" id="nav-9-2-2">

    <label class="md-nav__link" for="nav-9-2-2">
      The Operating Mechanism of the Java Layer in Android
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="3">
      <label class="md-nav__title" for="nav-9-2-2">
        The Operating Mechanism of the Java Layer in Android
      </label>
      <ul class="md-nav__list" data-md-scrollfix>







  <li class="md-nav__item">
    <a href="../../../../android/basic_operating_mechanism/java_layer/readme-zh/" title="Andriod Native" class="md-nav__link">
      Andriod Native
    </a>
  </li>







  <li class="md-nav__item">
    <a href="../../../../android/basic_operating_mechanism/java_layer/smali/smali-zh/" title="Smali Introduction" class="md-nav__link">
      Smali Introduction
    </a>
  </li>







  <li class="md-nav__item md-nav__item--nested">

      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-9-2-2-3" type="checkbox" id="nav-9-2-2-3">

    <label class="md-nav__link" for="nav-9-2-2-3">
      Dex and ODEX
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="4">
      <label class="md-nav__title" for="nav-9-2-2-3">
        Dex and ODEX
      </label>
      <ul class="md-nav__list" data-md-scrollfix>







  <li class="md-nav__item">
    <a href="../../../../android/basic_operating_mechanism/java_layer/dex/dex-zh/" title="DEX" class="md-nav__link">
      DEX
    </a>
  </li>







  <li class="md-nav__item">
    <a href="../../../../android/basic_operating_mechanism/java_layer/dex/odex-zh/" title="ODEX" class="md-nav__link">
      ODEX
    </a>
  </li>


      </ul>
    </nav>
  </li>


      </ul>
    </nav>
  </li>







  <li class="md-nav__item md-nav__item--nested">

      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-9-2-3" type="checkbox" id="nav-9-2-3">

    <label class="md-nav__link" for="nav-9-2-3">
      Android Native Layer Introduction
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="3">
      <label class="md-nav__title" for="nav-9-2-3">
        Android Native Layer Introduction
      </label>
      <ul class="md-nav__list" data-md-scrollfix>







  <li class="md-nav__item">
    <a href="../../../../android/basic_operating_mechanism/native_layer/so-zh/" title="Android SO" class="md-nav__link">
      Android SO
    </a>
  </li>


      </ul>
    </nav>
  </li>







  <li class="md-nav__item md-nav__item--nested">

      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-9-2-4" type="checkbox" id="nav-9-2-4">

    <label class="md-nav__link" for="nav-9-2-4">
      Android Reverse Basic Introduction
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="3">
      <label class="md-nav__title" for="nav-9-2-4">
        Android Reverse Basic Introduction
      </label>
      <ul class="md-nav__list" data-md-scrollfix>







  <li class="md-nav__item">
    <a href="../../../../android/basic_reverse/overview-zh/" title="Brief Description" class="md-nav__link">
      Brief Description
    </a>
  </li>







  <li class="md-nav__item">
    <a href="../../../../android/basic_reverse/android_code_location-zh/" title="Android Key Part Location" class="md-nav__link">
      Android Key Part Location
    </a>
  </li>







  <li class="md-nav__item md-nav__item--nested">

      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-9-2-4-3" type="checkbox" id="nav-9-2-4-3">

    <label class="md-nav__link" for="nav-9-2-4-3">
      Android Simple Static Analysis
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="4">
      <label class="md-nav__title" for="nav-9-2-4-3">
        Android Simple Static Analysis
      </label>
      <ul class="md-nav__list" data-md-scrollfix>







  <li class="md-nav__item">
    <a href="../../../../android/basic_reverse/static/java-example-zh/" title="Android Java Layer Static Analysis" class="md-nav__link">
      Android Java Layer Static Analysis
    </a>
  </li>







  <li class="md-nav__item">
    <a href="../../../../android/basic_reverse/static/so-example-zh/" title="Android Native Layer Static Analysis" class="md-nav__link">
      Android Native Layer Static Analysis
    </a>
  </li>







  <li class="md-nav__item">
    <a href="../../../../android/basic_reverse/static/complex-example-zh/" title="Android Static Analysis Hybrid Example" class="md-nav__link">
      Android Static Analysis Hybrid Example
    </a>
  </li>


      </ul>
    </nav>
  </li>







  <li class="md-nav__item md-nav__item--nested">

      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-9-2-4-4" type="checkbox" id="nav-9-2-4-4">

    <label class="md-nav__link" for="nav-9-2-4-4">
      Android Simple Dynamic Analysis
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="4">
      <label class="md-nav__title" for="nav-9-2-4-4">
        Android Simple Dynamic Analysis
      </label>
      <ul class="md-nav__list" data-md-scrollfix>







  <li class="md-nav__item">
    <a href="../../../../android/basic_reverse/dynamic/dynamic_debug-zh/" title="Dynamic Debugging" class="md-nav__link">
      Dynamic Debugging
    </a>
  </li>







  <li class="md-nav__item">
    <a href="../../../../android/basic_reverse/dynamic/ida_native_debug-zh/" title="Android Dynamic Debugging SO" class="md-nav__link">
      Android Dynamic Debugging SO
    </a>
  </li>


      </ul>
    </nav>
  </li>


      </ul>
    </nav>
  </li>


      </ul>
    </nav>
  </li>


      </ul>
    </nav>
  </li>







  <li class="md-nav__item md-nav__item--nested">

      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-10" type="checkbox" id="nav-10">

    <label class="md-nav__link" for="nav-10">
      ICS
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-10">
        ICS
      </label>
      <ul class="md-nav__list" data-md-scrollfix>







  <li class="md-nav__item">
    <a href="../../../../ics/ctfs-zh/" title="ICS_CTF Contest" class="md-nav__link">
      ICS_CTF Contest
    </a>
  </li>







  <li class="md-nav__item">
    <a href="../../../../ics/discover-zh/" title="ICS_CTF found" class="md-nav__link">
      ICS_CTF found
    </a>
  </li>







  <li class="md-nav__item">
    <a href="../../../../ics/exploit-zh/" title="ICS_CTF uses" class="md-nav__link">
      ICS_CTF uses
    </a>
  </li>







  <li class="md-nav__item">
    <a href="../../../../ics/learn-zh/" title="ICS_CTF Learning Resources" class="md-nav__link">
      ICS_CTF Learning Resources
    </a>
  </li>


      </ul>
    </nav>
  </li>


  </ul>
</nav>
                  </div>
                </div>
              </div>


              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">

<nav class="md-nav md-nav--secondary">





    <label class="md-nav__title" for="__toc">目录</label>
    <ul class="md-nav__list" data-md-scrollfix>

        <li class="md-nav__item">
  <a href="#overview" class="md-nav__link">
    Overview？？？？
  </a>

</li>

        <li class="md-nav__item">
  <a href="#micro-structure" class="md-nav__link">
    micro structure
  </a>

    <nav class="md-nav">
      <ul class="md-nav__list">

          <li class="md-nav__item">
  <a href="#malloc_chunk" class="md-nav__link">
    malloc_chunk
  </a>

    <nav class="md-nav">
      <ul class="md-nav__list">

          <li class="md-nav__item">
  <a href="#overview_1" class="md-nav__link">
    Overview
  </a>

</li>

          <li class="md-nav__item">
  <a href="#chunk-related-macro" class="md-nav__link">
    chunk related macro
  </a>

</li>

      </ul>
    </nav>

</li>

          <li class="md-nav__item">
  <a href="#am" class="md-nav__link">
    am
  </a>

    <nav class="md-nav">
      <ul class="md-nav__list">

          <li class="md-nav__item">
  <a href="#overview_2" class="md-nav__link">
    Overview
  </a>

</li>

          <li class="md-nav__item">
  <a href="#fast-bin" class="md-nav__link">
    Fast Bin
  </a>

</li>

          <li class="md-nav__item">
  <a href="#small-bin" class="md-nav__link">
    Small Bin
  </a>

</li>

          <li class="md-nav__item">
  <a href="#large-bin" class="md-nav__link">
    Large Bin
  </a>

</li>

          <li class="md-nav__item">
  <a href="#unsorted-bin" class="md-nav__link">
    Unsorted Bin
  </a>

</li>

          <li class="md-nav__item">
  <a href="#common-macro" class="md-nav__link">
    common macro
  </a>

</li>

      </ul>
    </nav>

</li>

          <li class="md-nav__item">
  <a href="#top-chunk" class="md-nav__link">
    Top Chunk
  </a>

</li>

          <li class="md-nav__item">
  <a href="#last-remainder" class="md-nav__link">
    last remainder
  </a>

</li>

      </ul>
    </nav>

</li>

        <li class="md-nav__item">
  <a href="#macrostructure" class="md-nav__link">
    Macrostructure
  </a>

    <nav class="md-nav">
      <ul class="md-nav__list">

          <li class="md-nav__item">
  <a href="#arena" class="md-nav__link">
    arena
  </a>

    <nav class="md-nav">
      <ul class="md-nav__list">

          <li class="md-nav__item">
  <a href="#arena-quantity" class="md-nav__link">
    arena Quantity
  </a>

</li>

          <li class="md-nav__item">
  <a href="#arena-distribution-rules" class="md-nav__link">
    arena Distribution Rules
  </a>

</li>

          <li class="md-nav__item">
  <a href="#the-difference" class="md-nav__link">
    the difference
  </a>

</li>

      </ul>
    </nav>

</li>

          <li class="md-nav__item">
  <a href="#heap_info" class="md-nav__link">
    heap_info
  </a>

</li>

          <li class="md-nav__item">
  <a href="#malloc_state" class="md-nav__link">
    malloc_state
  </a>

</li>

          <li class="md-nav__item">
  <a href="#malloc_par" class="md-nav__link">
    malloc_par
  </a>

</li>

      </ul>
    </nav>

</li>





        <li class="md-nav__item">
          <a href="#__comments" class="md-nav__link md-nav__link--active">
            评论
          </a>
        </li>

    </ul>

</nav>
                  </div>
                </div>
              </div>


          <div class="md-content">
            <article class="md-content__inner md-typeset">


                  <a href="https://github.com/ctf-wiki/ctf-wiki/blob/master/docs/pwn/linux/glibc-heap/heap_structure.md" title="编辑此页" class="md-icon md-content__icon">&#xE3C9;</a>


                <p><a href="./">EN</a> | <a href="../heap_structure-zh/">ZH</a></p>
<h1 id="related-data-structure">堆related data structure<a class="headerlink" href="#related-data-structure" title="Permanent link">&para;</a></h1>
<p>The operation of the heap is so complicated, so there must be a well-designed data structure inside glibc to manage it. The data structure corresponding to the heap is mainly divided into</p>
<ul>
<li>A macro structure that contains macro information about the heap through which the basic information of the heap can be indexed.</li>
<li>Microstructure, which is used to specifically handle the allocation and reclaiming of memory blocks.</li>
</ul>
<h2 id="overview">Overview？？？？<a class="headerlink" href="#overview" title="Permanent link">&para;</a></h2>
<p><strong> Give a macro picture here. </strong></p>
<h2 id="micro-structure">micro structure<a class="headerlink" href="#micro-structure" title="Permanent link">&para;</a></h2>
<p>Here we first introduce the structure of the details in the heap, and the vulnerability of the heap is closely related to these structures**.</p>
<h3 id="malloc_chunk">malloc_chunk<a class="headerlink" href="#malloc_chunk" title="Permanent link">&para;</a></h3>
<h4 id="overview_1">Overview<a class="headerlink" href="#overview_1" title="Permanent link">&para;</a></h4>
<p>During the execution of the program, we call the memory requested by malloc as chunk. This memory is represented inside the ptmalloc by the malloc_chunk structure. When the chunk requested by the program is free, it will be added to the corresponding idle management list.</p>
<p>Very interestingly, <strong> they all use a uniform structure</strong> regardless of the size of a chunk, whether it is allocated or released. Although they use the same data structure, they will behave differently depending on whether they are released.</p>
<p>The structure of malloc_chunk is as follows</p>
<div class="codehilite"><pre><span></span><code><span class="cm">/*</span>

<span class="cm">  This struct declaration is misleading (but accurate and necessary).</span>

<span class="cm">  It declares a &quot;view&quot; into memory allowing access to necessary</span>

<span class="cm">  fields at known offsets from a given base. See explanation below.</span>

<span class="cm">*/</span>

<span class="k">struct</span> <span class="n">malloc_chunk</span> <span class="p">{</span>



  <span class="n">INTERNAL_SIZE_T</span>      <span class="n">prev_size</span><span class="p">;</span>  <span class="cm">/* Size of previous chunk (if free).  */</span>

  <span class="n">INTERNAL_SIZE_T</span>      <span class="n">size</span><span class="p">;</span>       <span class="cm">/* Size in bytes, including overhead. */</span>



  <span class="k">struct</span> <span class="n">malloc_chunk</span><span class="o">*</span> <span class="n">fd</span><span class="p">;</span>         <span class="cm">/* double links -- used only if free. */</span>

  <span class="k">struct</span> <span class="n">malloc_chunk</span><span class="o">*</span> <span class="n">bk</span><span class="p">;</span>



  <span class="cm">/* Only used for large blocks: pointer to next larger size.  */</span>

  <span class="k">struct</span> <span class="n">malloc_chunk</span><span class="o">*</span> <span class="n">fd_nextsize</span><span class="p">;</span> <span class="cm">/* double links -- used only if free. */</span>

  <span class="k">struct</span> <span class="n">malloc_chunk</span><span class="o">*</span> <span class="n">bk_nextsize</span><span class="p">;</span>

<span class="p">};</span>
</code></pre></div>

<p>First, here are some necessary explanations INTERNAL_SIZE_T, SIZE_SZ, MALLOC_ALIGN_MASK:</p>
<div class="codehilite"><pre><span></span><code><span class="cm">/* INTERNAL_SIZE_T is the word-size used for internal bookkeeping of</span>

<span class="cm">   chunk sizes.</span>

<span class="cm">   The default version is the same as size_t.</span>

<span class="cm">   While not strictly necessary, it is best to define this as an</span>

<span class="cm">   unsigned type, even if size_t is a signed type. This may avoid some</span>

<span class="cm">   artificial size limitations on some systems.</span>

<span class="cm">   On a 64-bit machine, you may be able to reduce malloc overhead by</span>

<span class="cm">   defining INTERNAL_SIZE_T to be a 32 bit `unsigned int&#39; at the</span>

<span class="cm">   expense of not being able to handle more than 2^32 of malloced</span>

<span class="cm">   space. If this limitation is acceptable, you are encouraged to set</span>

<span class="cm">   this unless you are on a platform requiring 16byte alignments. In</span>

<span class="cm">   this case the alignment requirements turn out to negate any</span>

<span class="cm">   potential advantages of decreasing size_t word size.</span>

<span class="cm">   Implementors: Beware of the possible combinations of:</span>

<span class="cm">     - INTERNAL_SIZE_T might be signed or unsigned, might be 32 or 64 bits,</span>

<span class="cm">       and might be the same width as int or as long</span>

<span class="cm">     - size_t might have different width and signedness as INTERNAL_SIZE_T</span>

<span class="cm">     - int and long might be 32 or 64 bits, and might be the same width</span>

<span class="cm">   To deal with this, most comparisons and difference computations</span>

<span class="cm">   among INTERNAL_SIZE_Ts should cast them to unsigned long, being</span>

<span class="cm">   aware of the fact that casting an unsigned int to a wider long does</span>

<span class="cm">   not sign-extend. (This also makes checking for negative numbers</span>

<span class="cm">   awkward.) Some of these casts result in harmless compiler warnings</span>

<span class="cm">   on some systems.  */</span>

<span class="cp">#ifndef INTERNAL_SIZE_T</span>

<span class="cp"># define INTERNAL_SIZE_T size_t</span>

<span class="cp">#endif</span>


<span class="cm">/* The corresponding word size.  */</span>

<span class="cp">#define SIZE_SZ (sizeof (INTERNAL_SIZE_T))</span>



<span class="cm">/* The corresponding bit mask value.  */</span>

<span class="cp">#define MALLOC_ALIGN_MASK (MALLOC_ALIGNMENT - 1)</span>
</code></pre></div>

<p>In general, size_t is a 64-bit unsigned integer in 64 bits and a 32-bit unsigned integer in 32 bits.</p>
<p>The specific explanation of each field is as follows</p>
<ul>
<li><strong>prev_size</strong>, if the chunk's <strong> physically adjacent previous address chunk (the address difference between the two pointers is the previous chunk size)</strong> is idle, then the field records the previous chunk The size (including the chunk header). Otherwise, this field can be used to store data for the physical chunk of the previous chunk. <strong>The previous chunk here refers to the chunk </strong> of the lower address.</li>
<li><strong>size</strong> , the size of the chunk, the size must be an integer multiple of 2 * SIZE_SZ. If the requested memory size is not an integer multiple of 2 * SIZE_SZ, it will be converted to a multiple of the smallest 2 * SIZE_SZ that satisfies the size. In a 32-bit system, SIZE_SZ is 4; in a 64-bit system, SIZE_SZ is 8. The lower three bits of this field have no effect on the size of the chunk, they are represented from high to low respectively.</li>
<li>NON_MAIN_ARENA, records whether the current chunk does not belong to the main thread, 1 means not belonging, 0 means belongs.</li>
<li>IS_MAPPED, which records whether the current chunk is allocated by mmap.</li>
<li>PREV_INUSE, records whether the previous chunk is allocated. In general, the P bit of the size field of the first allocated memory block in the heap is set to 1, in order to prevent access to the previous illegal memory. When the P bit of the size of a chunk is 0, we can get the size and address of the previous chunk through the prev_size field. This also facilitates the merging between free chunks.</li>
<li><strong>fd, bk</strong>. When the chunk is in the allocation state, it is the user's data starting from the fd field. When chunk is idle, it will be added to the corresponding idle management list. The meaning of the fields is as follows</li>
<li>fd points to the next (non-physical neighbor) free chunk</li>
<li>bk points to the previous (non-physical neighbor) free chunk</li>
<li>Freed chunks can be added to the free chunk block list for unified management via fd and bk</li>
<li><strong>fd_nextsize, bk_nextsize</strong>, which is only used when the chunk is free, but it is used for larger chunks.</li>
<li>fd_nextsize points to the first free block of the previous size that is different from the current chunk, and does not contain the head pointer of the bin.</li>
<li>bk_nextsize points to the next free block of the current chunk size, excluding the head pointer of the bin.</li>
<li>Large chunks that are generally free are arranged in descending order of fd, in descending order. <strong>Doing so avoids traversing when looking for a suitable chunk. </strong></li>
</ul>
<p>The appearance of an already allocated chunk is as follows. <strong> We call the first two fields called chunk headers, and the latter part is called user data. The memory pointer obtained by each malloc application actually points to the beginning of user data. </strong></p>
<p>When a chunk is in use, its prev_size field of the next chunk is invalid, and the part of the next chunk can also be used by the current chunk. <strong>This is the spatial reuse in the chunk. </strong></p>
<div class="codehilite"><pre><span></span><code><span class="n">chunk</span><span class="o">-&gt;</span> <span class="o">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span>

        <span class="o">|</span>             <span class="n">Size</span> <span class="n">of</span> <span class="n">previous</span> <span class="n">chunk</span><span class="p">,</span> <span class="k">if</span> <span class="n">unallocated</span> <span class="p">(</span><span class="n">P</span> <span class="n">clear</span><span class="p">)</span>  <span class="o">|</span>

        <span class="o">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span>

        <span class="o">|</span>             <span class="n">Size</span> <span class="n">of</span> <span class="n">chunk</span><span class="p">,</span> <span class="n">in</span> <span class="n">bytes</span>                     <span class="o">|</span><span class="n">A</span><span class="o">|</span><span class="n">M</span><span class="o">|</span><span class="n">P</span><span class="o">|</span>

<span class="n">mem</span><span class="o">-&gt;</span> <span class="o">+</span> <span class="o">-</span> <span class="o">+</span> <span class="o">-</span> <span class="o">+</span> <span class="o">-</span> <span class="o">+</span> <span class="o">-</span> <span class="o">+</span> <span class="o">-</span> <span class="o">+</span> <span class="o">-</span> <span class="o">+</span> <span class="o">-</span> <span class="o">+</span> <span class="o">-</span> <span class="o">+</span> <span class="o">-</span> <span class="o">+</span> <span class="o">-</span> <span class="o">+</span> <span class="o">+</span> <span class="o">+</span> <span class="o">+</span> <span class="o">+</span> <span class="o">+</span> <span class="o">+</span> <span class="o">+</span> <span class="o">+</span> <span class="o">+</span> <span class="o">-</span> <span class="o">+</span> <span class="o">-</span> <span class="o">+</span> <span class="o">-</span> <span class="o">+</span> <span class="o">-</span> <span class="o">+</span> <span class="o">-</span> <span class="o">+</span> <span class="o">-</span> <span class="o">+</span> <span class="o">-</span> <span class="o">+</span> <span class="o">-</span> <span class="o">+</span> <span class="o">-</span> <span class="o">+</span> <span class="o">-</span> <span class="o">+</span> <span class="o">-</span> <span class="o">+</span> <span class="o">-</span> <span class="o">+</span> <span class="o">-</span> <span class="o">+</span>
        <span class="o">|</span>             <span class="n">User</span> <span class="n">data</span> <span class="n">starts</span> <span class="n">here</span><span class="p">...</span>                          <span class="p">.</span>

        <span class="p">.</span>                                                               <span class="p">.</span>

        <span class="p">.</span>             <span class="p">(</span><span class="n">malloc_usable_size</span><span class="p">()</span> <span class="n">bytes</span><span class="p">)</span>                      <span class="p">.</span>

<span class="n">next</span>    <span class="p">.</span>                                                               <span class="o">|</span>

<span class="n">chunk</span><span class="o">-&gt;</span> <span class="o">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span>

        <span class="o">|</span>             <span class="p">(</span><span class="n">size</span> <span class="n">of</span> <span class="n">chunk</span><span class="p">,</span> <span class="n">but</span> <span class="n">used</span> <span class="k">for</span> <span class="n">application</span> <span class="n">data</span><span class="p">)</span>    <span class="o">|</span>

        <span class="o">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span>

        <span class="o">|</span>             <span class="n">Size</span> <span class="n">of</span> <span class="n">next</span> <span class="n">chunk</span><span class="p">,</span> <span class="n">in</span> <span class="n">bytes</span>                <span class="o">|</span><span class="n">A</span><span class="o">|</span><span class="mi">0</span><span class="o">|</span><span class="mi">1</span><span class="o">|</span>

        <span class="o">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span>
</code></pre></div>

<p>The released chunks are recorded in a linked list (either a circular doubly linked list or a singly linked list). The specific structure is as follows</p>
<div class="codehilite"><pre><span></span><code><span class="n">chunk</span><span class="o">-&gt;</span> <span class="o">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span>

        <span class="o">|</span>             <span class="n">Size</span> <span class="n">of</span> <span class="n">previous</span> <span class="n">chunk</span><span class="p">,</span> <span class="k">if</span> <span class="n">unallocated</span> <span class="p">(</span><span class="n">P</span> <span class="n">clear</span><span class="p">)</span>  <span class="o">|</span>
        <span class="o">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span>

<span class="err">`</span><span class="nl">head</span><span class="p">:</span><span class="err">&#39;</span> <span class="o">|</span>             <span class="n">Size</span> <span class="n">of</span> <span class="n">chunk</span><span class="p">,</span> <span class="n">in</span> <span class="n">bytes</span>                     <span class="o">|</span><span class="n">A</span><span class="o">|</span><span class="mi">0</span><span class="o">|</span><span class="n">P</span><span class="o">|</span>

<span class="n">mem</span><span class="o">-&gt;</span> <span class="o">+</span> <span class="o">-</span> <span class="o">+</span> <span class="o">-</span> <span class="o">+</span> <span class="o">-</span> <span class="o">+</span> <span class="o">-</span> <span class="o">+</span> <span class="o">-</span> <span class="o">+</span> <span class="o">-</span> <span class="o">+</span> <span class="o">-</span> <span class="o">+</span> <span class="o">-</span> <span class="o">+</span> <span class="o">-</span> <span class="o">+</span> <span class="o">-</span> <span class="o">+</span> <span class="o">+</span> <span class="o">+</span> <span class="o">+</span> <span class="o">+</span> <span class="o">+</span> <span class="o">+</span> <span class="o">+</span> <span class="o">+</span> <span class="o">+</span> <span class="o">-</span> <span class="o">+</span> <span class="o">-</span> <span class="o">+</span> <span class="o">-</span> <span class="o">+</span> <span class="o">-</span> <span class="o">+</span> <span class="o">-</span> <span class="o">+</span> <span class="o">-</span> <span class="o">+</span> <span class="o">-</span> <span class="o">+</span> <span class="o">-</span> <span class="o">+</span> <span class="o">-</span> <span class="o">+</span> <span class="o">-</span> <span class="o">+</span> <span class="o">-</span> <span class="o">+</span> <span class="o">-</span> <span class="o">+</span> <span class="o">-</span> <span class="o">+</span>
        <span class="o">|</span>             <span class="n">Forward</span> <span class="n">pointer</span> <span class="n">to</span> <span class="n">next</span> <span class="n">chunk</span> <span class="n">in</span> <span class="n">list</span>             <span class="o">|</span>

        <span class="o">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span>

        <span class="o">|</span>             <span class="n">Back</span> <span class="n">pointer</span> <span class="n">to</span> <span class="n">previous</span> <span class="n">chunk</span> <span class="n">in</span> <span class="n">list</span>            <span class="o">|</span>

        <span class="o">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span>

        <span class="o">|</span>             <span class="n">Unused</span> <span class="n">space</span> <span class="p">(</span><span class="n">may</span> <span class="n">be</span> <span class="mi">0</span> <span class="n">bytes</span> <span class="kt">long</span><span class="p">)</span>                <span class="p">.</span>

        <span class="p">.</span>                                                               <span class="p">.</span>

 <span class="n">next</span>   <span class="p">.</span>                                                               <span class="o">|</span>

<span class="n">chunk</span><span class="o">-&gt;</span> <span class="o">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span>

<span class="err">`</span><span class="nl">foot</span><span class="p">:</span><span class="err">&#39;</span> <span class="o">|</span>             <span class="n">Size</span> <span class="n">of</span> <span class="n">chunk</span><span class="p">,</span> <span class="n">in</span> <span class="n">bytes</span>                           <span class="o">|</span>

        <span class="o">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span>

        <span class="o">|</span>             <span class="n">Size</span> <span class="n">of</span> <span class="n">next</span> <span class="n">chunk</span><span class="p">,</span> <span class="n">in</span> <span class="n">bytes</span>                <span class="o">|</span><span class="n">A</span><span class="o">|</span><span class="mi">0</span><span class="o">|</span><span class="mi">0</span><span class="o">|</span>

        <span class="o">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span>
</code></pre></div>

<p>It can be found that if a chunk is in the free state, there will be two locations to record their corresponding sizes.</p>
<ol>
<li>
<p>The size field itself will be logged,</p>
</li>
<li>
<p>The chunks following it will be logged.</p>
</li>
</ol>
<p><strong> In general, </strong>, two free chunks of physical neighbors will be merged into one chunk. The heap manager merges two physically adjacent free chunk chunks through the prev_size field and the size field.</p>
<p><strong>! ! ! Some constraints on the heap, consider it in detail later! ! ! </strong></p>
<div class="codehilite"><pre><span></span><code><span class="cm">/*</span>

<span class="cm">    The three exceptions to all this are:</span>

<span class="cm">     1. The special chunk `top&#39; doesn&#39;t bother using the</span>

<span class="cm">    trailing size field since there is no next contiguous chunk</span>

<span class="cm">    that would have to index off it. After initialization, `top&#39;</span>

<span class="cm">    is forced to always exist.  If it would become less than</span>

<span class="cm">    MINSIZE bytes long, it is replenished.</span>

<span class="cm">     2. Chunks allocated via mmap, which have the second-lowest-order</span>

<span class="cm">    bit M (IS_MMAPPED) set in their size fields.  Because they are</span>

<span class="cm">    allocated one-by-one, each must contain its own trailing size</span>

<span class="cm">    field.  If the M bit is set, the other bits are ignored</span>

<span class="cm">    (because mmapped chunks are neither in an arena, nor adjacent</span>

<span class="cm">    to a freed chunk).  The M bit is also used for chunks which</span>

<span class="cm">    originally came from a dumped heap via malloc_set_state in</span>

<span class="cm">    hooks.c.</span>

<span class="cm">     3. Chunks in fastbins are treated as allocated chunks from the</span>

<span class="cm">    point of view of the chunk allocator.  They are consolidated</span>

<span class="cm">    with their neighbors only in bulk, in malloc_consolidate.</span>

<span class="cm">*/</span>
</code></pre></div>

<h4 id="chunk-related-macro">chunk related macro<a class="headerlink" href="#chunk-related-macro" title="Permanent link">&para;</a></h4>
<p>Here mainly introduces the size of the chunk, the alignment check, and some macros for conversion.</p>
<p><strong>chunk and mem pointer header conversion</strong></p>
<p>Mem points to the starting position of the memory the user gets.</p>
<div class="codehilite"><pre><span></span><code><span class="cm">/* conversion from malloc headers to user pointers, and back */</span>

<span class="cp">#define chunk2mem(p) ((void *) ((char *) (p) + 2 * SIZE_SZ))</span>

<span class="cp">#define mem2chunk(mem) ((mchunkptr)((char *) (mem) -2 * SIZE_SZ))</span>
</code></pre></div>

<p><strong>Minimum chunk size</strong></p>
<div class="codehilite"><pre><span></span><code><span class="cm">/* The smallest possible chunk */</span>

<span class="cp">#define MIN_CHUNK_SIZE (offsetof(struct malloc_chunk, fd_nextsize))</span>
</code></pre></div>

<p>Here, the offsetof function calculates the offset of fd_nextsize in malloc_chunk, indicating that the smallest chunk must contain at least the bk pointer.</p>
<p><strong>Minimum requested heap memory size</strong></p>
<p>The memory size requested by the user must be a minimum integer multiple of 2 * SIZE_SZ.</p>
<p><strong> Note: As for the current MIN_CHUNK_SIZE and MINSIZE sizes are the same, I personally think that the reason to add two macros is to facilitate the later modification of malloc_chunk. </strong></p>
<div class="codehilite"><pre><span></span><code><span class="cm">/* The smallest size we can malloc is an aligned minimal chunk */</span>

<span class="c1">//MALLOC_ALIGN_MASK = 2 * SIZE_SZ -1</span>

<span class="cp">#define MINSIZE                                                                \</span>

    <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="p">(((</span><span class="n">MIN_CHUNK_SIZE</span> <span class="o">+</span> <span class="n">MALLOC_ALIGN_MASK</span><span class="p">)</span> <span class="o">&amp;</span>                   \

                      <span class="o">~</span><span class="n">MALLOC_ALIGN_MASK</span><span class="p">))</span>
</code></pre></div>

<p><strong>Check if the memory allocated to the user is aligned</strong></p>
<p>2 * SIZE_SZ size aligned.</p>
<div class="codehilite"><pre><span></span><code><span class="cm">/* Check if m has acceptable alignment */</span>

<span class="c1">// MALLOC_ALIGN_MASK = 2 * SIZE_SZ -1</span>

<span class="cp">#define aligned_OK(m) (((unsigned long) (m) &amp; MALLOC_ALIGN_MASK) == 0)</span>



<span class="cp">#define misaligned_chunk(p)                                                    \</span>

    <span class="p">((</span><span class="kt">uintptr_t</span><span class="p">)(</span><span class="n">MALLOC_ALIGNMENT</span> <span class="o">==</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">SIZE_SZ</span> <span class="o">?</span> <span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="o">:</span> <span class="n">chunk2mem</span><span class="p">(</span><span class="n">p</span><span class="p">))</span> <span class="o">&amp;</span>       \

     <span class="n">MALLOC_ALIGN_MASK</span><span class="p">)</span>
</code></pre></div>

<p><strong>Request Byte Count Judgment</strong></p>
<div class="codehilite"><pre><span></span><code><span class="cm">/*</span>

<span class="cm">   Check if a request is so large that it would wrap around zero when</span>

<span class="cm">   padded and aligned. To simplify some other code, the bound is made</span>

<span class="cm">   low enough so that adding MINSIZE will also not wrap around zero.</span>

<span class="cm"> */</span>



<span class="cp">#define REQUEST_OUT_OF_RANGE(req)                                              \</span>

    <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="p">(</span><span class="n">req</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="p">(</span><span class="n">INTERNAL_SIZE_T</span><span class="p">)(</span><span class="o">-</span><span class="mi">2</span> <span class="o">*</span> <span class="n">MINSIZE</span><span class="p">))</span>
</code></pre></div>

<p><strong> Convert user request memory size to actual allocated memory size</strong></p>
<div class="codehilite"><pre><span></span><code><span class="cm">/* pad request bytes into a usable size -- internal version */</span>

<span class="c1">//MALLOC_ALIGN_MASK = 2 * SIZE_SZ -1</span>

<span class="cp">#define request2size(req)                                                      \</span>

    <span class="p">(((</span><span class="n">req</span><span class="p">)</span> <span class="o">+</span> <span class="n">SIZE_SZ</span> <span class="o">+</span> <span class="n">MALLOC_ALIGN_MASK</span> <span class="o">&lt;</span> <span class="n">MINSIZE</span><span class="p">)</span>                           \

         <span class="o">?</span> <span class="n">MINSIZE</span>                                                             \

         <span class="o">:</span> <span class="p">((</span><span class="n">req</span><span class="p">)</span> <span class="o">+</span> <span class="n">SIZE_SZ</span> <span class="o">+</span> <span class="n">MALLOC_ALIGN_MASK</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">MALLOC_ALIGN_MASK</span><span class="p">)</span>



<span class="cm">/*  Same, except also perform argument check */</span>



<span class="cp">#define checked_request2size(req, sz)                                          \</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">REQUEST_OUT_OF_RANGE</span><span class="p">(</span><span class="n">req</span><span class="p">))</span> <span class="p">{</span>                                           \
        <span class="n">__set_errno</span><span class="p">(</span><span class="n">ENOMEM</span><span class="p">);</span>                                                   \

        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>                                                              \

    <span class="p">}</span>                                                                          \

    <span class="p">(</span><span class="n">sz</span><span class="p">)</span> <span class="o">=</span> <span class="n">request2size</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
</code></pre></div>

<p>When a chunk is in the allocated state, the prev_size field of its next physical next chunk must be invalid, so this field can be used by the current chunk. This is the multiplexing between chunks in ptmalloc. The specific process is as follows</p>
<ol>
<li>First, use REQUEST_OUT_OF_RANGE to determine if the chunk of the byte size requested by the user can be allocated.</li>
<li>Second, it should be noted that the byte requested by the user is used to store data, that is, the part after the chunk header. At the same time, due to the multiplexing between chunks, the prev_size field of the next chunk can be used. Therefore, you only need to add the SIZE_SZ size to fully store the content.</li>
<li>Since the minimum chunk of the application allowed in the system is MINSIZE, it is compared. If the minimum requirement is not met, then the MINSIZE byte needs to be allocated directly.</li>
<li>If it is greater, because the chunk requested in the system requires 2 * SIZE_SZ alignment, MALLOC_ALIGN_MASK needs to be added here to facilitate alignment.</li>
</ol>
<p><strong> Personally think that it is not necessary to add MALLOC_ALIGN_MASK in the first line of the request2size macro. </strong></p>
<p><strong> It should be noted that the size obtained by such a calculation formula must ultimately satisfy the user's needs. </strong></p>
<p><strong>Marker related</strong></p>
<div class="codehilite"><pre><span></span><code><span class="cm">/* size field is or&#39;ed with PREV_INUSE when previous adjacent chunk in use */</span>

<span class="cp">#define PREV_INUSE 0x1</span>



<span class="cm">/* extract inuse bit of previous chunk */</span>

<span class="cp">#define prev_inuse(p) ((p)-&gt;mchunk_size &amp; PREV_INUSE)</span>



<span class="cm">/* size field is or&#39;ed with IS_MMAPPED if the chunk was obtained with mmap() */</span>

<span class="cp">#define IS_MMAPPED 0x2</span>



<span class="cm">/* check for mmap()&#39;ed chunk */</span>

<span class="cp">#define chunk_is_mmapped(p) ((p)-&gt;mchunk_size &amp; IS_MMAPPED)</span>



<span class="cm">/* size field is or&#39;ed with NON_MAIN_ARENA if the chunk was obtained</span>

<span class="cm">   from a non-main arena.  This is only set immediately before handing</span>

<span class="cm">   the chunk to the user, if necessary.  */</span>

<span class="cp">#define NON_MAIN_ARENA 0x4</span>



<span class="cm">/* Check for chunk from main arena.  */</span>

<span class="cp">#define chunk_main_arena(p) (((p)-&gt;mchunk_size &amp; NON_MAIN_ARENA) == 0)</span>



<span class="cm">/* Mark a chunk as not being on the main arena.  */</span>

<span class="cp">#define set_non_main_arena(p) ((p)-&gt;mchunk_size |= NON_MAIN_ARENA)</span>



<span class="cm">/*</span>

<span class="cm">   Bits to mask off when extracting size</span>

<span class="cm">   Note: IS_MMAPPED is intentionally not masked off from size field in</span>

<span class="cm">   macros for which mmapped chunks should never be seen. This should</span>

<span class="cm">   cause helpful core dumps to occur if it is tried by accident by</span>

<span class="cm">   people extending or adapting this malloc.</span>

<span class="cm"> */</span>

<span class="cp">#define SIZE_BITS (PREV_INUSE | IS_MMAPPED | NON_MAIN_ARENA)</span>
</code></pre></div>

<p><strong>Get chunk size</strong></p>
<div class="codehilite"><pre><span></span><code><span class="cm">/* Get size, ignoring use bits */</span>

<span class="cp">#define chunksize(p) (chunksize_nomask(p) &amp; ~(SIZE_BITS))</span>



<span class="cm">/* Like chunksize, but do not mask SIZE_BITS.  */</span>

<span class="cp">#define chunksize_nomask(p) ((p)-&gt;mchunk_size)</span>
</code></pre></div>

<p><strong>Get the next physical neighboring chunk</strong></p>
<div class="codehilite"><pre><span></span><code><span class="cm">/* Ptr to next physical malloc_chunk. */</span>

<span class="cp">#define next_chunk(p) ((mchunkptr)(((char *) (p)) + chunksize(p)))</span>
</code></pre></div>

<p><strong>Get information about the previous chunk</strong></p>
<div class="codehilite"><pre><span></span><code><span class="cm">/* Size of the chunk below P.  Only valid if !prev_inuse (P).  */</span>

<span class="cp">#define prev_size(p) ((p)-&gt;mchunk_prev_size)</span>



<span class="cm">/* Set the size of the chunk below P.  Only valid if !prev_inuse (P).  */</span>

<span class="cp">#define set_prev_size(p, sz) ((p)-&gt;mchunk_prev_size = (sz))</span>



<span class="cm">/* Ptr to previous physical malloc_chunk.  Only valid if !prev_inuse (P).  */</span>

<span class="cp">#define prev_chunk(p) ((mchunkptr)(((char *) (p)) - prev_size(p)))</span>
</code></pre></div>

<p><strong>Current chunk usage status related operations</strong></p>
<div class="codehilite"><pre><span></span><code><span class="cm">/* extract p&#39;s inuse bit */</span>

<span class="cp">#define inuse(p)                                                               \</span>

    <span class="p">((((</span><span class="n">mchunkptr</span><span class="p">)(((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">p</span><span class="p">))</span> <span class="o">+</span> <span class="n">chunksize</span><span class="p">(</span><span class="n">p</span><span class="p">)))</span><span class="o">-&gt;</span><span class="n">mchunk_size</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">PREV_INUSE</span><span class="p">)</span>



<span class="cm">/* set/clear chunk as being inuse without otherwise disturbing */</span>

<span class="cp">#define set_inuse(p)                                                           \</span>

    <span class="p">((</span><span class="n">mchunkptr</span><span class="p">)(((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">p</span><span class="p">))</span> <span class="o">+</span> <span class="n">chunksize</span><span class="p">(</span><span class="n">p</span><span class="p">)))</span><span class="o">-&gt;</span><span class="n">mchunk_size</span> <span class="o">|=</span> <span class="n">PREV_INUSE</span>



<span class="cp">#define clear_inuse(p)                                                         \</span>

    <span class="p">((</span><span class="n">mchunkptr</span><span class="p">)(((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">p</span><span class="p">))</span> <span class="o">+</span> <span class="n">chunksize</span><span class="p">(</span><span class="n">p</span><span class="p">)))</span><span class="o">-&gt;</span><span class="n">mchunk_size</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">PREV_INUSE</span><span class="p">)</span>
</code></pre></div>

<p><strong>Set the size field of the chunk</strong></p>
<div class="codehilite"><pre><span></span><code><span class="cm">/* Set size at head, without disturbing its use bit */</span>

<span class="c1">// SIZE_BITS = 7</span>

<span class="cp">#define set_head_size(p, s)                                                    \</span>

    <span class="p">((</span><span class="n">p</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">mchunk_size</span> <span class="o">=</span> <span class="p">(((</span><span class="n">p</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">mchunk_size</span> <span class="o">&amp;</span> <span class="n">SIZE_BITS</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">s</span><span class="p">)))</span>



<span class="cm">/* Set size/use field */</span>

<span class="cp">#define set_head(p, s) ((p)-&gt;mchunk_size = (s))</span>



<span class="cm">/* Set size at footer (only when chunk is not in use) */</span>

<span class="cp">#define set_foot(p, s)                                                         \</span>

    <span class="p">(((</span><span class="n">mchunkptr</span><span class="p">)((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">s</span><span class="p">)))</span><span class="o">-&gt;</span><span class="n">mchunk_prev_size</span> <span class="o">=</span> <span class="p">(</span><span class="n">s</span><span class="p">))</span>
</code></pre></div>

<p><strong>Get the chunk of the specified offset</strong></p>
<div class="codehilite"><pre><span></span><code><span class="cm">/* Treat space at ptr + offset as a chunk */</span>

<span class="cp">#define chunk_at_offset(p, s) ((mchunkptr)(((char *) (p)) + (s)))</span>
</code></pre></div>

<p><strong>Specify the offset at the chunk usage state related operation</strong></p>
<div class="codehilite"><pre><span></span><code><span class="cm">/* check/set/clear inuse bits in known places */</span>

<span class="cp">#define inuse_bit_at_offset(p, s)                                              \</span>

    <span class="p">(((</span><span class="n">mchunkptr</span><span class="p">)(((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">p</span><span class="p">))</span> <span class="o">+</span> <span class="p">(</span><span class="n">s</span><span class="p">)))</span><span class="o">-&gt;</span><span class="n">mchunk_size</span> <span class="o">&amp;</span> <span class="n">PREV_INUSE</span><span class="p">)</span>


<span class="cp">#define set_inuse_bit_at_offset(p, s)                                          \</span>

    <span class="p">(((</span><span class="n">mchunkptr</span><span class="p">)(((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">p</span><span class="p">))</span> <span class="o">+</span> <span class="p">(</span><span class="n">s</span><span class="p">)))</span><span class="o">-&gt;</span><span class="n">mchunk_size</span> <span class="o">|=</span> <span class="n">PREV_INUSE</span><span class="p">)</span>



<span class="cp">#define clear_inuse_bit_at_offset(p, s)                                        \</span>

    <span class="p">(((</span><span class="n">mchunkptr</span><span class="p">)(((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">p</span><span class="p">))</span> <span class="o">+</span> <span class="p">(</span><span class="n">s</span><span class="p">)))</span><span class="o">-&gt;</span><span class="n">mchunk_size</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">PREV_INUSE</span><span class="p">))</span>
</code></pre></div>

<h3 id="am">am<a class="headerlink" href="#am" title="Permanent link">&para;</a></h3>
<h4 id="overview_2">Overview<a class="headerlink" href="#overview_2" title="Permanent link">&para;</a></h4>
<p>We have said that the chunks released by the user will not be returned to the system immediately, and ptmalloc will uniformly manage the free chunks in the heap area of the heap and mmap. When the user again requests memory allocation, the ptmalloc allocator will attempt to pick a suitable one for the user in the free chunk. This avoids frequent system calls and reduces the overhead of memory allocation.</p>
<p>In a specific implementation, ptmalloc manages idle chunks in a bin-wise manner. First, it will initially classify chunks into four categories based on the size of the free chunks and the state of use: fast bins, small bins, large bins, unsorted bins. There is still a finer division in each class, and similarly sized chunks are linked by a doubly linked list. That is to say, there will still be multiple unrelated lists in each type of bin to hold chunks of different sizes.</p>
<p>For small bins, large bins, unsorted bins, ptmalloc maintains them in the same array. The data structure corresponding to these bins is in malloc_state, as follows</p>
<div class="codehilite"><pre><span></span><code><span class="cp">#define NBINS 128</span>

<span class="cm">/* Normal bins packed as described above */</span>

<span class="n">mchunkptr</span> <span class="n">bins</span><span class="p">[</span> <span class="n">NBINS</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">-</span> <span class="mi">2</span> <span class="p">];</span>
</code></pre></div>

<p>Although the header of each bin uses the mchunkptr data structure, this is just for the convenience of converting each bin into a malloc_chunk pointer. When we use it, we will use this pointer as a chunk's fd or bk pointer to link together the free heap blocks. This saves space and increases usability. How is it saved? Here we take 32-bit system as an example.</p>
<table>
<thead>
<tr>
<th>Meaning</th>
<th>bin1 fd/bin2 prev_size</th>
<th>bin1 bk/bin2 size</th>
<th>bin2 fd/bin3 prev_size</th>
<th>bin2 bk/bin3 size</th>
</tr>
</thead>
<tbody>
<tr>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
</tbody>
</table>
<p>| bin bottom board | 0 | 1 | 2 | 3 |</p>
<p>It can be seen that in addition to the first bin (unsorted bin), each subsequent bin will share the field of the previous bin, which is treated as the prev_size and size of the malloc chunk. Here also illustrates a problem, the subscript of <strong>bin is not consistent with the first few bins we are talking about. At the same time, the prev_size and size fields of the chunk of the bin header cannot be modified casually, because these two fields are used by other bins. </strong></p>
<p>The bin in the array is described as follows</p>
<ol>
<li>The first one is unsorted bin, the word is like this, the chunks inside are not sorted, and the stored chunks are more complicated.</li>
<li>The bins with indexes from 2 to 63 are called small bins, and the chunks in the same small bin list are the same size. The number of bytes in the small bin list of two adjacent indexes differs by <strong>2 machine words long</strong>, that is, 32 bits differ by 8 bytes, and 64 bits differ by 16 bytes.</li>
<li>The bin behind small bins is called large bins. Each bin in large bins contains a range of chunks, with chunks arranged in descending order of fd pointers. Chunks of the same size are also arranged in the order of recent use.</li>
</ol>
<p>In addition, the arrangement of these bins will follow a principle: <strong> Any two physically adjacent free chunks cannot be together</strong>.</p>
<p>It should be noted that not all chunks are released into the bin immediately after they are released. In order to increase the speed of allocation, ptmalloc will put some small chunks<strong> into the container of fast bins. </strong> Moreover, the usage flags of the chunks in the fastbin container are always set, so the above principles are not met. **</p>
<p>Bin general macro is as follows</p>
<div class="codehilite"><pre><span></span><code><span class="k">typedef</span> <span class="k">struct</span> <span class="n">malloc_chunk</span> <span class="o">*</span><span class="n">mbinptr</span><span class="p">;</span>



<span class="cm">/* addressing -- note that bin_at(0) does not exist */</span>

<span class="cp">#define bin_at(m, i)                                                           \</span>

    <span class="p">(</span><span class="n">mbinptr</span><span class="p">)(((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="p">((</span><span class="n">m</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">bins</span><span class="p">[</span> <span class="p">((</span><span class="n">i</span><span class="p">)</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span> <span class="p">]))</span> <span class="o">-</span>                        \

              <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">malloc_chunk</span><span class="p">,</span> <span class="n">fd</span><span class="p">))</span>



<span class="cm">/* analog of ++bin */</span>

<span class="o">/</span> <span class="o">/</span> <span class="n">Get</span> <span class="n">the</span> <span class="n">address</span> <span class="n">of</span> <span class="n">the</span> <span class="n">next</span> <span class="n">bin</span>
<span class="cp">#define next_bin(b) ((mbinptr)((char *) (b) + (sizeof(mchunkptr) &lt;&lt; 1)))</span>



<span class="cm">/* Reminders about list directionality within bins */</span>

<span class="c1">// These two macros can be used to traverse the bin</span>
<span class="o">/</span> <span class="o">/</span> <span class="n">Get</span> <span class="n">the</span> <span class="n">chunk</span> <span class="n">of</span> <span class="n">the</span> <span class="n">bin</span> <span class="n">at</span> <span class="n">the</span> <span class="n">head</span> <span class="n">of</span> <span class="n">the</span> <span class="n">list</span> <span class="n">header</span>
<span class="cp">#define first(b) ((b)-&gt;fd)</span>

<span class="o">/</span> <span class="o">/</span> <span class="n">Get</span> <span class="n">the</span> <span class="n">chunk</span> <span class="n">of</span> <span class="n">the</span> <span class="n">bin</span> <span class="n">at</span> <span class="n">the</span> <span class="n">end</span> <span class="n">of</span> <span class="n">the</span> <span class="n">chain</span>
<span class="cp">#define last(b) ((b)-&gt;bk)</span>
</code></pre></div>

<h4 id="fast-bin">Fast Bin<a class="headerlink" href="#fast-bin" title="Permanent link">&para;</a></h4>
<p>Most programs often apply and release some smaller blocks of memory. If some smaller chunks are released and there are free chunks adjacent to them and merged, then the next time you apply for the chunk of the corresponding size again, you need to split the chunk, which greatly reduces the heap. usage efficiency. <strong>Because we spend most of our time in the process of merging, segmentation, and intermediate checks. </strong> Therefore, the fast bin is specifically designed in ptmalloc, and the corresponding variable is fastbinsY in malloc state.</p>
<div class="codehilite"><pre><span></span><code><span class="cm">/*</span>

<span class="cm">   Fastbins</span>



<span class="cm">    An array of lists holding recently freed small chunks.  Fastbins</span>

<span class="cm">    are not doubly linked.  It is faster to single-link them, and</span>

<span class="cm">    since chunks are never removed from the middles of these lists,</span>

<span class="cm">    double linking is not necessary. Also, unlike regular bins, they</span>

<span class="cm">    are not even processed in FIFO order (they use faster LIFO) since</span>

<span class="cm">    ordering doesn&#39;t much matter in the transient contexts in which</span>

<span class="cm">    fastbins are normally used.</span>



<span class="cm">    Chunks in fastbins keep their inuse bit set, so they cannot</span>

<span class="cm">    be consolidated with other free chunks. malloc_consolidate</span>

<span class="cm">    releases all chunks in fastbins and consolidates them with</span>

<span class="cm">    other free chunks.</span>

<span class="cm"> */</span>

<span class="k">typedef</span> <span class="k">struct</span> <span class="n">malloc_chunk</span> <span class="o">*</span><span class="n">mfastbinptr</span><span class="p">;</span>



<span class="cm">/*</span>

<span class="cm">    This is in malloc_state.</span>

<span class="cm">    /* Fastbins */</span>

    <span class="n">mfastbinptr</span> <span class="n">fastbinsY</span><span class="p">[</span> <span class="n">NFASTBINS</span> <span class="p">];</span>

<span class="err">*/</span>
</code></pre></div>

<p>In order to use the fast bin more efficiently, glibc uses a singly linked list to organize each bin, and <strong> each bin adopts the LIFO policy</strong>, and the recently released chunk will be allocated earlier, so it is more suitable for Locality. That is to say, when the size of the chunk that the user needs is smaller than the maximum size of the fastbin, ptmalloc will first determine whether there is a free block of the corresponding size in the corresponding bin in the fastbin, if any, the chunk will be directly obtained from the bin. . If not, ptmalloc will do the next series of operations.</p>
<p>By default (<strong>32-bit system is an example</strong>), the maximum chunk size supported by default in fastbin is 64 bytes. But the chunk of data that it can support is up to 80 bytes. In addition, fastbin can support up to 10 bins, starting from 8 bytes in data space up to 80 bytes (note that the size of the data space is the same, that is, the prev_size and size fields are removed. Size) is defined as follows</p>
<div class="codehilite"><pre><span></span><code><span class="cp">#define NFASTBINS (fastbin_index(request2size(MAX_FAST_SIZE)) + 1)</span>



<span class="cp">#ifndef DEFAULT_MXFAST</span>

<span class="cp">#define DEFAULT_MXFAST (64 * SIZE_SZ / 4)</span>

<span class="cp">#endif</span>


<span class="cm">/* The maximum fastbin request size we support */</span>

<span class="cp">#define MAX_FAST_SIZE (80 * SIZE_SZ / 4)</span>



<span class="cm">/*</span>

<span class="cm">   Since the lowest 2 bits in max_fast don&#39;t matter in size comparisons,</span>

<span class="cm">   they are used as flags.</span>

<span class="cm"> */</span>



<span class="cm">/*</span>

<span class="cm">   FASTCHUNKS_BIT held in max_fast indicates that there are probably</span>

<span class="cm">   some fastbin chunks. It is set true on entering a chunk into any</span>

<span class="cm">   fastbin, and cleared only in malloc_consolidate.</span>



<span class="cm">   The truth value is inverted so that have_fastchunks will be true</span>

<span class="cm">   upon startup (since statics are zero-filled), simplifying</span>

<span class="cm">   initialization checks.</span>

<span class="cm"> */</span>

<span class="o">/</span> <span class="o">/</span> <span class="n">Determine</span> <span class="n">whether</span> <span class="n">the</span> <span class="n">allocation</span> <span class="n">area</span> <span class="n">has</span> <span class="n">fast</span> <span class="n">bin</span> <span class="n">chunk</span><span class="p">,</span> <span class="mi">1</span> <span class="n">means</span> <span class="n">no</span>
<span class="cp">#define FASTCHUNKS_BIT (1U)</span>



<span class="cp">#define have_fastchunks(M) (((M)-&gt;flags &amp; FASTCHUNKS_BIT) == 0)</span>

<span class="cp">#define clear_fastchunks(M) catomic_or(&amp;(M)-&gt;flags, FASTCHUNKS_BIT)</span>
<span class="cp">#define set_fastchunks(M) catomic_and(&amp;(M)-&gt;flags, ~FASTCHUNKS_BIT)</span>



<span class="cm">/*</span>

<span class="cm">   NONCONTIGUOUS_BIT indicates that MORECORE does not return contiguous</span>

<span class="cm">   regions.  Otherwise, contiguity is exploited in merging together,</span>

<span class="cm">   when possible, results from consecutive MORECORE calls.</span>



<span class="cm">   The initial value comes from MORECORE_CONTIGUOUS, but is</span>

<span class="cm">   changed dynamically if mmap is ever used as an sbrk substitute.</span>

<span class="cm"> */</span>

<span class="c1">// Whether MORECORE returns a contiguous memory area.</span>
<span class="c1">// MORECORE in the main allocation area is actually sbr(), which returns the default virtual address space by default.</span>
<span class="c1">// The non-primary allocation area uses mmap() to allocate large blocks of virtual memory and then splits to simulate the behavior of the primary allocation area.</span>
<span class="c1">// By default, the mmap mapping area does not guarantee that the virtual address space is continuous, so the non-primary allocation area allocates non-contiguous virtual address space by default.</span>
<span class="cp">#define NONCONTIGUOUS_BIT (2U)</span>



<span class="cp">#define contiguous(M) (((M)-&gt;flags &amp; NONCONTIGUOUS_BIT) == 0)</span>

<span class="cp">#define noncontiguous(M) (((M)-&gt;flags &amp; NONCONTIGUOUS_BIT) != 0)</span>

<span class="cp">#define set_noncontiguous(M) ((M)-&gt;flags |= NONCONTIGUOUS_BIT)</span>

<span class="cp">#define set_contiguous(M) ((M)-&gt;flags &amp;= ~NONCONTIGUOUS_BIT)</span>



<span class="cm">/* ARENA_CORRUPTION_BIT is set if a memory corruption was detected on the</span>

<span class="cm">   arena.  Such an arena is no longer used to allocate chunks.  Chunks</span>

<span class="cm">   allocated in that arena before detecting corruption are not freed.  */</span>



<span class="cp">#define ARENA_CORRUPTION_BIT (4U)</span>



<span class="cp">#define arena_is_corrupt(A) (((A)-&gt;flags &amp; ARENA_CORRUPTION_BIT))</span>

<span class="cp">#define set_arena_corrupt(A) ((A)-&gt;flags |= ARENA_CORRUPTION_BIT)</span>



<span class="cm">/*</span>

<span class="cm">   Set value of max_fast.</span>

<span class="cm">   Use impossibly small value if 0.</span>

<span class="cm">   Precondition: there are no existing fastbin chunks.</span>

<span class="cm">   Setting the value clears fastchunk bit but preserves noncontiguous bit.</span>

<span class="cm"> */</span>



<span class="cp">#define set_max_fast(s)                                                        \</span>

    <span class="n">global_max_fast</span> <span class="o">=</span>                                                          \

        <span class="p">(((</span><span class="n">s</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="nl">SMALLBIN_WIDTH</span> <span class="p">:</span> <span class="p">((</span><span class="n">s</span> <span class="o">+</span> <span class="n">SIZE_SZ</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">MALLOC_ALIGN_MASK</span><span class="p">))</span>

<span class="cp">#define get_max_fast() global_max_fast</span>
</code></pre></div>

<p>By default, ptmalloc calls set_max_fast(s) to set the global variable global_max_fast to DEFAULT_MXFAST, which is the maximum value of the chunk in the fast bins. When MAX_FAST_SIZE is set to 0, the system does not support fastbin.</p>
<p><strong>fastbin index</strong></p>
<div class="codehilite"><pre><span></span><code><span class="cp">#define fastbin(ar_ptr, idx) ((ar_ptr)-&gt;fastbinsY[ idx ])</span>



<span class="cm">/* offset 2 to use otherwise unindexable first 2 bins */</span>

<span class="c1">// chunk size=2*size_sz*(2+idx)</span>

<span class="o">/</span> <span class="o">/</span> <span class="n">Here</span> <span class="n">to</span> <span class="n">reduce</span> <span class="mi">2</span><span class="p">,</span> <span class="n">otherwise</span><span class="p">,</span> <span class="n">the</span> <span class="n">first</span> <span class="n">two</span> <span class="n">bins</span> <span class="n">have</span> <span class="n">no</span> <span class="n">way</span> <span class="n">to</span> <span class="n">index</span><span class="p">.</span>
<span class="cp">#define fastbin_index(sz)                                                      \</span>

    <span class="p">((((</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span> <span class="p">(</span><span class="n">sz</span><span class="p">))</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="n">SIZE_SZ</span> <span class="o">==</span> <span class="mi">8</span> <span class="o">?</span> <span class="mi">4</span> <span class="o">:</span> <span class="mi">3</span><span class="p">))</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)</span>
</code></pre></div>

<p><strong> It is important to note that the inuse of the chunk of the fastbin range is always set to 1. Therefore they will not merge with other released chunks. </strong></p>
<p>However, when the size of the released chunk and the free chunk adjacent to the chunk are larger than FASTBIN_CONSOLIDATION_THRESHOLD, the memory fragmentation may be more. We need to merge the chunks in the fast bins to reduce the impact of memory fragmentation on the system.</p>
<div class="codehilite"><pre><span></span><code><span class="cm">/*</span>

<span class="cm">   FASTBIN_CONSOLIDATION_THRESHOLD is the size of a chunk in free()</span>

<span class="cm">   that triggers automatic consolidation of possibly-surrounding</span>

<span class="cm">   fastbin chunks. This is a heuristic, so the exact value should not</span>

<span class="cm">   matter too much. It is defined at half the default trim threshold as a</span>

<span class="cm">   compromise heuristic to only attempt consolidation if it is likely</span>

<span class="cm">   to lead to trimming. However, it is not dynamically tunable, since</span>

<span class="cm">   consolidation reduces fragmentation surrounding large chunks even</span>

<span class="cm">   if trimming is not used.</span>

<span class="cm"> */</span>



<span class="cp">#define FASTBIN_CONSOLIDATION_THRESHOLD (65536UL)</span>
</code></pre></div>

<p>The <strong>malloc_consolidate function combines all the chunks in the fastbin that can be merged with other chunks. See in detail the analysis of subsequent detailed functions. </strong></p>
<div class="codehilite"><pre><span></span><code>/*

    Chunks in fastbins keep their inuse bit set, so they cannot

    be consolidated with other free chunks. malloc_consolidate

    releases all chunks in fastbins and consolidates them with

    other free chunks.

 */
</code></pre></div>

<h4 id="small-bin">Small Bin<a class="headerlink" href="#small-bin" title="Permanent link">&para;</a></h4>
<p>The relationship between the size of each chunk in small bins and the index of the bin it is in is: chunk_size = 2 * SIZE_SZ *index, as follows</p>
<table>
<thead>
<tr>
<th>Subscript</th>
<th>SIZE_SZ=4 (32-bit)</th>
<th>SIZE_SZ=8 (64-bit)</th>
</tr>
</thead>
<tbody>
<tr>
<td></td>
<td></td>
<td></td>
</tr>
</tbody>
</table>
<p>| 2    | 16             | 32             |</p>
<p>| 3    | 24             | 48             |</p>
<p>| 4    | 32             | 64             |</p>
<p>| 5    | 40             | 80             |</p>
<p>| x    | 2*4*x        | 2*8*x        |</p>
<p>| 63   | 504            | 1008           |</p>
<p>There are a total of 62 circular doubly linked lists in small bins, and the chunks stored in each linked list are the same size. For example, for a 32-bit system, the chunk size stored in the doubly linked list corresponding to subscript 2 is 16 bytes. Each linked list has a linked list node, which makes it easy to manage the internal nodes of the linked list. In addition, the linked list for each bin in <strong>small bins uses the FIFO rule</strong>, so the chunks that are first released in the same linked list are first allocated.</p>
<p>The small bin related macros are as follows</p>
<div class="codehilite"><pre><span></span><code><span class="cp">#define NSMALLBINS 64</span>

<span class="cp">#define SMALLBIN_WIDTH MALLOC_ALIGNMENT</span>

<span class="c1">// Do you need to correct the subscript of the small bin?</span>
<span class="cp">#define SMALLBIN_CORRECTION (MALLOC_ALIGNMENT &gt; 2 * SIZE_SZ)</span>



<span class="cp">#define MIN_LARGE_SIZE ((NSMALLBINS - SMALLBIN_CORRECTION) * SMALLBIN_WIDTH)</span>

<span class="o">/</span> <span class="o">/</span> <span class="n">Determine</span> <span class="n">whether</span> <span class="n">the</span> <span class="n">size</span> <span class="n">of</span> <span class="n">the</span> <span class="n">chunk</span> <span class="n">is</span> <span class="n">within</span> <span class="n">the</span> <span class="n">range</span> <span class="n">of</span> <span class="n">small</span> <span class="n">bin</span>
<span class="cp">#define in_smallbin_range(sz)                                                  \</span>

    <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="p">(</span><span class="n">sz</span><span class="p">)</span> <span class="o">&lt;</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">MIN_LARGE_SIZE</span><span class="p">)</span>

<span class="c1">// Get the index corresponding to the small bin according to the size of the chunk.</span>
<span class="cp">#define smallbin_index(sz)                                                     \</span>

    <span class="p">((</span><span class="n">SMALLBIN_WIDTH</span> <span class="o">==</span> <span class="mi">16</span> <span class="o">?</span> <span class="p">(((</span><span class="kt">unsigned</span><span class="p">)</span> <span class="p">(</span><span class="n">sz</span><span class="p">))</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span>                          \

                           <span class="o">:</span> <span class="p">(((</span><span class="kt">unsigned</span><span class="p">)</span> <span class="p">(</span><span class="n">sz</span><span class="p">))</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">))</span> <span class="o">+</span>                       \

     <span class="n">SMALLBIN_CORRECTION</span><span class="p">)</span>
</code></pre></div>

<p><strong> Perhaps, everyone will be very confused, the size of the chunks in the fastbin and small bin will have a large part of the overlap, then the size of the bin in the small bin is not useful? </strong> In fact, the chunks in the fast bin are likely to be placed in the small bin. We will have a deep understanding when analyzing the specific source code later.</p>
<h4 id="large-bin">Large Bin<a class="headerlink" href="#large-bin" title="Permanent link">&para;</a></h4>
<p>A large total of 63 bins are included in the large bins. The size of the chunks in each bin is inconsistent, but within a certain range. In addition, the 63 bins are divided into 6 groups, and the tolerances between the chunk sizes in each group bin are the same, as follows:</p>
<table>
<thead>
<tr>
<th>Group</th>
<th>Quantity</th>
<th>Tolerance</th>
</tr>
</thead>
<tbody>
<tr>
<td></td>
<td></td>
<td></td>
</tr>
</tbody>
</table>
<p>| 1 32 64B |
| 2 16 512B |
| 3    | 8    | 4096B   |</p>
<p>| 4 4 32768B |
| 5    | 2    | 262144B |</p>
<p>| 6 | 1 | No limit |</p>
<p>Here we take the large bin of the 32-bit platform as an example. The size of the first chunk of the first large bin is 512 bytes, which is in the first group, so the size of the chunk that the bin can store is [512, 512 + 64).</p>
<p>The macro about large bin is as follows. Here we take the initial chunk size of the first large bin on the 32-bit platform as 512 bytes, then 512&gt;&gt;6 = 8, so the subscript is 56+8= 64.</p>
<div class="codehilite"><pre><span></span><code><span class="cp">#define largebin_index_32(sz)                                                  \</span>

    <span class="p">(((((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="p">(</span><span class="n">sz</span><span class="p">))</span> <span class="o">&gt;&gt;</span> <span class="mi">6</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">38</span><span class="p">)</span>                                     \

         <span class="o">?</span> <span class="mi">56</span> <span class="o">+</span> <span class="p">(((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="p">(</span><span class="n">sz</span><span class="p">))</span> <span class="o">&gt;&gt;</span> <span class="mi">6</span><span class="p">)</span>                                  \

         <span class="o">:</span> <span class="p">((((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="p">(</span><span class="n">sz</span><span class="p">))</span> <span class="o">&gt;&gt;</span> <span class="mi">9</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">20</span><span class="p">)</span>                               \

               <span class="o">?</span> <span class="mi">91</span> <span class="o">+</span> <span class="p">(((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="p">(</span><span class="n">sz</span><span class="p">))</span> <span class="o">&gt;&gt;</span> <span class="mi">9</span><span class="p">)</span>                            \

               <span class="o">:</span> <span class="p">((((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="p">(</span><span class="n">sz</span><span class="p">))</span> <span class="o">&gt;&gt;</span> <span class="mi">12</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">10</span><span class="p">)</span>                        \

                     <span class="o">?</span> <span class="mi">110</span> <span class="o">+</span> <span class="p">(((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="p">(</span><span class="n">sz</span><span class="p">))</span> <span class="o">&gt;&gt;</span> <span class="mi">12</span><span class="p">)</span>                    \

                     <span class="o">:</span> <span class="p">((((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="p">(</span><span class="n">sz</span><span class="p">))</span> <span class="o">&gt;&gt;</span> <span class="mi">15</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">4</span><span class="p">)</span>                   \

                           <span class="o">?</span> <span class="mi">119</span> <span class="o">+</span> <span class="p">(((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="p">(</span><span class="n">sz</span><span class="p">))</span> <span class="o">&gt;&gt;</span> <span class="mi">15</span><span class="p">)</span>              \

                           <span class="o">:</span> <span class="p">((((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="p">(</span><span class="n">sz</span><span class="p">))</span> <span class="o">&gt;&gt;</span> <span class="mi">18</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">2</span><span class="p">)</span>             \

                                 <span class="o">?</span> <span class="mi">124</span> <span class="o">+</span> <span class="p">(((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="p">(</span><span class="n">sz</span><span class="p">))</span> <span class="o">&gt;&gt;</span> <span class="mi">18</span><span class="p">)</span>        \

                                 <span class="o">:</span> <span class="mi">126</span><span class="p">)</span>



<span class="cp">#define largebin_index_32_big(sz)                                              \</span>

    <span class="p">(((((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="p">(</span><span class="n">sz</span><span class="p">))</span> <span class="o">&gt;&gt;</span> <span class="mi">6</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">45</span><span class="p">)</span>                                     \

         <span class="o">?</span> <span class="mi">49</span> <span class="o">+</span> <span class="p">(((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="p">(</span><span class="n">sz</span><span class="p">))</span> <span class="o">&gt;&gt;</span> <span class="mi">6</span><span class="p">)</span>                                  \

         <span class="o">:</span> <span class="p">((((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="p">(</span><span class="n">sz</span><span class="p">))</span> <span class="o">&gt;&gt;</span> <span class="mi">9</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">20</span><span class="p">)</span>                               \

               <span class="o">?</span> <span class="mi">91</span> <span class="o">+</span> <span class="p">(((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="p">(</span><span class="n">sz</span><span class="p">))</span> <span class="o">&gt;&gt;</span> <span class="mi">9</span><span class="p">)</span>                            \

               <span class="o">:</span> <span class="p">((((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="p">(</span><span class="n">sz</span><span class="p">))</span> <span class="o">&gt;&gt;</span> <span class="mi">12</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">10</span><span class="p">)</span>                        \

                     <span class="o">?</span> <span class="mi">110</span> <span class="o">+</span> <span class="p">(((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="p">(</span><span class="n">sz</span><span class="p">))</span> <span class="o">&gt;&gt;</span> <span class="mi">12</span><span class="p">)</span>                    \

                     <span class="o">:</span> <span class="p">((((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="p">(</span><span class="n">sz</span><span class="p">))</span> <span class="o">&gt;&gt;</span> <span class="mi">15</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">4</span><span class="p">)</span>                   \

                           <span class="o">?</span> <span class="mi">119</span> <span class="o">+</span> <span class="p">(((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="p">(</span><span class="n">sz</span><span class="p">))</span> <span class="o">&gt;&gt;</span> <span class="mi">15</span><span class="p">)</span>              \

                           <span class="o">:</span> <span class="p">((((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="p">(</span><span class="n">sz</span><span class="p">))</span> <span class="o">&gt;&gt;</span> <span class="mi">18</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">2</span><span class="p">)</span>             \

                                 <span class="o">?</span> <span class="mi">124</span> <span class="o">+</span> <span class="p">(((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="p">(</span><span class="n">sz</span><span class="p">))</span> <span class="o">&gt;&gt;</span> <span class="mi">18</span><span class="p">)</span>        \

                                 <span class="o">:</span> <span class="mi">126</span><span class="p">)</span>



<span class="c1">// XXX It remains to be seen whether it is good to keep the widths of</span>

<span class="c1">// XXX the buckets the same or whether it should be scaled by a factor</span>

<span class="c1">// XXX of two as well.</span>

<span class="cp">#define largebin_index_64(sz)                                                  \</span>

    <span class="p">(((((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="p">(</span><span class="n">sz</span><span class="p">))</span> <span class="o">&gt;&gt;</span> <span class="mi">6</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">48</span><span class="p">)</span>                                     \

         <span class="o">?</span> <span class="mi">48</span> <span class="o">+</span> <span class="p">(((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="p">(</span><span class="n">sz</span><span class="p">))</span> <span class="o">&gt;&gt;</span> <span class="mi">6</span><span class="p">)</span>                                  \

         <span class="o">:</span> <span class="p">((((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="p">(</span><span class="n">sz</span><span class="p">))</span> <span class="o">&gt;&gt;</span> <span class="mi">9</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">20</span><span class="p">)</span>                               \

               <span class="o">?</span> <span class="mi">91</span> <span class="o">+</span> <span class="p">(((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="p">(</span><span class="n">sz</span><span class="p">))</span> <span class="o">&gt;&gt;</span> <span class="mi">9</span><span class="p">)</span>                            \

               <span class="o">:</span> <span class="p">((((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="p">(</span><span class="n">sz</span><span class="p">))</span> <span class="o">&gt;&gt;</span> <span class="mi">12</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">10</span><span class="p">)</span>                        \

                     <span class="o">?</span> <span class="mi">110</span> <span class="o">+</span> <span class="p">(((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="p">(</span><span class="n">sz</span><span class="p">))</span> <span class="o">&gt;&gt;</span> <span class="mi">12</span><span class="p">)</span>                    \

                     <span class="o">:</span> <span class="p">((((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="p">(</span><span class="n">sz</span><span class="p">))</span> <span class="o">&gt;&gt;</span> <span class="mi">15</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">4</span><span class="p">)</span>                   \

                           <span class="o">?</span> <span class="mi">119</span> <span class="o">+</span> <span class="p">(((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="p">(</span><span class="n">sz</span><span class="p">))</span> <span class="o">&gt;&gt;</span> <span class="mi">15</span><span class="p">)</span>              \

                           <span class="o">:</span> <span class="p">((((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="p">(</span><span class="n">sz</span><span class="p">))</span> <span class="o">&gt;&gt;</span> <span class="mi">18</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">2</span><span class="p">)</span>             \

                                 <span class="o">?</span> <span class="mi">124</span> <span class="o">+</span> <span class="p">(((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="p">(</span><span class="n">sz</span><span class="p">))</span> <span class="o">&gt;&gt;</span> <span class="mi">18</span><span class="p">)</span>        \

                                 <span class="o">:</span> <span class="mi">126</span><span class="p">)</span>



<span class="cp">#define largebin_index(sz)                                                     \</span>

    <span class="p">(</span><span class="n">SIZE_SZ</span> <span class="o">==</span> <span class="mi">8</span> <span class="o">?</span> <span class="n">largebin_index_64</span><span class="p">(</span><span class="n">sz</span><span class="p">)</span> <span class="o">:</span> <span class="n">MALLOC_ALIGNMENT</span> <span class="o">==</span> <span class="mi">16</span>             \

                                                <span class="o">?</span> <span class="n">largebin_index_32_big</span><span class="p">(</span><span class="n">sz</span><span class="p">)</span>    \

                                                <span class="o">:</span> <span class="n">largebin_index_32</span><span class="p">(</span><span class="n">sz</span><span class="p">))</span>
</code></pre></div>

<h4 id="unsorted-bin">Unsorted Bin<a class="headerlink" href="#unsorted-bin" title="Permanent link">&para;</a></h4>
<p>Unsorted bin can be thought of as a buffer before the free chunk returns to its own bin.</p>
<p>Its specific description in glibc is as follows</p>
<div class="codehilite"><pre><span></span><code><span class="cm">/*</span>

<span class="cm">   Unsorted chunks</span>



<span class="cm">    All remainders from chunk splits, as well as all returned chunks,</span>

<span class="cm">    are first placed in the &quot;unsorted&quot; bin. They are then placed</span>

<span class="cm">    in regular bins after malloc gives them ONE chance to be used before</span>

<span class="cm">    binning. So, basically, the unsorted_chunks list acts as a queue,</span>

<span class="cm">    with chunks being placed on it in free (and malloc_consolidate),</span>

<span class="cm">    and taken off (to be either used or placed in bins) in malloc.</span>



<span class="cm">    The NON_MAIN_ARENA flag is never set for unsorted chunks, so it</span>

<span class="cm">    does not have to be taken into account in size comparisons.</span>

<span class="cm"> */</span>
</code></pre></div>

<p>From the macro below we can see</p>
<div class="codehilite"><pre><span></span><code><span class="cm">/* The otherwise unindexable 1-bin is used to hold unsorted chunks. */</span>

<span class="cp">#define unsorted_chunks(M) (bin_at(M, 1))</span>
</code></pre></div>

<p>The unsorted bin is at the subscript 1 of the bin array we mentioned earlier. Therefore, the unsorted bin has only one linked list. Idle chunks in unsorted bin are out of order, with two main sources</p>
<ul>
<li>When a larger chunk is split into two halves, if the rest is greater than MINSIZE, it will be placed in the unsorted bin.</li>
<li>When a chunk that does not belong to the fast bin is released, and the chunk is not in close proximity to the top chunk, the chunk is first placed in the unsorted bin. For an explanation of the top chunk, please refer to the introduction below.</li>
</ul>
<p>In addition, the traversal order used by Unsorted Bin during the process is FIFO.</p>
<h4 id="common-macro">common macro<a class="headerlink" href="#common-macro" title="Permanent link">&para;</a></h4>
<p>Here are some general macros.</p>
<p><strong>Unified to get the index of the chunk according to the size of the chunk</strong></p>
<div class="codehilite"><pre><span></span><code><span class="cp">#define bin_index(sz)                                                          \</span>

    <span class="p">((</span><span class="n">in_smallbin_range</span><span class="p">(</span><span class="n">sz</span><span class="p">))</span> <span class="o">?</span> <span class="n">smallbin_index</span><span class="p">(</span><span class="n">sz</span><span class="p">)</span> <span class="o">:</span> <span class="n">largebin_index</span><span class="p">(</span><span class="n">sz</span><span class="p">))</span>
</code></pre></div>

<h3 id="top-chunk">Top Chunk<a class="headerlink" href="#top-chunk" title="Permanent link">&para;</a></h3>
<p>The description of top chunk in glibc is as follows</p>
<div class="codehilite"><pre><span></span><code><span class="cm">/*</span>

<span class="cm">   Top</span>



<span class="cm">    The top-most available chunk (i.e., the one bordering the end of</span>

<span class="cm">    available memory) is treated specially. It is never included in</span>

<span class="cm">    any bin, is used only if no other chunk is available, and is</span>

<span class="cm">    released back to the system if it is very large (see</span>

<span class="cm">    M_TRIM_THRESHOLD).  Because top initially</span>

<span class="cm">    points to its own bin with initial zero size, thus forcing</span>

<span class="cm">    extension on the first malloc request, we avoid having any special</span>

<span class="cm">    code in malloc to check whether it even exists yet. But we still</span>

<span class="cm">    need to do so when getting memory from system, so we make</span>
<span class="cm">    initial_top treat the bin as a legal but unusable chunk during the</span>

<span class="cm">    interval between initialization and the first call to</span>

<span class="cm">    sysmalloc. (This is somewhat delicate, since it relies on</span>

<span class="cm">    the 2 preceding words to be zero during this interval as well.)</span>

<span class="cm"> */</span>



<span class="cm">/* Conveniently, the unsorted bin can be used as dummy top on first call */</span>

<span class="cp">#define initial_top(M) (unsorted_chunks(M))</span>
</code></pre></div>

<p>When the program first performs malloc, the heap is divided into two pieces, one for the user, and the remaining one is the top chunk. In fact, the so-called top chunk is the chunk with the highest physical address in the current heap. This chunk does not belong to any bin. Its function is to allocate all the bins if they are not up to the specified size. If the size is not less than the specified size, the allocation is made and the remaining part is used as the new top chunk. Otherwise, the heap is expanded and then allocated. The heap is extended by sbrk in the main arena, and the new heap is allocated by the mmap in the thread arena.</p>
<p>It should be noted that the prev_inuse bit of the top chunk is always 1, otherwise the previous chunk will be merged into the top chunk.</p>
<p><strong> In the initial case, we can use the unsorted chunk as the top chunk. </strong></p>
<h3 id="last-remainder">last remainder<a class="headerlink" href="#last-remainder" title="Permanent link">&para;</a></h3>
<p>When a user uses malloc to request memory allocation, the chunk found by ptmalloc2 may not match the size of the requested memory. In this case, the remaining portion after the split is called the last remainder chunk, and the unsort bin will also store the chunk. The top chunk splits the rest of the section as a last remainder.</p>
<h2 id="macrostructure">Macrostructure<a class="headerlink" href="#macrostructure" title="Permanent link">&para;</a></h2>
<h3 id="arena">arena<a class="headerlink" href="#arena" title="Permanent link">&para;</a></h3>
<p>In the example we introduced earlier, whether it is the main thread or the newly created thread, there will be a separate arena when applying for memory for the first time. So will each thread have an independent arena? Below we will introduce in detail.</p>
<h4 id="arena-quantity">arena Quantity<a class="headerlink" href="#arena-quantity" title="Permanent link">&para;</a></h4>
<p>For different systems, the [constraints] of the number of arena (<a href="https://github.com/sploitfun/lsploits/blob/master/glibc/malloc/arena.c#L847">https://github.com/sploitfun/lsploits/blob/master/glibc/malloc/arena.c#L847</a>) are as follows</p>
<div class="codehilite"><pre><span></span><code>For 32 bit systems:

     Number of arena = 2 * number of cores.

For 64 bit systems:

     Number of arena = 8 * number of cores.
</code></pre></div>

<p>Obviously, not every thread will have a corresponding arena. As for why the 64-bit system is set up, I don't want to understand it. In addition, because the number of cores per system is limited, when the number of threads is more than twice the number of cores (hyperthreading technology), there must be threads waiting, so there is no need to assign an arena to each thread.</p>
<h4 id="arena-distribution-rules">arena Distribution Rules<a class="headerlink" href="#arena-distribution-rules" title="Permanent link">&para;</a></h4>
<p><strong>To be added. </strong></p>
<h4 id="the-difference">the difference<a class="headerlink" href="#the-difference" title="Permanent link">&para;</a></h4>
<p>Unlike thread, main_arena is not in the applied heap, but a global variable in the data segment of libc.so.</p>
<h3 id="heap_info">heap_info<a class="headerlink" href="#heap_info" title="Permanent link">&para;</a></h3>
<p>When the program first starts executing, each thread has no heap area. When it applies for memory, it needs a structure to record the corresponding information, and the role of heap_info is this. And when the resources of the heap are used, you must apply for memory again. In addition, the generally applied heap is not continuous, so it is necessary to record the link structure between different heaps.</p>
<p><strong>This data structure is specifically prepared for memory requested from the Memory Mapping Segment, which is prepared for non-primary threads. </strong></p>
<p>The main thread can be extended by the program break location via the sbrk() function (until it touches the Memory Mapping Segment), with only one heap and no heap_info data structure.</p>
<p>The main structure of heap_info is as follows</p>
<div class="codehilite"><pre><span></span><code><span class="cp">#define HEAP_MIN_SIZE (32 * 1024)</span>

<span class="cp">#ifndef HEAP_MAX_SIZE</span>

<span class="cp"># ifdef DEFAULT_MMAP_THRESHOLD_MAX</span>

<span class="cp">#  define HEAP_MAX_SIZE (2 * DEFAULT_MMAP_THRESHOLD_MAX)</span>

<span class="cp"># else</span>

<span class="cp">#  define HEAP_MAX_SIZE (1024 * 1024) </span><span class="cm">/* must be a power of two */</span><span class="cp"></span>

<span class="cp"># endif</span>
<span class="cp">#endif</span>


<span class="cm">/* HEAP_MIN_SIZE and HEAP_MAX_SIZE limit the size of mmap()ed heaps</span>

<span class="cm">   that are dynamically created for multi-threaded programs.  The</span>

<span class="cm">   maximum size must be a power of two, for fast determination of</span>

<span class="cm">   which heap belongs to a chunk.  It should be much larger than the</span>

<span class="cm">   mmap threshold, so that requests with a size just below that</span>

<span class="cm">   threshold can be fulfilled without creating too many heaps.  */</span>



<span class="cm">/***************************************************************************/</span>



<span class="cm">/* A heap is a single contiguous memory region holding (coalesceable)</span>

<span class="cm">   malloc_chunks.  It is allocated with mmap() and always starts at an</span>

<span class="cm">   address aligned to HEAP_MAX_SIZE.  */</span>



<span class="k">typedef</span> <span class="k">struct</span> <span class="n">_heap_info</span>

<span class="p">{</span>

  <span class="n">mstate</span> <span class="n">ar_ptr</span><span class="p">;</span> <span class="cm">/* Arena for this heap. */</span>

  <span class="k">struct</span> <span class="n">_heap_info</span> <span class="o">*</span><span class="n">prev</span><span class="p">;</span> <span class="cm">/* Previous heap. */</span>

  <span class="kt">size_t</span> <span class="n">size</span><span class="p">;</span>   <span class="cm">/* Current size in bytes. */</span>

  <span class="kt">size_t</span> <span class="n">mprotect_size</span><span class="p">;</span> <span class="cm">/* Size in bytes that has been mprotected</span>

<span class="cm">                           PROT_READ|PROT_WRITE.  */</span>

  <span class="cm">/* Make sure the following data is properly aligned, particularly</span>

<span class="cm">     that sizeof (heap_info) + 2 * SIZE_SZ is a multiple of</span>

<span class="cm">     MALLOC_ALIGNMENT. */</span>

  <span class="kt">char</span> <span class="n">pad</span><span class="p">[</span><span class="o">-</span><span class="mi">6</span> <span class="o">*</span> <span class="n">SIZE_SZ</span> <span class="o">&amp;</span> <span class="n">MALLOC_ALIGN_MASK</span><span class="p">];</span>

<span class="p">}</span> <span class="n">heap_info</span><span class="p">;</span>
</code></pre></div>

<p>This structure is mainly to describe the basic information of the heap, including</p>
<ul>
<li>the address of the corresponding arena of the heap</li>
<li>Since a thread requests a heap, it may be used up and must be applied again. Therefore, one thread may have multiple heaps. Prev records the address of the last heap_info. Here you can see that each heap's heap_info is linked through a singly linked list.</li>
<li>size indicates the size of the current heap</li>
<li>The last part ensures alignment (<strong>What is the reason for the negative use here?</strong>)</li>
</ul>
<p>It seems that the structure should be quite important, but if we look closely at the implementation of the full malloc, we will find that it does not appear frequently.</p>
<h3 id="malloc_state">malloc_state<a class="headerlink" href="#malloc_state" title="Permanent link">&para;</a></h3>
<p>This structure is used to manage the heap and record the specific state of the memory of each arena's current application, such as whether there are free chunks, what size of free chunks, and so on. Whether it is thread arena or main arena, they all have only one malloc state structure. Since there may be more than one of the thread's arena, the malloc state structure will be in the latest application's arena.</p>
<p><strong>Note that the main arena's malloc_state is not part of the heap segment, but a global variable stored in the libc.so data segment. </strong></p>
<p>Its structure is as follows</p>
<div class="codehilite"><pre><span></span><code><span class="k">struct</span> <span class="n">malloc_state</span> <span class="p">{</span>

    <span class="cm">/* Serialize access.  */</span>

    <span class="n">__libc_lock_define</span><span class="p">(,</span> <span class="n">mutex</span><span class="p">);</span>



    <span class="cm">/* Flags (formerly in max_fast).  */</span>

    <span class="kt">int</span> <span class="n">flags</span><span class="p">;</span>



    <span class="cm">/* Fastbins */</span>

    <span class="n">mfastbinptr</span> <span class="n">fastbinsY</span><span class="p">[</span> <span class="n">NFASTBINS</span> <span class="p">];</span>



    <span class="cm">/* Base of the topmost chunk -- not otherwise kept in a bin */</span>

    <span class="n">mchunkptr</span> <span class="n">top</span><span class="p">;</span>



    <span class="cm">/* The remainder from the most recent split of a small request */</span>

    <span class="n">mchunkptr</span> <span class="n">last_remainder</span><span class="p">;</span>


    <span class="cm">/* Normal bins packed as described above */</span>

    <span class="n">mchunkptr</span> <span class="n">bins</span><span class="p">[</span> <span class="n">NBINS</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">-</span> <span class="mi">2</span> <span class="p">];</span>



    <span class="cm">/* Bitmap of bins, help to speed up the process of determinating if a given bin is definitely empty.*/</span>

    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">binmap</span><span class="p">[</span> <span class="n">BINMAPSIZE</span> <span class="p">];</span>



    <span class="cm">/* Linked list, points to the next arena */</span>

    <span class="k">struct</span> <span class="n">malloc_state</span> <span class="o">*</span><span class="n">next</span><span class="p">;</span>



    <span class="cm">/* Linked list for free arenas.  Access to this field is serialized</span>

<span class="cm">       by free_list_lock in arena.c.  */</span>

    <span class="k">struct</span> <span class="n">malloc_state</span> <span class="o">*</span><span class="n">next_free</span><span class="p">;</span>



    <span class="cm">/* Number of threads attached to this arena.  0 if the arena is on</span>

<span class="cm">       the free list.  Access to this field is serialized by</span>

<span class="cm">       free_list_lock in arena.c.  */</span>

    <span class="n">INTERNAL_SIZE_T</span> <span class="n">attached_threads</span><span class="p">;</span>



    <span class="cm">/* Memory allocated from the system in this arena.  */</span>

    <span class="n">INTERNAL_SIZE_T</span> <span class="n">system_mem</span><span class="p">;</span>

    <span class="n">INTERNAL_SIZE_T</span> <span class="n">max_system_mem</span><span class="p">;</span>

<span class="p">};</span>
</code></pre></div>

<ul>
<li>
<p>__libc_lock_define(, mutex);</p>
</li>
<li>
<p>This variable is used to control the serial access of the program to the same allocation area. When a thread acquires the allocation area, other threads must wait for the thread allocation to complete before they can access the allocation area.</p>
</li>
<li>
<p>flags</p>
</li>
<li>
<p>flags records some flags of the allocation area. For example, bit0 records whether the allocation area has a fast bin chunk, and bit1 identifies whether the allocation area can return a continuous virtual address space. details as follows</p>
</li>
</ul>
<div class="codehilite"><pre><span></span><code><span class="cm">/*</span>

<span class="cm">   FASTCHUNKS_BIT held in max_fast indicates that there are probably</span>

<span class="cm">   some fastbin chunks. It is set true on entering a chunk into any</span>

<span class="cm">   fastbin, and cleared only in malloc_consolidate.</span>

<span class="cm">   The truth value is inverted so that have_fastchunks will be true</span>

<span class="cm">   upon startup (since statics are zero-filled), simplifying</span>

<span class="cm">   initialization checks.</span>

<span class="cm"> */</span>



<span class="cp">#define FASTCHUNKS_BIT (1U)</span>



<span class="cp">#define have_fastchunks(M) (((M)-&gt;flags &amp; FASTCHUNKS_BIT) == 0)</span>

<span class="cp">#define clear_fastchunks(M) catomic_or(&amp;(M)-&gt;flags, FASTCHUNKS_BIT)</span>

<span class="cp">#define set_fastchunks(M) catomic_and(&amp;(M)-&gt;flags, ~FASTCHUNKS_BIT)</span>



<span class="cm">/*</span>

<span class="cm">   NONCONTIGUOUS_BIT indicates that MORECORE does not return contiguous</span>

<span class="cm">   regions.  Otherwise, contiguity is exploited in merging together,</span>

<span class="cm">   when possible, results from consecutive MORECORE calls.</span>

<span class="cm">   The initial value comes from MORECORE_CONTIGUOUS, but is</span>

<span class="cm">   changed dynamically if mmap is ever used as an sbrk substitute.</span>

<span class="cm"> */</span>



<span class="cp">#define NONCONTIGUOUS_BIT (2U)</span>



<span class="cp">#define contiguous(M) (((M)-&gt;flags &amp; NONCONTIGUOUS_BIT) == 0)</span>

<span class="cp">#define noncontiguous(M) (((M)-&gt;flags &amp; NONCONTIGUOUS_BIT) != 0)</span>

<span class="cp">#define set_noncontiguous(M) ((M)-&gt;flags |= NONCONTIGUOUS_BIT)</span>

<span class="cp">#define set_contiguous(M) ((M)-&gt;flags &amp;= ~NONCONTIGUOUS_BIT)</span>



<span class="cm">/* ARENA_CORRUPTION_BIT is set if a memory corruption was detected on the</span>

<span class="cm">   arena.  Such an arena is no longer used to allocate chunks.  Chunks</span>

<span class="cm">   allocated in that arena before detecting corruption are not freed.  */</span>



<span class="cp">#define ARENA_CORRUPTION_BIT (4U)</span>



<span class="cp">#define arena_is_corrupt(A) (((A)-&gt;flags &amp; ARENA_CORRUPTION_BIT))</span>

<span class="cp">#define set_arena_corrupt(A) ((A)-&gt;flags |= ARENA_CORRUPTION_BIT)</span>
</code></pre></div>

<ul>
<li>
<p>fastbinsY[NFASTBINS]</p>
</li>
<li>
<p>a pointer to the head of each fast chunk list</p>
</li>
<li>
<p>top</p>
</li>
<li>
<p>Point to the top chunk of the allocation area</p>
</li>
<li>
<p>last_reminder</p>
</li>
<li>
<p>The remaining part after the latest chunk split</p>
</li>
<li>
<p>bins</p>
</li>
<li>
<p>A chunk list for storing unstored bins, small bins and large bins.</p>
</li>
<li>
<p>binmap</p>
</li>
<li>
<p>ptmalloc uses a bit to identify whether a bin contains free chunks.</p>
</li>
</ul>
<h3 id="malloc_par">malloc_par<a class="headerlink" href="#malloc_par" title="Permanent link">&para;</a></h3>
<p><strong>! ! To be added! ! </strong></p>









  <h2 id="__comments">评论</h2>
  <div id="disqus_thread"></div>
  <script>
    var disqus_config = function () {
      this.page.url = "https://ctf-wiki.github.io/ctf-wiki/pwn/linux/glibc-heap/heap_structure/";
      this.page.identifier =
        "pwn/linux/glibc-heap/heap_structure/";
    };
    (function() {
      var d = document, s = d.createElement("script");
      s.src = "//ctf-wiki.disqus.com/embed.js";
      s.setAttribute("data-timestamp", +new Date());
      (d.head || d.body).appendChild(s);
    })();
  </script>


            </article>
          </div>
        </div>
      </main>


<footer class="md-footer">

  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">

          <div class="md-footer-copyright__highlight">
            Copyright &copy; 2016 - 2020 CTF Wiki Team
          </div>

        powered by
        <a href="https://www.mkdocs.org" target="_blank" rel="noopener">MkDocs</a>
        and
        <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
          Material for MkDocs</a>
      </div>

    </div>
  </div>
</footer>

    </div>

      <script src="../../../../assets/javascripts/application.c33a9706.js"></script>




          <script src="../../../../assets/javascripts/lunr/lunr.stemmer.support.js"></script>









      <script>app.initialize({version:"1.0.4",url:{base:"../../../.."}})</script>

        <script src="https://cdnjs.loli.net/ajax/libs/pangu/3.3.0/pangu.min.js"></script>

        <script src="../../../../_static/js/extra.js"></script>

        <script src="https://cdnjs.loli.net/ajax/libs/mathjax/2.7.2/MathJax.js?config=TeX-MML-AM_CHTML"></script>


  </body>
</html>
