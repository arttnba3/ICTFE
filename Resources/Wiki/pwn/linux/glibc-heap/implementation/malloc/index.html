



<!doctype html>
<html lang="zh" class="no-js">
  <head>

      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <meta http-equiv="x-ua-compatible" content="ie=edge">

        <meta name="description" content="CTF Wiki">


        <link rel="canonical" href="https://ctf-wiki.github.io/ctf-wiki/pwn/linux/glibc-heap/implementation/malloc/">


        <meta name="author" content="CTF Wiki Team">


        <meta name="lang:clipboard.copy" content="复制">

        <meta name="lang:clipboard.copied" content="已复制">

        <meta name="lang:search.language" content="jp">

        <meta name="lang:search.pipeline.stopwords" content="True">

        <meta name="lang:search.pipeline.trimmer" content="True">

        <meta name="lang:search.result.none" content="没有找到符合条件的结果">

        <meta name="lang:search.result.one" content="找到 1 个符合条件的结果">

        <meta name="lang:search.result.other" content="# 个符合条件的结果">

        <meta name="lang:search.tokenizer" content="[\uff0c\u3002]+">

      <link rel="shortcut icon" href="../../../../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.0.4, mkdocs-material-4.6.2">



        <title>Malloc - CTF Wiki</title>



      <link rel="stylesheet" href="../../../../../assets/stylesheets/application.adb8469c.css">

        <link rel="stylesheet" href="../../../../../assets/stylesheets/application-palette.a8b3c06d.css">




        <meta name="theme-color" content="">



      <script src="../../../../../assets/javascripts/modernizr.86422ebf.js"></script>



        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Noto+Sans:300,400,400i,700%7CSource+Code+Pro&display=fallback">
        <style>body,input{font-family:"Noto Sans","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Source Code Pro","Courier New",Courier,monospace}</style>


    <link rel="stylesheet" href="../../../../../assets/fonts/material-icons.css">


      <link rel="stylesheet" href="../../../../../stylesheets/dark_theme.css">

      <link rel="stylesheet" href="../../../../../stylesheets/codehilite.css">

      <link rel="stylesheet" href="../../../../../_static/css/extra.css">





<meta name="theme-color" content="#212121">

<link rel='icon' href='/assets/images/favicon.ico'>

<meta name='apple-mobile-web-app-capable' content='yes'>
<meta name='mobile-web-app-capable' content='yes'>
<link rel="manifest" href="/manifest.json">

  </head>



    <body dir="ltr" data-md-color-primary="blue" data-md-color-accent="red">

    <svg class="md-svg">
      <defs>


          <svg xmlns="http://www.w3.org/2000/svg" width="416" height="448" viewBox="0 0 416 448" id="__github"><path fill="currentColor" d="M160 304q0 10-3.125 20.5t-10.75 19T128 352t-18.125-8.5-10.75-19T96 304t3.125-20.5 10.75-19T128 256t18.125 8.5 10.75 19T160 304zm160 0q0 10-3.125 20.5t-10.75 19T288 352t-18.125-8.5-10.75-19T256 304t3.125-20.5 10.75-19T288 256t18.125 8.5 10.75 19T320 304zm40 0q0-30-17.25-51T296 232q-10.25 0-48.75 5.25Q229.5 240 208 240t-39.25-2.75Q130.75 232 120 232q-29.5 0-46.75 21T56 304q0 22 8 38.375t20.25 25.75 30.5 15 35 7.375 37.25 1.75h42q20.5 0 37.25-1.75t35-7.375 30.5-15 20.25-25.75T360 304zm56-44q0 51.75-15.25 82.75-9.5 19.25-26.375 33.25t-35.25 21.5-42.5 11.875-42.875 5.5T212 416q-19.5 0-35.5-.75t-36.875-3.125-38.125-7.5-34.25-12.875T37 371.5t-21.5-28.75Q0 312 0 260q0-59.25 34-99-6.75-20.5-6.75-42.5 0-29 12.75-54.5 27 0 47.5 9.875t47.25 30.875Q171.5 96 212 96q37 0 70 8 26.25-20.5 46.75-30.25T376 64q12.75 25.5 12.75 54.5 0 21.75-6.75 42 34 40 34 99.5z"/></svg>

      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" data-md-component="overlay" for="__drawer"></label>

      <a href="#apply-for-a-memory-block" tabindex="0" class="md-skip">
        跳转至
      </a>


      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex">
      <div class="md-flex__cell md-flex__cell--shrink">
        <a href="https://ctf-wiki.github.io/ctf-wiki/" title="CTF Wiki" aria-label="CTF Wiki" class="md-header-nav__button md-logo">

            <i class="md-icon">school</i>

        </a>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="__drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">

            <span class="md-header-nav__topic">
              CTF Wiki
            </span>
            <span class="md-header-nav__topic">

                Malloc

            </span>

        </div>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">

          <label class="md-icon md-icon--search md-header-nav__button" for="__search"></label>

<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" aria-label="search" name="query" placeholder="搜索" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query" data-md-state="active">
      <label class="md-icon md-search__icon" for="__search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">
        &#xE5CD;
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result">
          <div class="md-search-result__meta">
            键入以开始搜索
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>

      </div>

        <div class="md-flex__cell md-flex__cell--shrink">
          <div class="md-header-nav__source">





<a href="https://github.com/ctf-wiki/ctf-wiki/" title="前往 Github 仓库" class="md-source" data-md-source="github">

    <div class="md-source__icon">
      <svg viewBox="0 0 24 24" width="24" height="24">
        <use xlink:href="#__github" width="24" height="24"></use>
      </svg>
    </div>

  <div class="md-source__repository">
    ctf-wiki/ctf-wiki
  </div>
</a>
          </div>
        </div>

    </div>
  </nav>
</header>

    <div class="md-container">






<nav class="md-tabs" data-md-component="tabs">
  <div class="md-tabs__inner md-grid">
    <ul class="md-tabs__list">




    <li class="md-tabs__item">

        <a href="../../../../.." class="md-tabs__link">
          Introduction
        </a>

    </li>






    <li class="md-tabs__item">

        <a href="../../../../../misc/introduction-zh/" class="md-tabs__link">
          Misc
        </a>

    </li>






    <li class="md-tabs__item">

        <a href="../../../../../crypto/introduction-zh/" class="md-tabs__link">
          Crypto
        </a>

    </li>






    <li class="md-tabs__item">

        <a href="../../../../../web/introduction-zh/" class="md-tabs__link">
          Web
        </a>

    </li>






    <li class="md-tabs__item">

        <a href="../../../../../assembly/x86-x64/readme-zh/" class="md-tabs__link">
          Assembly
        </a>

    </li>










    <li class="md-tabs__item">

        <a href="../../../../../executable/elf/elf-structure-zh/" class="md-tabs__link">
          Executable
        </a>

    </li>












    <li class="md-tabs__item">

        <a href="../../../../../reverse/introduction-zh/" class="md-tabs__link">
          Reverse Engineering
        </a>

    </li>












    <li class="md-tabs__item">

        <a href="../../../../readme-zh/" class="md-tabs__link">
          Pwn
        </a>

    </li>








    <li class="md-tabs__item">

        <a href="../../../../../android/basic_develop/basic_develop-zh/" class="md-tabs__link">
          Android
        </a>

    </li>






    <li class="md-tabs__item">

        <a href="../../../../../ics/ctfs-zh/" class="md-tabs__link">
          ICS
        </a>

    </li>



    </ul>
  </div>
</nav>

      <main class="md-main" role="main">
        <div class="md-main__inner md-grid" data-md-component="container">


              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="__drawer">
    <a href="https://ctf-wiki.github.io/ctf-wiki/" title="CTF Wiki" class="md-nav__button md-logo">

        <i class="md-icon">school</i>

    </a>
    CTF Wiki
  </label>

    <div class="md-nav__source">





<a href="https://github.com/ctf-wiki/ctf-wiki/" title="前往 Github 仓库" class="md-source" data-md-source="github">

    <div class="md-source__icon">
      <svg viewBox="0 0 24 24" width="24" height="24">
        <use xlink:href="#__github" width="24" height="24"></use>
      </svg>
    </div>

  <div class="md-source__repository">
    ctf-wiki/ctf-wiki
  </div>
</a>
    </div>

  <ul class="md-nav__list" data-md-scrollfix>






  <li class="md-nav__item md-nav__item--nested">

      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-1" type="checkbox" id="nav-1">

    <label class="md-nav__link" for="nav-1">
      Introduction
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-1">
        Introduction
      </label>
      <ul class="md-nav__list" data-md-scrollfix>







  <li class="md-nav__item">
    <a href="../../../../.." title="Getting Started" class="md-nav__link">
      Getting Started
    </a>
  </li>







  <li class="md-nav__item">
    <a href="../../../../../introduction/history-zh/" title="CTF History" class="md-nav__link">
      CTF History
    </a>
  </li>







  <li class="md-nav__item">
    <a href="../../../../../introduction/mode-zh/" title="Introduction to CTF Competition Form" class="md-nav__link">
      Introduction to CTF Competition Form
    </a>
  </li>







  <li class="md-nav__item">
    <a href="../../../../../introduction/content-zh/" title="CTF Contest Content" class="md-nav__link">
      CTF Contest Content
    </a>
  </li>







  <li class="md-nav__item">
    <a href="../../../../../introduction/experience-zh/" title="Offline Attack and Defense Experience Summary" class="md-nav__link">
      Offline Attack and Defense Experience Summary
    </a>
  </li>







  <li class="md-nav__item">
    <a href="../../../../../introduction/cgc-zh/" title="CGC Super Challenge" class="md-nav__link">
      CGC Super Challenge
    </a>
  </li>







  <li class="md-nav__item">
    <a href="../../../../../introduction/resources-zh/" title="Learning Resources" class="md-nav__link">
      Learning Resources
    </a>
  </li>


      </ul>
    </nav>
  </li>







  <li class="md-nav__item md-nav__item--nested">

      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-2" type="checkbox" id="nav-2">

    <label class="md-nav__link" for="nav-2">
      Misc
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-2">
        Misc
      </label>
      <ul class="md-nav__list" data-md-scrollfix>







  <li class="md-nav__item">
    <a href="../../../../../misc/introduction-zh/" title="Miscellaneous Introduction" class="md-nav__link">
      Miscellaneous Introduction
    </a>
  </li>







  <li class="md-nav__item">
    <a href="../../../../../misc/recon-zh/" title="Information Gathering Technology" class="md-nav__link">
      Information Gathering Technology
    </a>
  </li>







  <li class="md-nav__item md-nav__item--nested">

      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-2-3" type="checkbox" id="nav-2-3">

    <label class="md-nav__link" for="nav-2-3">
      Code Analysis
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-2-3">
        Code Analysis
      </label>
      <ul class="md-nav__list" data-md-scrollfix>







  <li class="md-nav__item">
    <a href="../../../../../misc/encode/communication-zh/" title="Commonly Used Coding in the Communication Field" class="md-nav__link">
      Commonly Used Coding in the Communication Field
    </a>
  </li>







  <li class="md-nav__item">
    <a href="../../../../../misc/encode/computer-zh/" title="Computer Related Coding" class="md-nav__link">
      Computer Related Coding
    </a>
  </li>







  <li class="md-nav__item">
    <a href="../../../../../misc/encode/modern-zh/" title="Commonly Used Encodings in the Real World" class="md-nav__link">
      Commonly Used Encodings in the Real World
    </a>
  </li>


      </ul>
    </nav>
  </li>







  <li class="md-nav__item">
    <a href="../../../../../misc/prefix-zh/" title="Forensic Steganography" class="md-nav__link">
      Forensic Steganography
    </a>
  </li>







  <li class="md-nav__item md-nav__item--nested">

      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-2-5" type="checkbox" id="nav-2-5">

    <label class="md-nav__link" for="nav-2-5">
      Image Analysis
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-2-5">
        Image Analysis
      </label>
      <ul class="md-nav__list" data-md-scrollfix>







  <li class="md-nav__item">
    <a href="../../../../../misc/picture/introduction-zh/" title="Introduction to Image Analysis" class="md-nav__link">
      Introduction to Image Analysis
    </a>
  </li>







  <li class="md-nav__item">
    <a href="../../../../../misc/picture/png-zh/" title="PNG" class="md-nav__link">
      PNG
    </a>
  </li>







  <li class="md-nav__item">
    <a href="../../../../../misc/picture/jpg-zh/" title="JPG" class="md-nav__link">
      JPG
    </a>
  </li>







  <li class="md-nav__item">
    <a href="../../../../../misc/picture/gif-zh/" title="GIF" class="md-nav__link">
      GIF
    </a>
  </li>


      </ul>
    </nav>
  </li>







  <li class="md-nav__item md-nav__item--nested">

      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-2-6" type="checkbox" id="nav-2-6">

    <label class="md-nav__link" for="nav-2-6">
      Traffic Packet Analysis
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-2-6">
        Traffic Packet Analysis
      </label>
      <ul class="md-nav__list" data-md-scrollfix>







  <li class="md-nav__item">
    <a href="../../../../../misc/traffic/introduction-zh/" title="Introduction to Traffic Packet Analysis" class="md-nav__link">
      Introduction to Traffic Packet Analysis
    </a>
  </li>







  <li class="md-nav__item">
    <a href="../../../../../misc/traffic/fix-zh/" title="PCAP File Repairing" class="md-nav__link">
      PCAP File Repairing
    </a>
  </li>







  <li class="md-nav__item md-nav__item--nested">

      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-2-6-3" type="checkbox" id="nav-2-6-3">

    <label class="md-nav__link" for="nav-2-6-3">
      Protocol Analysis
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="3">
      <label class="md-nav__title" for="nav-2-6-3">
        Protocol Analysis
      </label>
      <ul class="md-nav__list" data-md-scrollfix>







  <li class="md-nav__item">
    <a href="../../../../../misc/traffic/protocols/README-zh/" title="Overview of Protocol Analysis" class="md-nav__link">
      Overview of Protocol Analysis
    </a>
  </li>







  <li class="md-nav__item">
    <a href="../../../../../misc/traffic/protocols/Wireshark-zh/" title="Wireshark" class="md-nav__link">
      Wireshark
    </a>
  </li>







  <li class="md-nav__item">
    <a href="../../../../../misc/traffic/protocols/HTTP-zh/" title="HTTP" class="md-nav__link">
      HTTP
    </a>
  </li>







  <li class="md-nav__item">
    <a href="../../../../../misc/traffic/protocols/HTTPS-zh/" title="HTTPS" class="md-nav__link">
      HTTPS
    </a>
  </li>







  <li class="md-nav__item">
    <a href="../../../../../misc/traffic/protocols/FTP-zh/" title="FTP" class="md-nav__link">
      FTP
    </a>
  </li>







  <li class="md-nav__item">
    <a href="../../../../../misc/traffic/protocols/DNS-zh/" title="DNS" class="md-nav__link">
      DNS
    </a>
  </li>







  <li class="md-nav__item">
    <a href="../../../../../misc/traffic/protocols/WIFI-zh/" title="WIFI" class="md-nav__link">
      WIFI
    </a>
  </li>







  <li class="md-nav__item">
    <a href="../../../../../misc/traffic/protocols/USB-zh/" title="USB" class="md-nav__link">
      USB
    </a>
  </li>


      </ul>
    </nav>
  </li>







  <li class="md-nav__item">
    <a href="../../../../../misc/traffic/data-zh/" title="Data Extraction" class="md-nav__link">
      Data Extraction
    </a>
  </li>


      </ul>
    </nav>
  </li>







  <li class="md-nav__item md-nav__item--nested">

      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-2-7" type="checkbox" id="nav-2-7">

    <label class="md-nav__link" for="nav-2-7">
      Compressed Package Analysis
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-2-7">
        Compressed Package Analysis
      </label>
      <ul class="md-nav__list" data-md-scrollfix>







  <li class="md-nav__item">
    <a href="../../../../../misc/archive/zip-zh/" title="ZIP Format" class="md-nav__link">
      ZIP Format
    </a>
  </li>







  <li class="md-nav__item">
    <a href="../../../../../misc/archive/rar-zh/" title="RAR Format" class="md-nav__link">
      RAR Format
    </a>
  </li>


      </ul>
    </nav>
  </li>







  <li class="md-nav__item">
    <a href="../../../../../misc/audio/introduction-zh/" title="Audio Steganography" class="md-nav__link">
      Audio Steganography
    </a>
  </li>







  <li class="md-nav__item md-nav__item--nested">

      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-2-9" type="checkbox" id="nav-2-9">

    <label class="md-nav__link" for="nav-2-9">
      Disk Memory Analysis
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-2-9">
        Disk Memory Analysis
      </label>
      <ul class="md-nav__list" data-md-scrollfix>







  <li class="md-nav__item">
    <a href="../../../../../misc/disk-memory/introduction-zh/" title="Introduction" class="md-nav__link">
      Introduction
    </a>
  </li>







  <li class="md-nav__item">
    <a href="../../../../../misc/disk-memory/problem-zh/" title="Title" class="md-nav__link">
      Title
    </a>
  </li>


      </ul>
    </nav>
  </li>







  <li class="md-nav__item md-nav__item--nested">

      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-2-10" type="checkbox" id="nav-2-10">

    <label class="md-nav__link" for="nav-2-10">
      Other
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-2-10">
        Other
      </label>
      <ul class="md-nav__list" data-md-scrollfix>







  <li class="md-nav__item">
    <a href="../../../../../misc/other/pyc-zh/" title="pyc File" class="md-nav__link">
      pyc File
    </a>
  </li>


      </ul>
    </nav>
  </li>


      </ul>
    </nav>
  </li>







  <li class="md-nav__item md-nav__item--nested">

      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3" type="checkbox" id="nav-3">

    <label class="md-nav__link" for="nav-3">
      Crypto
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-3">
        Crypto
      </label>
      <ul class="md-nav__list" data-md-scrollfix>







  <li class="md-nav__item">
    <a href="../../../../../crypto/introduction-zh/" title="Introduction to Cryptography" class="md-nav__link">
      Introduction to Cryptography
    </a>
  </li>







  <li class="md-nav__item md-nav__item--nested">

      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3-2" type="checkbox" id="nav-3-2">

    <label class="md-nav__link" for="nav-3-2">
      Basic Mathematics
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-3-2">
        Basic Mathematics
      </label>
      <ul class="md-nav__list" data-md-scrollfix>







  <li class="md-nav__item">
    <a href="../../../../../crypto/basic/introduction-zh/" title="Introduction" class="md-nav__link">
      Introduction
    </a>
  </li>


      </ul>
    </nav>
  </li>







  <li class="md-nav__item md-nav__item--nested">

      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3-3" type="checkbox" id="nav-3-3">

    <label class="md-nav__link" for="nav-3-3">
      Classical Cryptography
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-3-3">
        Classical Cryptography
      </label>
      <ul class="md-nav__list" data-md-scrollfix>







  <li class="md-nav__item">
    <a href="../../../../../crypto/classical/introduction-zh/" title="Introduction to Classical Cryptography" class="md-nav__link">
      Introduction to Classical Cryptography
    </a>
  </li>







  <li class="md-nav__item">
    <a href="../../../../../crypto/classical/monoalphabetic-zh/" title="Single table Substitution Cipher" class="md-nav__link">
      Single table Substitution Cipher
    </a>
  </li>







  <li class="md-nav__item">
    <a href="../../../../../crypto/classical/polyalphabetic-zh/" title="Multi-table Substitution Cipher" class="md-nav__link">
      Multi-table Substitution Cipher
    </a>
  </li>







  <li class="md-nav__item">
    <a href="../../../../../crypto/classical/others-zh/" title="Other Types of Cipher" class="md-nav__link">
      Other Types of Cipher
    </a>
  </li>







  <li class="md-nav__item">
    <a href="../../../../../crypto/classical/summary-zh/" title="Summary" class="md-nav__link">
      Summary
    </a>
  </li>


      </ul>
    </nav>
  </li>







  <li class="md-nav__item md-nav__item--nested">

      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3-4" type="checkbox" id="nav-3-4">

    <label class="md-nav__link" for="nav-3-4">
      Stream Cipher
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-3-4">
        Stream Cipher
      </label>
      <ul class="md-nav__list" data-md-scrollfix>







  <li class="md-nav__item">
    <a href="../../../../../crypto/streamcipher/intro-zh/" title="Introduction" class="md-nav__link">
      Introduction
    </a>
  </li>







  <li class="md-nav__item md-nav__item--nested">

      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3-4-2" type="checkbox" id="nav-3-4-2">

    <label class="md-nav__link" for="nav-3-4-2">
      Pseudo Random Number Generator
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="3">
      <label class="md-nav__title" for="nav-3-4-2">
        Pseudo Random Number Generator
      </label>
      <ul class="md-nav__list" data-md-scrollfix>







  <li class="md-nav__item">
    <a href="../../../../../crypto/streamcipher/prng/intro-zh/" title="Introduction" class="md-nav__link">
      Introduction
    </a>
  </li>







  <li class="md-nav__item">
    <a href="../../../../../crypto/streamcipher/prng/csprng-zh/" title="Cryptographic Security Pseudo-random Number Generator" class="md-nav__link">
      Cryptographic Security Pseudo-random Number Generator
    </a>
  </li>







  <li class="md-nav__item">
    <a href="../../../../../crypto/streamcipher/prng/problem-zh/" title="Challenge Examples" class="md-nav__link">
      Challenge Examples
    </a>
  </li>


      </ul>
    </nav>
  </li>







  <li class="md-nav__item md-nav__item--nested">

      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3-4-3" type="checkbox" id="nav-3-4-3">

    <label class="md-nav__link" for="nav-3-4-3">
      Linear Congruence Generator
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="3">
      <label class="md-nav__title" for="nav-3-4-3">
        Linear Congruence Generator
      </label>
      <ul class="md-nav__list" data-md-scrollfix>







  <li class="md-nav__item">
    <a href="../../../../../crypto/streamcipher/lcg/intro-zh/" title="Introduction" class="md-nav__link">
      Introduction
    </a>
  </li>







  <li class="md-nav__item">
    <a href="../../../../../crypto/streamcipher/lcg/challenge-zh/" title="Example" class="md-nav__link">
      Example
    </a>
  </li>


      </ul>
    </nav>
  </li>







  <li class="md-nav__item md-nav__item--nested">

      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3-4-4" type="checkbox" id="nav-3-4-4">

    <label class="md-nav__link" for="nav-3-4-4">
      Feedback Shift Register
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="3">
      <label class="md-nav__title" for="nav-3-4-4">
        Feedback Shift Register
      </label>
      <ul class="md-nav__list" data-md-scrollfix>







  <li class="md-nav__item">
    <a href="../../../../../crypto/streamcipher/fsr/intro-zh/" title="Introduction" class="md-nav__link">
      Introduction
    </a>
  </li>







  <li class="md-nav__item">
    <a href="../../../../../crypto/streamcipher/fsr/lfsr-zh/" title="Linear Feedback Shift Register" class="md-nav__link">
      Linear Feedback Shift Register
    </a>
  </li>







  <li class="md-nav__item">
    <a href="../../../../../crypto/streamcipher/fsr/nfsr-zh/" title="Nonlinear Feedback Shift Register" class="md-nav__link">
      Nonlinear Feedback Shift Register
    </a>
  </li>


      </ul>
    </nav>
  </li>







  <li class="md-nav__item md-nav__item--nested">

      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3-4-5" type="checkbox" id="nav-3-4-5">

    <label class="md-nav__link" for="nav-3-4-5">
      Special Stream Cipher
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="3">
      <label class="md-nav__title" for="nav-3-4-5">
        Special Stream Cipher
      </label>
      <ul class="md-nav__list" data-md-scrollfix>







  <li class="md-nav__item">
    <a href="../../../../../crypto/streamcipher/special/rc4-zh/" title="RC4" class="md-nav__link">
      RC4
    </a>
  </li>


      </ul>
    </nav>
  </li>


      </ul>
    </nav>
  </li>







  <li class="md-nav__item md-nav__item--nested">

      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3-5" type="checkbox" id="nav-3-5">

    <label class="md-nav__link" for="nav-3-5">
      Block Cipher
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-3-5">
        Block Cipher
      </label>
      <ul class="md-nav__list" data-md-scrollfix>







  <li class="md-nav__item">
    <a href="../../../../../crypto/blockcipher/introduction-zh/" title="Introduction to Block Cipher" class="md-nav__link">
      Introduction to Block Cipher
    </a>
  </li>







  <li class="md-nav__item">
    <a href="../../../../../crypto/blockcipher/arx-operations-zh/" title="ARX" class="md-nav__link">
      ARX
    </a>
  </li>







  <li class="md-nav__item">
    <a href="../../../../../crypto/blockcipher/des-zh/" title="DES" class="md-nav__link">
      DES
    </a>
  </li>







  <li class="md-nav__item">
    <a href="../../../../../crypto/blockcipher/idea-zh/" title="IDEA" class="md-nav__link">
      IDEA
    </a>
  </li>







  <li class="md-nav__item">
    <a href="../../../../../crypto/blockcipher/aes-zh/" title="AES" class="md-nav__link">
      AES
    </a>
  </li>







  <li class="md-nav__item">
    <a href="../../../../../crypto/blockcipher/simon-speck-zh/" title="Simon and Speck" class="md-nav__link">
      Simon and Speck
    </a>
  </li>







  <li class="md-nav__item md-nav__item--nested">

      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3-5-7" type="checkbox" id="nav-3-5-7">

    <label class="md-nav__link" for="nav-3-5-7">
      Group Mode
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="3">
      <label class="md-nav__title" for="nav-3-5-7">
        Group Mode
      </label>
      <ul class="md-nav__list" data-md-scrollfix>







  <li class="md-nav__item">
    <a href="../../../../../crypto/blockcipher/mode/introduction-zh/" title="Introduction" class="md-nav__link">
      Introduction
    </a>
  </li>







  <li class="md-nav__item">
    <a href="../../../../../crypto/blockcipher/mode/padding-zh/" title="Padding Methods" class="md-nav__link">
      Padding Methods
    </a>
  </li>







  <li class="md-nav__item">
    <a href="../../../../../crypto/blockcipher/mode/ecb-zh/" title="ECB" class="md-nav__link">
      ECB
    </a>
  </li>







  <li class="md-nav__item">
    <a href="../../../../../crypto/blockcipher/mode/cbc-zh/" title="CBC" class="md-nav__link">
      CBC
    </a>
  </li>







  <li class="md-nav__item">
    <a href="../../../../../crypto/blockcipher/mode/pcbc-zh/" title="PCBC" class="md-nav__link">
      PCBC
    </a>
  </li>







  <li class="md-nav__item">
    <a href="../../../../../crypto/blockcipher/mode/cfb-zh/" title="CFB" class="md-nav__link">
      CFB
    </a>
  </li>







  <li class="md-nav__item">
    <a href="../../../../../crypto/blockcipher/mode/ofb-zh/" title="OFB" class="md-nav__link">
      OFB
    </a>
  </li>







  <li class="md-nav__item">
    <a href="../../../../../crypto/blockcipher/mode/ctr-zh/" title="CTR" class="md-nav__link">
      CTR
    </a>
  </li>







  <li class="md-nav__item">
    <a href="../../../../../crypto/blockcipher/mode/padding-oracle-attack-zh/" title="Padding Oracle Attack" class="md-nav__link">
      Padding Oracle Attack
    </a>
  </li>


      </ul>
    </nav>
  </li>


      </ul>
    </nav>
  </li>







  <li class="md-nav__item md-nav__item--nested">

      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3-6" type="checkbox" id="nav-3-6">

    <label class="md-nav__link" for="nav-3-6">
      Asymmetric Cryptography
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-3-6">
        Asymmetric Cryptography
      </label>
      <ul class="md-nav__list" data-md-scrollfix>







  <li class="md-nav__item">
    <a href="../../../../../crypto/asymmetric/introduction-zh/" title="Introduction to Asymmetric Cryptography" class="md-nav__link">
      Introduction to Asymmetric Cryptography
    </a>
  </li>







  <li class="md-nav__item md-nav__item--nested">

      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3-6-2" type="checkbox" id="nav-3-6-2">

    <label class="md-nav__link" for="nav-3-6-2">
      RSA
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="3">
      <label class="md-nav__title" for="nav-3-6-2">
        RSA
      </label>
      <ul class="md-nav__list" data-md-scrollfix>







  <li class="md-nav__item">
    <a href="../../../../../crypto/asymmetric/rsa/rsa_theory-zh/" title="RSA Introduction" class="md-nav__link">
      RSA Introduction
    </a>
  </li>







  <li class="md-nav__item">
    <a href="../../../../../crypto/asymmetric/rsa/rsa_module_attack-zh/" title="Modulo-related Attacks" class="md-nav__link">
      Modulo-related Attacks
    </a>
  </li>







  <li class="md-nav__item">
    <a href="../../../../../crypto/asymmetric/rsa/rsa_e_attack-zh/" title="Public Key Index Related Attacks" class="md-nav__link">
      Public Key Index Related Attacks
    </a>
  </li>







  <li class="md-nav__item">
    <a href="../../../../../crypto/asymmetric/rsa/rsa_d_attack-zh/" title="Private Key d Related Attacks" class="md-nav__link">
      Private Key d Related Attacks
    </a>
  </li>







  <li class="md-nav__item">
    <a href="../../../../../crypto/asymmetric/rsa/rsa_coppersmith_attack-zh/" title="Coppersmith Related Attacks" class="md-nav__link">
      Coppersmith Related Attacks
    </a>
  </li>







  <li class="md-nav__item">
    <a href="../../../../../crypto/asymmetric/rsa/rsa_chosen_plain_cipher-zh/" title="Chosen Plain Cipher Attack" class="md-nav__link">
      Chosen Plain Cipher Attack
    </a>
  </li>







  <li class="md-nav__item">
    <a href="../../../../../crypto/asymmetric/rsa/rsa_side_channel-zh/" title="Side Channel Attack" class="md-nav__link">
      Side Channel Attack
    </a>
  </li>







  <li class="md-nav__item">
    <a href="../../../../../crypto/asymmetric/rsa/rsa_pkcs_attack-zh/" title="Bleichenbacher Attack" class="md-nav__link">
      Bleichenbacher Attack
    </a>
  </li>







  <li class="md-nav__item">
    <a href="../../../../../crypto/asymmetric/rsa/rsa_complex-zh/" title="Challenge Examples" class="md-nav__link">
      Challenge Examples
    </a>
  </li>


      </ul>
    </nav>
  </li>







  <li class="md-nav__item">
    <a href="../../../../../crypto/asymmetric/knapsack/knapsack-zh/" title="Knapsack Cipher" class="md-nav__link">
      Knapsack Cipher
    </a>
  </li>







  <li class="md-nav__item md-nav__item--nested">

      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3-6-4" type="checkbox" id="nav-3-6-4">

    <label class="md-nav__link" for="nav-3-6-4">
      Discrete Log Correlation
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="3">
      <label class="md-nav__title" for="nav-3-6-4">
        Discrete Log Correlation
      </label>
      <ul class="md-nav__list" data-md-scrollfix>







  <li class="md-nav__item">
    <a href="../../../../../crypto/asymmetric/discrete-log/discrete-log-zh/" title="Discrete Logarithm" class="md-nav__link">
      Discrete Logarithm
    </a>
  </li>







  <li class="md-nav__item">
    <a href="../../../../../crypto/asymmetric/discrete-log/elgamal-zh/" title="Elgamal" class="md-nav__link">
      Elgamal
    </a>
  </li>







  <li class="md-nav__item">
    <a href="../../../../../crypto/asymmetric/discrete-log/ecc-zh/" title="ECC" class="md-nav__link">
      ECC
    </a>
  </li>


      </ul>
    </nav>
  </li>







  <li class="md-nav__item md-nav__item--nested">

      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3-6-5" type="checkbox" id="nav-3-6-5">

    <label class="md-nav__link" for="nav-3-6-5">
      Lattice-based Cryptography
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="3">
      <label class="md-nav__title" for="nav-3-6-5">
        Lattice-based Cryptography
      </label>
      <ul class="md-nav__list" data-md-scrollfix>







  <li class="md-nav__item">
    <a href="../../../../../crypto/asymmetric/lattice/overview-zh/" title="Lattice Overview" class="md-nav__link">
      Lattice Overview
    </a>
  </li>







  <li class="md-nav__item">
    <a href="../../../../../crypto/asymmetric/lattice/introduction-zh/" title="Introduction to Lattices" class="md-nav__link">
      Introduction to Lattices
    </a>
  </li>







  <li class="md-nav__item">
    <a href="../../../../../crypto/asymmetric/lattice/lattice-reduction-zh/" title="Lattice-based Algorithm" class="md-nav__link">
      Lattice-based Algorithm
    </a>
  </li>







  <li class="md-nav__item">
    <a href="../../../../../crypto/asymmetric/lattice/cvp-zh/" title="CVP" class="md-nav__link">
      CVP
    </a>
  </li>


      </ul>
    </nav>
  </li>


      </ul>
    </nav>
  </li>







  <li class="md-nav__item md-nav__item--nested">

      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3-7" type="checkbox" id="nav-3-7">

    <label class="md-nav__link" for="nav-3-7">
      Hash Function
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-3-7">
        Hash Function
      </label>
      <ul class="md-nav__list" data-md-scrollfix>







  <li class="md-nav__item">
    <a href="../../../../../crypto/hash/introduction-zh/" title="Introduction to the Hash Function" class="md-nav__link">
      Introduction to the Hash Function
    </a>
  </li>







  <li class="md-nav__item">
    <a href="../../../../../crypto/hash/md5-zh/" title="MD5" class="md-nav__link">
      MD5
    </a>
  </li>







  <li class="md-nav__item">
    <a href="../../../../../crypto/hash/sha1-zh/" title="SHA1" class="md-nav__link">
      SHA1
    </a>
  </li>







  <li class="md-nav__item">
    <a href="../../../../../crypto/hash/fnv-zh/" title="FNV" class="md-nav__link">
      FNV
    </a>
  </li>







  <li class="md-nav__item">
    <a href="../../../../../crypto/hash/attack-zh/" title="Hash Attack" class="md-nav__link">
      Hash Attack
    </a>
  </li>







  <li class="md-nav__item">
    <a href="../../../../../crypto/hash/complex-zh/" title="Challenge Examples" class="md-nav__link">
      Challenge Examples
    </a>
  </li>


      </ul>
    </nav>
  </li>







  <li class="md-nav__item md-nav__item--nested">

      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3-8" type="checkbox" id="nav-3-8">

    <label class="md-nav__link" for="nav-3-8">
      Digital Signature
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-3-8">
        Digital Signature
      </label>
      <ul class="md-nav__list" data-md-scrollfix>







  <li class="md-nav__item">
    <a href="../../../../../crypto/signature/introduction-zh/" title="Introduction to Digital Signatures" class="md-nav__link">
      Introduction to Digital Signatures
    </a>
  </li>







  <li class="md-nav__item">
    <a href="../../../../../crypto/signature/rsa-zh/" title="RSA Digital Signature" class="md-nav__link">
      RSA Digital Signature
    </a>
  </li>







  <li class="md-nav__item">
    <a href="../../../../../crypto/signature/elgamal-zh/" title="ElGamal Digital Signature" class="md-nav__link">
      ElGamal Digital Signature
    </a>
  </li>







  <li class="md-nav__item">
    <a href="../../../../../crypto/signature/dsa-zh/" title="DSA Digital Signature" class="md-nav__link">
      DSA Digital Signature
    </a>
  </li>


      </ul>
    </nav>
  </li>







  <li class="md-nav__item md-nav__item--nested">

      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3-9" type="checkbox" id="nav-3-9">

    <label class="md-nav__link" for="nav-3-9">
      Summary of Attack Techniques
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-3-9">
        Summary of Attack Techniques
      </label>
      <ul class="md-nav__list" data-md-scrollfix>







  <li class="md-nav__item">
    <a href="../../../../../crypto/attack-summary/attack-mode-zh/" title="Introduction" class="md-nav__link">
      Introduction
    </a>
  </li>







  <li class="md-nav__item">
    <a href="../../../../../crypto/attack-summary/meet-in-the-middle-zh/" title="Intermediate Encounter Attack" class="md-nav__link">
      Intermediate Encounter Attack
    </a>
  </li>







  <li class="md-nav__item">
    <a href="../../../../../crypto/attack-summary/bit-attack-zh/" title="Bit attack" class="md-nav__link">
      Bit attack
    </a>
  </li>


      </ul>
    </nav>
  </li>







  <li class="md-nav__item">
    <a href="../../../../../crypto/certificate/introduction-zh/" title="Certificate Format" class="md-nav__link">
      Certificate Format
    </a>
  </li>


      </ul>
    </nav>
  </li>







  <li class="md-nav__item md-nav__item--nested">

      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-4" type="checkbox" id="nav-4">

    <label class="md-nav__link" for="nav-4">
      Web
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-4">
        Web
      </label>
      <ul class="md-nav__list" data-md-scrollfix>







  <li class="md-nav__item">
    <a href="../../../../../web/introduction-zh/" title="Introduction to Web Applications" class="md-nav__link">
      Introduction to Web Applications
    </a>
  </li>







  <li class="md-nav__item">
    <a href="../../../../../web/sqli-zh/" title="SQL Injection" class="md-nav__link">
      SQL Injection
    </a>
  </li>







  <li class="md-nav__item">
    <a href="../../../../../web/xss-zh/" title="XSS Cross-site Scripting Attack" class="md-nav__link">
      XSS Cross-site Scripting Attack
    </a>
  </li>







  <li class="md-nav__item">
    <a href="../../../../../web/csrf-zh/" title="CSRF Cross-site Request Forgery" class="md-nav__link">
      CSRF Cross-site Request Forgery
    </a>
  </li>







  <li class="md-nav__item">
    <a href="../../../../../web/ssrf-zh/" title="SSRF Server Request Forgery" class="md-nav__link">
      SSRF Server Request Forgery
    </a>
  </li>







  <li class="md-nav__item">
    <a href="../../../../../web/php/php-zh/" title="PHP Code Auditing" class="md-nav__link">
      PHP Code Auditing
    </a>
  </li>


      </ul>
    </nav>
  </li>







  <li class="md-nav__item md-nav__item--nested">

      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-5" type="checkbox" id="nav-5">

    <label class="md-nav__link" for="nav-5">
      Assembly
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-5">
        Assembly
      </label>
      <ul class="md-nav__list" data-md-scrollfix>







  <li class="md-nav__item">
    <a href="../../../../../assembly/x86-x64/readme-zh/" title="x86_x64" class="md-nav__link">
      x86_x64
    </a>
  </li>







  <li class="md-nav__item">
    <a href="../../../../../assembly/mips/readme-zh/" title="mips" class="md-nav__link">
      mips
    </a>
  </li>







  <li class="md-nav__item">
    <a href="../../../../../assembly/arm/readme-zh/" title="arm" class="md-nav__link">
      arm
    </a>
  </li>


      </ul>
    </nav>
  </li>







  <li class="md-nav__item md-nav__item--nested">

      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-6" type="checkbox" id="nav-6">

    <label class="md-nav__link" for="nav-6">
      Executable
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-6">
        Executable
      </label>
      <ul class="md-nav__list" data-md-scrollfix>







  <li class="md-nav__item md-nav__item--nested">

      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-6-1" type="checkbox" id="nav-6-1">

    <label class="md-nav__link" for="nav-6-1">
      ELF file
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-6-1">
        ELF file
      </label>
      <ul class="md-nav__list" data-md-scrollfix>







  <li class="md-nav__item">
    <a href="../../../../../executable/elf/elf-structure-zh/" title="ELF File Basic Structure" class="md-nav__link">
      ELF File Basic Structure
    </a>
  </li>







  <li class="md-nav__item">
    <a href="../../../../../executable/elf/program-loading-zh/" title="Program Loading" class="md-nav__link">
      Program Loading
    </a>
  </li>







  <li class="md-nav__item">
    <a href="../../../../../executable/elf/program-linking-zh/" title="Program Link" class="md-nav__link">
      Program Link
    </a>
  </li>







  <li class="md-nav__item">
    <a href="../../../../../executable/elf/running-overview-zh/" title="Program Execution Flow" class="md-nav__link">
      Program Execution Flow
    </a>
  </li>


      </ul>
    </nav>
  </li>







  <li class="md-nav__item md-nav__item--nested">

      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-6-2" type="checkbox" id="nav-6-2">

    <label class="md-nav__link" for="nav-6-2">
      PE file
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-6-2">
        PE file
      </label>
      <ul class="md-nav__list" data-md-scrollfix>







  <li class="md-nav__item">
    <a href="../../../../../executable/pe/pe-excutable-zh/" title="PE File Basic Structure" class="md-nav__link">
      PE File Basic Structure
    </a>
  </li>







  <li class="md-nav__item">
    <a href="../../../../../executable/pe/pe-import-table-zh/" title="PE Import Table" class="md-nav__link">
      PE Import Table
    </a>
  </li>







  <li class="md-nav__item">
    <a href="../../../../../executable/pe/pe-export-table-zh/" title="PE Export Table" class="md-nav__link">
      PE Export Table
    </a>
  </li>







  <li class="md-nav__item">
    <a href="../../../../../executable/pe/pe-relocation-table-zh/" title="PE Relocation Table" class="md-nav__link">
      PE Relocation Table
    </a>
  </li>


      </ul>
    </nav>
  </li>


      </ul>
    </nav>
  </li>







  <li class="md-nav__item md-nav__item--nested">

      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-7" type="checkbox" id="nav-7">

    <label class="md-nav__link" for="nav-7">
      Reverse Engineering
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-7">
        Reverse Engineering
      </label>
      <ul class="md-nav__list" data-md-scrollfix>







  <li class="md-nav__item md-nav__item--nested">

      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-7-1" type="checkbox" id="nav-7-1">

    <label class="md-nav__link" for="nav-7-1">
      Reverse Overview
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-7-1">
        Reverse Overview
      </label>
      <ul class="md-nav__list" data-md-scrollfix>







  <li class="md-nav__item">
    <a href="../../../../../reverse/introduction-zh/" title="Software Reverse Engineering Introduction" class="md-nav__link">
      Software Reverse Engineering Introduction
    </a>
  </li>







  <li class="md-nav__item">
    <a href="../../../../../reverse/Identify-Encode-Encryption/introduction-zh/" title="Common Encryption Algorithms and Code Recognition" class="md-nav__link">
      Common Encryption Algorithms and Code Recognition
    </a>
  </li>







  <li class="md-nav__item">
    <a href="../../../../../reverse/maze/maze-zh/" title="Labyrinth Problem" class="md-nav__link">
      Labyrinth Problem
    </a>
  </li>







  <li class="md-nav__item">
    <a href="../../../../../reverse/vm/vm-zh/" title="Virtual Machine Command Analysis" class="md-nav__link">
      Virtual Machine Command Analysis
    </a>
  </li>







  <li class="md-nav__item">
    <a href="../../../../../reverse/unicorn/introduction-zh/" title="Unicorn Engine Introduction" class="md-nav__link">
      Unicorn Engine Introduction
    </a>
  </li>


      </ul>
    </nav>
  </li>







  <li class="md-nav__item md-nav__item--nested">

      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-7-2" type="checkbox" id="nav-7-2">

    <label class="md-nav__link" for="nav-7-2">
      Linux Reverse
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-7-2">
        Linux Reverse
      </label>
      <ul class="md-nav__list" data-md-scrollfix>







  <li class="md-nav__item md-nav__item--nested">

      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-7-2-1" type="checkbox" id="nav-7-2-1">

    <label class="md-nav__link" for="nav-7-2-1">
      Linux Reverse Technology
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="3">
      <label class="md-nav__title" for="nav-7-2-1">
        Linux Reverse Technology
      </label>
      <ul class="md-nav__list" data-md-scrollfix>







  <li class="md-nav__item">
    <a href="../../../../../reverse/linux/ld_preload-zh/" title="LD_PRELOAD" class="md-nav__link">
      LD_PRELOAD
    </a>
  </li>







  <li class="md-nav__item">
    <a href="../../../../../reverse/linux/false-disasm-zh/" title="Incorrect Disassembly Fix" class="md-nav__link">
      Incorrect Disassembly Fix
    </a>
  </li>







  <li class="md-nav__item">
    <a href="../../../../../reverse/linux/detect-bp-zh/" title="Detecting Breakpoints Bypassing" class="md-nav__link">
      Detecting Breakpoints Bypassing
    </a>
  </li>







  <li class="md-nav__item">
    <a href="../../../../../reverse/linux/detect-dbg-zh/" title="Detecting Debugging Bypassing" class="md-nav__link">
      Detecting Debugging Bypassing
    </a>
  </li>


      </ul>
    </nav>
  </li>


      </ul>
    </nav>
  </li>







  <li class="md-nav__item md-nav__item--nested">

      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-7-3" type="checkbox" id="nav-7-3">

    <label class="md-nav__link" for="nav-7-3">
      Windows Reverse
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-7-3">
        Windows Reverse
      </label>
      <ul class="md-nav__list" data-md-scrollfix>







  <li class="md-nav__item md-nav__item--nested">

      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-7-3-1" type="checkbox" id="nav-7-3-1">

    <label class="md-nav__link" for="nav-7-3-1">
      Shelling Technology
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="3">
      <label class="md-nav__title" for="nav-7-3-1">
        Shelling Technology
      </label>
      <ul class="md-nav__list" data-md-scrollfix>







  <li class="md-nav__item">
    <a href="../../../../../reverse/windows/unpack/packer-introduction-zh/" title="Introduction to the Protective case" class="md-nav__link">
      Introduction to the Protective case
    </a>
  </li>







  <li class="md-nav__item">
    <a href="../../../../../reverse/windows/unpack/trace-zh/" title="Single Step Tracking Method" class="md-nav__link">
      Single Step Tracking Method
    </a>
  </li>







  <li class="md-nav__item">
    <a href="../../../../../reverse/windows/unpack/esp-zh/" title="ESP Law" class="md-nav__link">
      ESP Law
    </a>
  </li>







  <li class="md-nav__item">
    <a href="../../../../../reverse/windows/unpack/direct-oep-zh/" title="One Step to the OEP Method" class="md-nav__link">
      One Step to the OEP Method
    </a>
  </li>







  <li class="md-nav__item">
    <a href="../../../../../reverse/windows/unpack/memory-zh/" title="Memory Mirroring Method" class="md-nav__link">
      Memory Mirroring Method
    </a>
  </li>







  <li class="md-nav__item">
    <a href="../../../../../reverse/windows/unpack/last-exception-zh/" title="Last Exception Method" class="md-nav__link">
      Last Exception Method
    </a>
  </li>







  <li class="md-nav__item">
    <a href="../../../../../reverse/windows/unpack/sfx-zh/" title="SFX Method" class="md-nav__link">
      SFX Method
    </a>
  </li>







  <li class="md-nav__item">
    <a href="../../../../../reverse/windows/unpack/fix-iat-zh/" title="DUMP and IAT Reconstruction" class="md-nav__link">
      DUMP and IAT Reconstruction
    </a>
  </li>







  <li class="md-nav__item">
    <a href="../../../../../reverse/windows/unpack/manually-fix-iat-zh/" title="Manually Find the IAT and Rebuild It Using ImportREC" class="md-nav__link">
      Manually Find the IAT and Rebuild It Using ImportREC
    </a>
  </li>







  <li class="md-nav__item">
    <a href="../../../../../reverse/windows/unpack/unpack-dll-zh/" title="DLL File Unpacking" class="md-nav__link">
      DLL File Unpacking
    </a>
  </li>


      </ul>
    </nav>
  </li>







  <li class="md-nav__item md-nav__item--nested">

      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-7-3-2" type="checkbox" id="nav-7-3-2">

    <label class="md-nav__link" for="nav-7-3-2">
      Anti-debugging Technology
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="3">
      <label class="md-nav__title" for="nav-7-3-2">
        Anti-debugging Technology
      </label>
      <ul class="md-nav__list" data-md-scrollfix>







  <li class="md-nav__item">
    <a href="../../../../../reverse/windows/anti-debug/ntglobalflag-zh/" title="NtGlobalFlag" class="md-nav__link">
      NtGlobalFlag
    </a>
  </li>







  <li class="md-nav__item">
    <a href="../../../../../reverse/windows/anti-debug/heap-flags-zh/" title="Heap Flags" class="md-nav__link">
      Heap Flags
    </a>
  </li>







  <li class="md-nav__item">
    <a href="../../../../../reverse/windows/anti-debug/the-heap-zh/" title="The Heap" class="md-nav__link">
      The Heap
    </a>
  </li>







  <li class="md-nav__item">
    <a href="../../../../../reverse/windows/anti-debug/int-3-zh/" title="Interrupt 3" class="md-nav__link">
      Interrupt 3
    </a>
  </li>







  <li class="md-nav__item">
    <a href="../../../../../reverse/windows/anti-debug/isdebuggerpresent-zh/" title="IsDebuggerPresent" class="md-nav__link">
      IsDebuggerPresent
    </a>
  </li>







  <li class="md-nav__item">
    <a href="../../../../../reverse/windows/anti-debug/checkremotedebuggerpresent-zh/" title="CheckRemoteDebuggerPresent" class="md-nav__link">
      CheckRemoteDebuggerPresent
    </a>
  </li>







  <li class="md-nav__item">
    <a href="../../../../../reverse/windows/anti-debug/ntqueryinformationprocess-zh/" title="NtQueryInformationProcess" class="md-nav__link">
      NtQueryInformationProcess
    </a>
  </li>







  <li class="md-nav__item">
    <a href="../../../../../reverse/windows/anti-debug/junk-code-zh/" title="Flower command" class="md-nav__link">
      Flower command
    </a>
  </li>







  <li class="md-nav__item">
    <a href="../../../../../reverse/windows/anti-debug/example-zh/" title="Anti-debug technical example" class="md-nav__link">
      Anti-debug technical example
    </a>
  </li>


      </ul>
    </nav>
  </li>


      </ul>
    </nav>
  </li>


      </ul>
    </nav>
  </li>







  <li class="md-nav__item md-nav__item--nested">

      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-8" type="checkbox" id="nav-8">

    <label class="md-nav__link" for="nav-8">
      Pwn
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-8">
        Pwn
      </label>
      <ul class="md-nav__list" data-md-scrollfix>







  <li class="md-nav__item md-nav__item--nested">

      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-8-1" type="checkbox" id="nav-8-1">

    <label class="md-nav__link" for="nav-8-1">
      Pwn Overview
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-8-1">
        Pwn Overview
      </label>
      <ul class="md-nav__list" data-md-scrollfix>







  <li class="md-nav__item">
    <a href="../../../../readme-zh/" title="Readme zh" class="md-nav__link">
      Readme zh
    </a>
  </li>


      </ul>
    </nav>
  </li>







  <li class="md-nav__item md-nav__item--nested">

      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-8-2" type="checkbox" id="nav-8-2">

    <label class="md-nav__link" for="nav-8-2">
      Linux Pwn
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-8-2">
        Linux Pwn
      </label>
      <ul class="md-nav__list" data-md-scrollfix>







  <li class="md-nav__item md-nav__item--nested">

      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-8-2-1" type="checkbox" id="nav-8-2-1">

    <label class="md-nav__link" for="nav-8-2-1">
      Security Protection Mechanism
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="3">
      <label class="md-nav__title" for="nav-8-2-1">
        Security Protection Mechanism
      </label>
      <ul class="md-nav__list" data-md-scrollfix>







  <li class="md-nav__item">
    <a href="../../../mitigation/canary-zh/" title="Canary" class="md-nav__link">
      Canary
    </a>
  </li>


      </ul>
    </nav>
  </li>







  <li class="md-nav__item md-nav__item--nested">

      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-8-2-2" type="checkbox" id="nav-8-2-2">

    <label class="md-nav__link" for="nav-8-2-2">
      Stack Overflow
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="3">
      <label class="md-nav__title" for="nav-8-2-2">
        Stack Overflow
      </label>
      <ul class="md-nav__list" data-md-scrollfix>







  <li class="md-nav__item">
    <a href="../../../stackoverflow/stack-intro-zh/" title="Stack Introduction" class="md-nav__link">
      Stack Introduction
    </a>
  </li>







  <li class="md-nav__item">
    <a href="../../../stackoverflow/stackoverflow-basic-zh/" title="Stack Overflow Principle" class="md-nav__link">
      Stack Overflow Principle
    </a>
  </li>







  <li class="md-nav__item">
    <a href="../../../stackoverflow/basic-rop-zh/" title="Basic ROP" class="md-nav__link">
      Basic ROP
    </a>
  </li>







  <li class="md-nav__item">
    <a href="../../../stackoverflow/medium-rop-zh/" title="Intermediate ROP" class="md-nav__link">
      Intermediate ROP
    </a>
  </li>







  <li class="md-nav__item">
    <a href="../../../stackoverflow/advanced-rop-zh/" title="Advanced ROP" class="md-nav__link">
      Advanced ROP
    </a>
  </li>







  <li class="md-nav__item">
    <a href="../../../stackoverflow/fancy-rop-zh/" title="ROP Tricks" class="md-nav__link">
      ROP Tricks
    </a>
  </li>


      </ul>
    </nav>
  </li>







  <li class="md-nav__item md-nav__item--nested">

      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-8-2-3" type="checkbox" id="nav-8-2-3">

    <label class="md-nav__link" for="nav-8-2-3">
      Format String Vulnerability
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="3">
      <label class="md-nav__title" for="nav-8-2-3">
        Format String Vulnerability
      </label>
      <ul class="md-nav__list" data-md-scrollfix>







  <li class="md-nav__item">
    <a href="../../../fmtstr/fmtstr_intro-zh/" title="Format String Vulnerability Principle" class="md-nav__link">
      Format String Vulnerability Principle
    </a>
  </li>







  <li class="md-nav__item">
    <a href="../../../fmtstr/fmtstr_exploit-zh/" title="Format String Exploit" class="md-nav__link">
      Format String Exploit
    </a>
  </li>







  <li class="md-nav__item">
    <a href="../../../fmtstr/fmtstr_example-zh/" title="Format String Vulnerability Example" class="md-nav__link">
      Format String Vulnerability Example
    </a>
  </li>







  <li class="md-nav__item">
    <a href="../../../fmtstr/fmtstr_detect-zh/" title="Format String Vulnerability Detection" class="md-nav__link">
      Format String Vulnerability Detection
    </a>
  </li>


      </ul>
    </nav>
  </li>







  <li class="md-nav__item md-nav__item--nested">

      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-8-2-4" type="checkbox" id="nav-8-2-4">

    <label class="md-nav__link" for="nav-8-2-4">
      Glibc Heap Related
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="3">
      <label class="md-nav__title" for="nav-8-2-4">
        Glibc Heap Related
      </label>
      <ul class="md-nav__list" data-md-scrollfix>







  <li class="md-nav__item">
    <a href="../../introduction-zh/" title="Introduction to Heap" class="md-nav__link">
      Introduction to Heap
    </a>
  </li>







  <li class="md-nav__item">
    <a href="../../heap_overview-zh/" title="Heap Overview" class="md-nav__link">
      Heap Overview
    </a>
  </li>







  <li class="md-nav__item">
    <a href="../../heap_structure-zh/" title="Heap Related Data Structure" class="md-nav__link">
      Heap Related Data Structure
    </a>
  </li>







  <li class="md-nav__item md-nav__item--nested">

      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-8-2-4-4" type="checkbox" id="nav-8-2-4-4">

    <label class="md-nav__link" for="nav-8-2-4-4">
      In-depth Understanding of Ptmalloc2
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="4">
      <label class="md-nav__title" for="nav-8-2-4-4">
        In-depth Understanding of Ptmalloc2
      </label>
      <ul class="md-nav__list" data-md-scrollfix>







  <li class="md-nav__item">
    <a href="../overview-zh/" title="Implementation" class="md-nav__link">
      Implementation
    </a>
  </li>







  <li class="md-nav__item">
    <a href="../basic-zh/" title="Basic Functions in the heap implementation" class="md-nav__link">
      Basic Functions in the heap implementation
    </a>
  </li>







  <li class="md-nav__item">
    <a href="../heap-init-zh/" title="Heap Initialization" class="md-nav__link">
      Heap Initialization
    </a>
  </li>







  <li class="md-nav__item">
    <a href="../malloc-zh/" title="Allocate Heap Memory" class="md-nav__link">
      Allocate Heap Memory
    </a>
  </li>







  <li class="md-nav__item">
    <a href="../free-zh/" title="Free Heap Memory" class="md-nav__link">
      Free Heap Memory
    </a>
  </li>







  <li class="md-nav__item">
    <a href="../tcache-zh/" title="Tcache" class="md-nav__link">
      Tcache
    </a>
  </li>







  <li class="md-nav__item">
    <a href="../malloc_state-zh/" title="malloc_state" class="md-nav__link">
      malloc_state
    </a>
  </li>







  <li class="md-nav__item">
    <a href="../misc-zh/" title="Other" class="md-nav__link">
      Other
    </a>
  </li>


      </ul>
    </nav>
  </li>







  <li class="md-nav__item">
    <a href="../../heapoverflow_basic-zh/" title="Heap Overflow" class="md-nav__link">
      Heap Overflow
    </a>
  </li>







  <li class="md-nav__item">
    <a href="../../off_by_one-zh/" title="Heap-based Off-By-One" class="md-nav__link">
      Heap-based Off-By-One
    </a>
  </li>







  <li class="md-nav__item">
    <a href="../../chunk_extend_overlapping-zh/" title="Chunk Extend/Overlapping" class="md-nav__link">
      Chunk Extend/Overlapping
    </a>
  </li>







  <li class="md-nav__item">
    <a href="../../unlink-zh/" title="Unlink" class="md-nav__link">
      Unlink
    </a>
  </li>







  <li class="md-nav__item">
    <a href="../../use_after_free-zh/" title="Use After Free" class="md-nav__link">
      Use After Free
    </a>
  </li>







  <li class="md-nav__item">
    <a href="../../fastbin_attack-zh/" title="Fastbin Attack" class="md-nav__link">
      Fastbin Attack
    </a>
  </li>







  <li class="md-nav__item">
    <a href="../../unsorted_bin_attack-zh/" title="Unsorted Bin Attack" class="md-nav__link">
      Unsorted Bin Attack
    </a>
  </li>







  <li class="md-nav__item">
    <a href="../../large_bin_attack-zh/" title="Large Bin Attack" class="md-nav__link">
      Large Bin Attack
    </a>
  </li>







  <li class="md-nav__item">
    <a href="../../tcache_attack-zh/" title="Tcache Attack" class="md-nav__link">
      Tcache Attack
    </a>
  </li>







  <li class="md-nav__item">
    <a href="../../house_of_einherjar-zh/" title="House of Einherjar" class="md-nav__link">
      House of Einherjar
    </a>
  </li>







  <li class="md-nav__item">
    <a href="../../house_of_force-zh/" title="House of Force" class="md-nav__link">
      House of Force
    </a>
  </li>







  <li class="md-nav__item">
    <a href="../../house_of_lore-zh/" title="House of Lore" class="md-nav__link">
      House of Lore
    </a>
  </li>







  <li class="md-nav__item">
    <a href="../../house_of_orange-zh/" title="House of Orange" class="md-nav__link">
      House of Orange
    </a>
  </li>







  <li class="md-nav__item">
    <a href="../../house_of_rabbit-zh/" title="House of Rabbit" class="md-nav__link">
      House of Rabbit
    </a>
  </li>







  <li class="md-nav__item">
    <a href="../../house_of_roman-zh/" title="House of Roman" class="md-nav__link">
      House of Roman
    </a>
  </li>


      </ul>
    </nav>
  </li>







  <li class="md-nav__item md-nav__item--nested">

      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-8-2-5" type="checkbox" id="nav-8-2-5">

    <label class="md-nav__link" for="nav-8-2-5">
      IO_FILE Related
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="3">
      <label class="md-nav__title" for="nav-8-2-5">
        IO_FILE Related
      </label>
      <ul class="md-nav__list" data-md-scrollfix>







  <li class="md-nav__item">
    <a href="../../../io_file/introduction-zh/" title="FILE Structure Description" class="md-nav__link">
      FILE Structure Description
    </a>
  </li>







  <li class="md-nav__item">
    <a href="../../../io_file/fake-vtable-exploit-zh/" title="Forged Vtable to Hijack Control Flow" class="md-nav__link">
      Forged Vtable to Hijack Control Flow
    </a>
  </li>







  <li class="md-nav__item">
    <a href="../../../io_file/fsop-zh/" title="FSOP" class="md-nav__link">
      FSOP
    </a>
  </li>







  <li class="md-nav__item">
    <a href="../../../io_file/exploit-in-libc2.24-zh/" title="Use of IO_FILE Under Glibc 2.24" class="md-nav__link">
      Use of IO_FILE Under Glibc 2.24
    </a>
  </li>


      </ul>
    </nav>
  </li>







  <li class="md-nav__item md-nav__item--nested">

      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-8-2-6" type="checkbox" id="nav-8-2-6">

    <label class="md-nav__link" for="nav-8-2-6">
      Race Condition
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="3">
      <label class="md-nav__title" for="nav-8-2-6">
        Race Condition
      </label>
      <ul class="md-nav__list" data-md-scrollfix>







  <li class="md-nav__item">
    <a href="../../../race-condition/introduction-zh/" title="Race Condition Introduction" class="md-nav__link">
      Race Condition Introduction
    </a>
  </li>







  <li class="md-nav__item">
    <a href="../../../race-condition/problem-zh/" title="Example" class="md-nav__link">
      Example
    </a>
  </li>


      </ul>
    </nav>
  </li>







  <li class="md-nav__item md-nav__item--nested">

      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-8-2-7" type="checkbox" id="nav-8-2-7">

    <label class="md-nav__link" for="nav-8-2-7">
      Integer Overflow
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="3">
      <label class="md-nav__title" for="nav-8-2-7">
        Integer Overflow
      </label>
      <ul class="md-nav__list" data-md-scrollfix>







  <li class="md-nav__item">
    <a href="../../../integeroverflow/intof-zh/" title="Introduction to The Principle of Integer Overflow" class="md-nav__link">
      Introduction to The Principle of Integer Overflow
    </a>
  </li>


      </ul>
    </nav>
  </li>







  <li class="md-nav__item md-nav__item--nested">

      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-8-2-8" type="checkbox" id="nav-8-2-8">

    <label class="md-nav__link" for="nav-8-2-8">
      Sandbox Escape
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="3">
      <label class="md-nav__title" for="nav-8-2-8">
        Sandbox Escape
      </label>
      <ul class="md-nav__list" data-md-scrollfix>







  <li class="md-nav__item">
    <a href="../../../sandbox/python-sandbox-escape-zh/" title="Python Sandbox Escape" class="md-nav__link">
      Python Sandbox Escape
    </a>
  </li>


      </ul>
    </nav>
  </li>







  <li class="md-nav__item md-nav__item--nested">

      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-8-2-9" type="checkbox" id="nav-8-2-9">

    <label class="md-nav__link" for="nav-8-2-9">
      Linux Kernel
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="3">
      <label class="md-nav__title" for="nav-8-2-9">
        Linux Kernel
      </label>
      <ul class="md-nav__list" data-md-scrollfix>







  <li class="md-nav__item">
    <a href="../../../kernel/environment-zh/" title="Environment Setup" class="md-nav__link">
      Environment Setup
    </a>
  </li>







  <li class="md-nav__item">
    <a href="../../../kernel/basic_knowledge-zh/" title="Basics" class="md-nav__link">
      Basics
    </a>
  </li>







  <li class="md-nav__item">
    <a href="../../../kernel/kernel_uaf-zh/" title="Kernel-UAF" class="md-nav__link">
      Kernel-UAF
    </a>
  </li>







  <li class="md-nav__item">
    <a href="../../../kernel/kernel_rop-zh/" title="Kernel-ROP" class="md-nav__link">
      Kernel-ROP
    </a>
  </li>







  <li class="md-nav__item">
    <a href="../../../kernel/ret2usr-zh/" title="ret2usr" class="md-nav__link">
      ret2usr
    </a>
  </li>







  <li class="md-nav__item">
    <a href="../../../kernel/bypass_smep-zh/" title="bypass-smep" class="md-nav__link">
      bypass-smep
    </a>
  </li>







  <li class="md-nav__item">
    <a href="../../../kernel/double-fetch-zh/" title="Double Fetch" class="md-nav__link">
      Double Fetch
    </a>
  </li>


      </ul>
    </nav>
  </li>







  <li class="md-nav__item md-nav__item--nested">

      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-8-2-10" type="checkbox" id="nav-8-2-10">

    <label class="md-nav__link" for="nav-8-2-10">
      arm-pwn
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="3">
      <label class="md-nav__title" for="nav-8-2-10">
        arm-pwn
      </label>
      <ul class="md-nav__list" data-md-scrollfix>







  <li class="md-nav__item">
    <a href="../../../arm/environment-zh/" title="Environment Setup" class="md-nav__link">
      Environment Setup
    </a>
  </li>







  <li class="md-nav__item">
    <a href="../../../arm/arm_rop-zh/" title="arm-rop" class="md-nav__link">
      arm-rop
    </a>
  </li>


      </ul>
    </nav>
  </li>







  <li class="md-nav__item md-nav__item--nested">

      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-8-2-11" type="checkbox" id="nav-8-2-11">

    <label class="md-nav__link" for="nav-8-2-11">
      Summary
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="3">
      <label class="md-nav__title" for="nav-8-2-11">
        Summary
      </label>
      <ul class="md-nav__list" data-md-scrollfix>







  <li class="md-nav__item">
    <a href="../../../summary/get-address-zh/" title="Address Leaking" class="md-nav__link">
      Address Leaking
    </a>
  </li>







  <li class="md-nav__item">
    <a href="../../../summary/hijack-control-flow-zh/" title="Hijack Control Flow" class="md-nav__link">
      Hijack Control Flow
    </a>
  </li>







  <li class="md-nav__item">
    <a href="../../../summary/get-shell-zh/" title="Get Shell" class="md-nav__link">
      Get Shell
    </a>
  </li>


      </ul>
    </nav>
  </li>


      </ul>
    </nav>
  </li>







  <li class="md-nav__item md-nav__item--nested">

      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-8-3" type="checkbox" id="nav-8-3">

    <label class="md-nav__link" for="nav-8-3">
      Windows Pwn
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-8-3">
        Windows Pwn
      </label>
      <ul class="md-nav__list" data-md-scrollfix>







  <li class="md-nav__item">
    <a href="../../../../windows/readme-zh/" title="Overview" class="md-nav__link">
      Overview
    </a>
  </li>







  <li class="md-nav__item md-nav__item--nested">

      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-8-3-2" type="checkbox" id="nav-8-3-2">

    <label class="md-nav__link" for="nav-8-3-2">
      Stack Overflow
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="3">
      <label class="md-nav__title" for="nav-8-3-2">
        Stack Overflow
      </label>
      <ul class="md-nav__list" data-md-scrollfix>







  <li class="md-nav__item">
    <a href="../../../../windows/stackoverflow/stack-introduce-zh/" title="Stack Introduction" class="md-nav__link">
      Stack Introduction
    </a>
  </li>







  <li class="md-nav__item">
    <a href="../../../../windows/stackoverflow/stackoverflow-basic-zh/" title="Stack Overflow Principle" class="md-nav__link">
      Stack Overflow Principle
    </a>
  </li>







  <li class="md-nav__item">
    <a href="../../../../windows/stackoverflow/shellcode-in-stack-zh/" title="shellcode-in-stack" class="md-nav__link">
      shellcode-in-stack
    </a>
  </li>


      </ul>
    </nav>
  </li>


      </ul>
    </nav>
  </li>


      </ul>
    </nav>
  </li>







  <li class="md-nav__item md-nav__item--nested">

      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-9" type="checkbox" id="nav-9">

    <label class="md-nav__link" for="nav-9">
      Android
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-9">
        Android
      </label>
      <ul class="md-nav__list" data-md-scrollfix>







  <li class="md-nav__item">
    <a href="../../../../../android/basic_develop/basic_develop-zh/" title="Android Development Basics" class="md-nav__link">
      Android Development Basics
    </a>
  </li>







  <li class="md-nav__item md-nav__item--nested">

      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-9-2" type="checkbox" id="nav-9-2">

    <label class="md-nav__link" for="nav-9-2">
      Android Application Operating Mechanism Brief
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-9-2">
        Android Application Operating Mechanism Brief
      </label>
      <ul class="md-nav__list" data-md-scrollfix>







  <li class="md-nav__item">
    <a href="../../../../../android/basic_operating_mechanism/readme-zh/" title="Basics" class="md-nav__link">
      Basics
    </a>
  </li>







  <li class="md-nav__item md-nav__item--nested">

      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-9-2-2" type="checkbox" id="nav-9-2-2">

    <label class="md-nav__link" for="nav-9-2-2">
      The Operating Mechanism of the Java Layer in Android
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="3">
      <label class="md-nav__title" for="nav-9-2-2">
        The Operating Mechanism of the Java Layer in Android
      </label>
      <ul class="md-nav__list" data-md-scrollfix>







  <li class="md-nav__item">
    <a href="../../../../../android/basic_operating_mechanism/java_layer/readme-zh/" title="Andriod Native" class="md-nav__link">
      Andriod Native
    </a>
  </li>







  <li class="md-nav__item">
    <a href="../../../../../android/basic_operating_mechanism/java_layer/smali/smali-zh/" title="Smali Introduction" class="md-nav__link">
      Smali Introduction
    </a>
  </li>







  <li class="md-nav__item md-nav__item--nested">

      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-9-2-2-3" type="checkbox" id="nav-9-2-2-3">

    <label class="md-nav__link" for="nav-9-2-2-3">
      Dex and ODEX
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="4">
      <label class="md-nav__title" for="nav-9-2-2-3">
        Dex and ODEX
      </label>
      <ul class="md-nav__list" data-md-scrollfix>







  <li class="md-nav__item">
    <a href="../../../../../android/basic_operating_mechanism/java_layer/dex/dex-zh/" title="DEX" class="md-nav__link">
      DEX
    </a>
  </li>







  <li class="md-nav__item">
    <a href="../../../../../android/basic_operating_mechanism/java_layer/dex/odex-zh/" title="ODEX" class="md-nav__link">
      ODEX
    </a>
  </li>


      </ul>
    </nav>
  </li>


      </ul>
    </nav>
  </li>







  <li class="md-nav__item md-nav__item--nested">

      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-9-2-3" type="checkbox" id="nav-9-2-3">

    <label class="md-nav__link" for="nav-9-2-3">
      Android Native Layer Introduction
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="3">
      <label class="md-nav__title" for="nav-9-2-3">
        Android Native Layer Introduction
      </label>
      <ul class="md-nav__list" data-md-scrollfix>







  <li class="md-nav__item">
    <a href="../../../../../android/basic_operating_mechanism/native_layer/so-zh/" title="Android SO" class="md-nav__link">
      Android SO
    </a>
  </li>


      </ul>
    </nav>
  </li>







  <li class="md-nav__item md-nav__item--nested">

      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-9-2-4" type="checkbox" id="nav-9-2-4">

    <label class="md-nav__link" for="nav-9-2-4">
      Android Reverse Basic Introduction
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="3">
      <label class="md-nav__title" for="nav-9-2-4">
        Android Reverse Basic Introduction
      </label>
      <ul class="md-nav__list" data-md-scrollfix>







  <li class="md-nav__item">
    <a href="../../../../../android/basic_reverse/overview-zh/" title="Brief Description" class="md-nav__link">
      Brief Description
    </a>
  </li>







  <li class="md-nav__item">
    <a href="../../../../../android/basic_reverse/android_code_location-zh/" title="Android Key Part Location" class="md-nav__link">
      Android Key Part Location
    </a>
  </li>







  <li class="md-nav__item md-nav__item--nested">

      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-9-2-4-3" type="checkbox" id="nav-9-2-4-3">

    <label class="md-nav__link" for="nav-9-2-4-3">
      Android Simple Static Analysis
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="4">
      <label class="md-nav__title" for="nav-9-2-4-3">
        Android Simple Static Analysis
      </label>
      <ul class="md-nav__list" data-md-scrollfix>







  <li class="md-nav__item">
    <a href="../../../../../android/basic_reverse/static/java-example-zh/" title="Android Java Layer Static Analysis" class="md-nav__link">
      Android Java Layer Static Analysis
    </a>
  </li>







  <li class="md-nav__item">
    <a href="../../../../../android/basic_reverse/static/so-example-zh/" title="Android Native Layer Static Analysis" class="md-nav__link">
      Android Native Layer Static Analysis
    </a>
  </li>







  <li class="md-nav__item">
    <a href="../../../../../android/basic_reverse/static/complex-example-zh/" title="Android Static Analysis Hybrid Example" class="md-nav__link">
      Android Static Analysis Hybrid Example
    </a>
  </li>


      </ul>
    </nav>
  </li>







  <li class="md-nav__item md-nav__item--nested">

      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-9-2-4-4" type="checkbox" id="nav-9-2-4-4">

    <label class="md-nav__link" for="nav-9-2-4-4">
      Android Simple Dynamic Analysis
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="4">
      <label class="md-nav__title" for="nav-9-2-4-4">
        Android Simple Dynamic Analysis
      </label>
      <ul class="md-nav__list" data-md-scrollfix>







  <li class="md-nav__item">
    <a href="../../../../../android/basic_reverse/dynamic/dynamic_debug-zh/" title="Dynamic Debugging" class="md-nav__link">
      Dynamic Debugging
    </a>
  </li>







  <li class="md-nav__item">
    <a href="../../../../../android/basic_reverse/dynamic/ida_native_debug-zh/" title="Android Dynamic Debugging SO" class="md-nav__link">
      Android Dynamic Debugging SO
    </a>
  </li>


      </ul>
    </nav>
  </li>


      </ul>
    </nav>
  </li>


      </ul>
    </nav>
  </li>


      </ul>
    </nav>
  </li>







  <li class="md-nav__item md-nav__item--nested">

      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-10" type="checkbox" id="nav-10">

    <label class="md-nav__link" for="nav-10">
      ICS
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-10">
        ICS
      </label>
      <ul class="md-nav__list" data-md-scrollfix>







  <li class="md-nav__item">
    <a href="../../../../../ics/ctfs-zh/" title="ICS_CTF Contest" class="md-nav__link">
      ICS_CTF Contest
    </a>
  </li>







  <li class="md-nav__item">
    <a href="../../../../../ics/discover-zh/" title="ICS_CTF found" class="md-nav__link">
      ICS_CTF found
    </a>
  </li>







  <li class="md-nav__item">
    <a href="../../../../../ics/exploit-zh/" title="ICS_CTF uses" class="md-nav__link">
      ICS_CTF uses
    </a>
  </li>







  <li class="md-nav__item">
    <a href="../../../../../ics/learn-zh/" title="ICS_CTF Learning Resources" class="md-nav__link">
      ICS_CTF Learning Resources
    </a>
  </li>


      </ul>
    </nav>
  </li>


  </ul>
</nav>
                  </div>
                </div>
              </div>


              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">

<nav class="md-nav md-nav--secondary">





    <label class="md-nav__title" for="__toc">目录</label>
    <ul class="md-nav__list" data-md-scrollfix>

        <li class="md-nav__item">
  <a href="#__libc_malloc" class="md-nav__link">
    __libc_malloc
  </a>

</li>

        <li class="md-nav__item">
  <a href="#_int_malloc" class="md-nav__link">
    _int_malloc
  </a>

    <nav class="md-nav">
      <ul class="md-nav__list">

          <li class="md-nav__item">
  <a href="#arena" class="md-nav__link">
    arena
  </a>

</li>

          <li class="md-nav__item">
  <a href="#fast-bin" class="md-nav__link">
    fast bin
  </a>

</li>

          <li class="md-nav__item">
  <a href="#small-bin" class="md-nav__link">
    small bin
  </a>

</li>

          <li class="md-nav__item">
  <a href="#large-bin" class="md-nav__link">
    large bin
  </a>

</li>

          <li class="md-nav__item">
  <a href="#big-loop-traversing-unsorted-bin" class="md-nav__link">
    Big loop - traversing unsorted bin
  </a>

    <nav class="md-nav">
      <ul class="md-nav__list">

          <li class="md-nav__item">
  <a href="#unsorted-bin-traversing" class="md-nav__link">
    unsorted bin Traversing
  </a>

    <nav class="md-nav">
      <ul class="md-nav__list">

          <li class="md-nav__item">
  <a href="#small-request" class="md-nav__link">
    small request
  </a>

</li>

          <li class="md-nav__item">
  <a href="#initial-take-out" class="md-nav__link">
    Initial take out
  </a>

</li>

          <li class="md-nav__item">
  <a href="#exact-fit" class="md-nav__link">
    exact fit
  </a>

</li>

          <li class="md-nav__item">
  <a href="#place-chunk-in-small-bin" class="md-nav__link">
    place chunk in small bin
  </a>

</li>

          <li class="md-nav__item">
  <a href="#place-chunk-in-large-bin" class="md-nav__link">
    place chunk in large bin
  </a>

</li>

          <li class="md-nav__item">
  <a href="#final-take-out" class="md-nav__link">
    Final take out
  </a>

</li>

          <li class="md-nav__item">
  <a href="#while-iterations" class="md-nav__link">
    while Iterations
  </a>

</li>

      </ul>
    </nav>

</li>

          <li class="md-nav__item">
  <a href="#large-chunk" class="md-nav__link">
    large chunk
  </a>

</li>

          <li class="md-nav__item">
  <a href="#looking-for-a-larger-chunk" class="md-nav__link">
    Looking for a larger chunk
  </a>

    <nav class="md-nav">
      <ul class="md-nav__list">

          <li class="md-nav__item">
  <a href="#find-a-suitable-map" class="md-nav__link">
    Find a suitable map
  </a>

</li>

          <li class="md-nav__item">
  <a href="#find-the-right-bin" class="md-nav__link">
    Find the right bin
  </a>

</li>

          <li class="md-nav__item">
  <a href="#simple-check-chunk" class="md-nav__link">
    Simple check chunk
  </a>

</li>

          <li class="md-nav__item">
  <a href="#really-take-out-chunk" class="md-nav__link">
    Really take out chunk
  </a>

</li>

      </ul>
    </nav>

</li>

      </ul>
    </nav>

</li>

          <li class="md-nav__item">
  <a href="#using-top-chunk" class="md-nav__link">
    Using top chunk
  </a>

</li>

          <li class="md-nav__item">
  <a href="#heap-memory-is-not-enough" class="md-nav__link">
    Heap memory is not enough
  </a>

</li>

      </ul>
    </nav>

</li>

        <li class="md-nav__item">
  <a href="#_libc_calloc" class="md-nav__link">
    _libc_calloc
  </a>

</li>

        <li class="md-nav__item">
  <a href="#sysmalloc" class="md-nav__link">
    sysmalloc
  </a>

    <nav class="md-nav">
      <ul class="md-nav__list">

          <li class="md-nav__item">
  <a href="#basic-definition" class="md-nav__link">
    Basic definition
  </a>

</li>

          <li class="md-nav__item">
  <a href="#consider-mmap" class="md-nav__link">
    Consider mmap
  </a>

</li>

          <li class="md-nav__item">
  <a href="#mmap-failed-or-unallocated-heap" class="md-nav__link">
    mmap failed or unallocated heap
  </a>

</li>

          <li class="md-nav__item">
  <a href="#recording-old-heap-information" class="md-nav__link">
    Recording old heap information
  </a>

</li>

          <li class="md-nav__item">
  <a href="#check-old-heap-information-1" class="md-nav__link">
    Check old heap information 1
  </a>

</li>

          <li class="md-nav__item">
  <a href="#check-old-heap-information-2" class="md-nav__link">
    Check old heap information 2
  </a>

</li>

          <li class="md-nav__item">
  <a href="#non-main_arena" class="md-nav__link">
    Non main_arena
  </a>

</li>

          <li class="md-nav__item">
  <a href="#main_arena-processing" class="md-nav__link">
    Main_arena Processing
  </a>

    <nav class="md-nav">
      <ul class="md-nav__list">

          <li class="md-nav__item">
  <a href="#calculating-memory" class="md-nav__link">
    Calculating memory
  </a>

</li>

          <li class="md-nav__item">
  <a href="#whether-it-is-continuous" class="md-nav__link">
    Whether it is continuous
  </a>

</li>

          <li class="md-nav__item">
  <a href="#align-page-size" class="md-nav__link">
    Align page size
  </a>

</li>

          <li class="md-nav__item">
  <a href="#applying-for-memory" class="md-nav__link">
    Applying for memory
  </a>

    <nav class="md-nav">
      <ul class="md-nav__list">

          <li class="md-nav__item">
  <a href="#may-succeed" class="md-nav__link">
    May succeed
  </a>

</li>

          <li class="md-nav__item">
  <a href="#failed" class="md-nav__link">
    Failed
  </a>

</li>

      </ul>
    </nav>

</li>

          <li class="md-nav__item">
  <a href="#memory-may-be-applied-successfully" class="md-nav__link">
    Memory may be applied successfully
  </a>

    <nav class="md-nav">
      <ul class="md-nav__list">

          <li class="md-nav__item">
  <a href="#situation-1" class="md-nav__link">
    Situation 1
  </a>

</li>

          <li class="md-nav__item">
  <a href="#case-2-unexpected-memory-exhaustion" class="md-nav__link">
    Case 2 - Unexpected memory exhaustion
  </a>

</li>

          <li class="md-nav__item">
  <a href="#handling-other-unexpected-situations" class="md-nav__link">
    Handling other unexpected situations
  </a>

    <nav class="md-nav">
      <ul class="md-nav__list">

          <li class="md-nav__item">
  <a href="#processing-contiguous-memory" class="md-nav__link">
    Processing contiguous memory
  </a>

</li>

          <li class="md-nav__item">
  <a href="#handling-discontinuous-memory" class="md-nav__link">
    Handling discontinuous memory
  </a>

</li>

          <li class="md-nav__item">
  <a href="#adjustment" class="md-nav__link">
    Adjustment
  </a>

</li>

      </ul>
    </nav>

</li>

      </ul>
    </nav>

</li>

          <li class="md-nav__item">
  <a href="#update-maximum-memory" class="md-nav__link">
    Update maximum memory
  </a>

</li>

          <li class="md-nav__item">
  <a href="#allocating-memory-blocks" class="md-nav__link">
    Allocating memory blocks
  </a>

    <nav class="md-nav">
      <ul class="md-nav__list">

          <li class="md-nav__item">
  <a href="#get-the-size" class="md-nav__link">
    Get the size
  </a>

</li>

          <li class="md-nav__item">
  <a href="#top" class="md-nav__link">
    切分 top
  </a>

</li>

      </ul>
    </nav>

</li>

          <li class="md-nav__item">
  <a href="#capture-all-errors" class="md-nav__link">
    Capture all errors
  </a>

</li>

      </ul>
    </nav>

</li>

      </ul>
    </nav>

</li>





        <li class="md-nav__item">
          <a href="#__comments" class="md-nav__link md-nav__link--active">
            评论
          </a>
        </li>

    </ul>

</nav>
                  </div>
                </div>
              </div>


          <div class="md-content">
            <article class="md-content__inner md-typeset">


                  <a href="https://github.com/ctf-wiki/ctf-wiki/blob/master/docs/pwn/linux/glibc-heap/implementation/malloc.md" title="编辑此页" class="md-icon md-content__icon">&#xE3C9;</a>


                <p><a href="./">EN</a> | <a href="../malloc-zh/">ZH</a></p>
<h1 id="apply-for-a-memory-block">Apply for a memory block<a class="headerlink" href="#apply-for-a-memory-block" title="Permanent link">&para;</a></h1>
<h2 id="__libc_malloc">__libc_malloc<a class="headerlink" href="#__libc_malloc" title="Permanent link">&para;</a></h2>
<p>In general, we will use the malloc function to apply for a block of memory, but when we look closely at the source implementation of glibc, there is actually no malloc function. In fact, the function actually calls the __libc_malloc function. Why not just write a malloc function directly, because sometimes we may need different names. In addition, the __libc_malloc function is simply used to simply wrap the _int_malloc function. _int_malloc is the core of the application memory block. Let's take a closer look at the specific implementation.</p>
<p>This function first checks if there is a hook function (__malloc_hook) for the memory allocation function. This is mainly used for user-defined heap allocation functions, which is convenient for users to quickly modify and evaluate the allocation function. It should be noted here that the <strong> user-applied byte becomes an unsigned integer</strong> once it enters the application memory function.</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// wapper for int_malloc</span>

<span class="kt">void</span> <span class="o">*</span><span class="nf">__libc_malloc</span><span class="p">(</span><span class="kt">size_t</span> <span class="n">bytes</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">mstate</span> <span class="n">ar_ptr</span><span class="p">;</span>
    <span class="kt">void</span> <span class="o">*</span> <span class="n">victim</span><span class="p">;</span>

    <span class="c1">// Check if there is a memory allocation hook, if so, call the hook and return.</span>
    <span class="kt">void</span> <span class="o">*</span><span class="p">(</span><span class="o">*</span><span class="n">hook</span><span class="p">)(</span><span class="kt">size_t</span><span class="p">,</span> <span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="o">=</span> <span class="n">atomic_forced_read</span><span class="p">(</span><span class="n">__malloc_hook</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">__builtin_expect</span><span class="p">(</span><span class="n">hook</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
        <span class="k">return</span> <span class="p">(</span><span class="o">*</span><span class="n">hook</span><span class="p">)(</span><span class="n">bytes</span><span class="p">,</span> <span class="n">RETURN_ADDRESS</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>
</code></pre></div>

<p>Then I will look for an arena to try to allocate memory.</p>
<div class="codehilite"><pre><span></span><code>    <span class="n">arena_get</span><span class="p">(</span><span class="n">ar_ptr</span><span class="p">,</span> <span class="n">bytes</span><span class="p">);</span>
</code></pre></div>

<p>Then call the _int_malloc function to request the corresponding memory.</p>
<div class="codehilite"><pre><span></span><code>    <span class="n">victim</span> <span class="o">=</span> <span class="n">_int_malloc</span><span class="p">(</span><span class="n">ar_ptr</span><span class="p">,</span> <span class="n">bytes</span><span class="p">);</span>
</code></pre></div>

<p>If the allocation fails, ptmalloc will try to find another available arena and allocate memory.</p>
<div class="codehilite"><pre><span></span><code>    <span class="cm">/* Retry with another arena only if we were able to find a usable arena</span>
<span class="cm">       before.  */</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">victim</span> <span class="o">&amp;&amp;</span> <span class="n">ar_ptr</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">LIBC_PROBE</span><span class="p">(</span><span class="n">memory_malloc_retry</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">bytes</span><span class="p">);</span>
        <span class="n">ar_ptr</span> <span class="o">=</span> <span class="n">arena_get_retry</span><span class="p">(</span><span class="n">ar_ptr</span><span class="p">,</span> <span class="n">bytes</span><span class="p">);</span>
        <span class="n">victim</span> <span class="o">=</span> <span class="n">_int_malloc</span><span class="p">(</span><span class="n">ar_ptr</span><span class="p">,</span> <span class="n">bytes</span><span class="p">);</span>
    <span class="p">}</span>
</code></pre></div>

<p>If you apply for arena, you have to unlock it before you quit.</p>
<div class="codehilite"><pre><span></span><code>    <span class="k">if</span> <span class="p">(</span><span class="n">ar_ptr</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="n">__libc_lock_unlock</span><span class="p">(</span><span class="n">ar_ptr</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
</code></pre></div>

<p>Determine if the current status meets the following conditions</p>
<ul>
<li>Either didn't apply to memory</li>
<li>either mmap memory</li>
<li><strong>Either the requested memory must be in its assigned arena</strong></li>
</ul>
<div class="codehilite"><pre><span></span><code>    <span class="n">assert</span><span class="p">(</span><span class="o">!</span><span class="n">victim</span> <span class="o">||</span> <span class="n">chunk_is_mmapped</span><span class="p">(</span><span class="n">mem2chunk</span><span class="p">(</span><span class="n">victim</span><span class="p">))</span> <span class="o">||</span>
           <span class="n">ar_ptr</span> <span class="o">==</span> <span class="n">arena_for_chunk</span><span class="p">(</span><span class="n">mem2chunk</span><span class="p">(</span><span class="n">victim</span><span class="p">)));</span>
</code></pre></div>

<p>Finally return to memory.</p>
<div class="codehilite"><pre><span></span><code>    <span class="k">return</span> <span class="n">victim</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<h2 id="_int_malloc">_int_malloc<a class="headerlink" href="#_int_malloc" title="Permanent link">&para;</a></h2>
<p>_int_malloc is the core function of memory allocation, and its core ideas are as follows</p>
<ol>
<li>It implements different allocation methods in turn according to the <strong>memory block size</strong> and <strong>frequency of use</strong> of fastbin chunk, small chunk, large chunk of the user's application.</li>
<li>It checks from small to large whether there are corresponding free blocks in different bins to satisfy the memory requested by the user.</li>
<li>When all free chunks are not met, it considers the top chunk.</li>
<li>The heap allocator will only request the memory block when the top chunk is not satisfied.</li>
</ol>
<p>After entering the function, the function immediately defines a series of variables that you need, and converts the memory size requested by the user to the internal chunk size.</p>
<div class="codehilite"><pre><span></span><code><span class="k">static</span> <span class="kt">void</span> <span class="o">*</span><span class="nf">_int_malloc</span><span class="p">(</span><span class="n">mstate</span> <span class="n">av</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">bytes</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">INTERNAL_SIZE_T</span> <span class="n">nb</span><span class="p">;</span>  <span class="cm">/* normalized request size */</span>
    <span class="kt">unsigned</span> <span class="kt">int</span>    <span class="n">idx</span><span class="p">;</span> <span class="cm">/* associated bin index */</span>
    <span class="n">mbinptr</span>         <span class="n">bin</span><span class="p">;</span> <span class="cm">/* associated bin */</span>

    <span class="n">mchunkptr</span>       <span class="n">victim</span><span class="p">;</span>       <span class="cm">/* inspected/selected chunk */</span>
    <span class="n">INTERNAL_SIZE_T</span> <span class="n">size</span><span class="p">;</span>         <span class="cm">/* its size */</span>
    <span class="kt">int</span>             <span class="n">victim_index</span><span class="p">;</span> <span class="cm">/* its bin index */</span>

    <span class="n">mchunkptr</span>     <span class="n">remainder</span><span class="p">;</span>      <span class="cm">/* remainder from a split */</span>
    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">remainder_size</span><span class="p">;</span> <span class="cm">/* its size */</span>

    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">block</span><span class="p">;</span> <span class="cm">/* bit map traverser */</span>
    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">bit</span><span class="p">;</span>   <span class="cm">/* bit map traverser */</span>
    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">map</span><span class="p">;</span>   <span class="cm">/* current word of binmap */</span>

    <span class="n">mchunkptr</span> <span class="n">fwd</span><span class="p">;</span> <span class="cm">/* misc temp for linking */</span>
    <span class="n">mchunkptr</span> <span class="n">bck</span><span class="p">;</span> <span class="cm">/* misc temp for linking */</span>

    <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">errstr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

    <span class="cm">/*</span>
<span class="cm">       Convert request size to internal form by adding SIZE_SZ bytes</span>
<span class="cm">       overhead plus possibly more to obtain necessary alignment and/or</span>
<span class="cm">       to obtain a size of at least MINSIZE, the smallest allocatable</span>
<span class="cm">       size. Also, checked_request2size traps (returning 0) request sizes</span>
<span class="cm">       that are so large that they wrap around zero when padded and</span>
<span class="cm">       aligned.</span>
<span class="cm">     */</span>

    <span class="n">checked_request2size</span><span class="p">(</span><span class="n">bytes</span><span class="p">,</span> <span class="n">nb</span><span class="p">);</span>
</code></pre></div>

<h3 id="arena">arena<a class="headerlink" href="#arena" title="Permanent link">&para;</a></h3>
<div class="codehilite"><pre><span></span><code>    <span class="cm">/* There are no usable arenas.  Fall back to sysmalloc to get a chunk from</span>
<span class="cm">       mmap.  */</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">__glibc_unlikely</span><span class="p">(</span><span class="n">av</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">))</span> <span class="p">{</span>
        <span class="kt">void</span> <span class="o">*</span> <span class="n">p</span> <span class="o">=</span> <span class="n">sysmalloc</span><span class="p">(</span><span class="n">nb</span><span class="p">,</span> <span class="n">av</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">p</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="n">alloc_perturb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">bytes</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">p</span><span class="p">;</span>
    <span class="p">}</span>
</code></pre></div>

<h3 id="fast-bin">fast bin<a class="headerlink" href="#fast-bin" title="Permanent link">&para;</a></h3>
<p>If the size of the requested chunk is in the fastbin range, <strong> note that the comparison here is an unsigned integer</strong>. <strong> In addition, chunk</strong> is taken from the head node of fastbin.</p>
<div class="codehilite"><pre><span></span><code>    <span class="cm">/*</span>
<span class="cm">       If the size qualifies as a fastbin, first check corresponding bin.</span>
<span class="cm">       This code is safe to execute even if av is not yet initialized, so we</span>
<span class="cm">       can try it without checking, which saves some time on this fast path.</span>
<span class="cm">     */</span>
    <span class="k">if</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="p">(</span><span class="n">nb</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="p">(</span><span class="n">get_max_fast</span><span class="p">()))</span> <span class="p">{</span>
        <span class="c1">// Get the corresponding subscript of fastbin</span>
        <span class="n">idx</span>             <span class="o">=</span> <span class="n">fastbin_index</span><span class="p">(</span><span class="n">nb</span><span class="p">);</span>
        <span class="c1">// Get the corresponding pointer to the fastbin</span>
        <span class="n">mfastbinptr</span> <span class="o">*</span> <span class="n">fb</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">fastbin</span><span class="p">(</span><span class="n">av</span><span class="p">,</span> <span class="n">idx</span><span class="p">);</span>
        <span class="n">mchunkptr</span>    <span class="n">pp</span> <span class="o">=</span> <span class="o">*</span><span class="n">fb</span><span class="p">;</span>
        <span class="c1">// Use fd to traverse the corresponding bin whether there are free chunks,</span>
        <span class="k">do</span> <span class="p">{</span>
            <span class="n">victim</span> <span class="o">=</span> <span class="n">pp</span><span class="p">;</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">victim</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">while</span> <span class="p">((</span><span class="n">pp</span> <span class="o">=</span> <span class="n">catomic_compare_and_exchange_val_acq</span><span class="p">(</span><span class="n">fb</span><span class="p">,</span> <span class="n">victim</span><span class="o">-&gt;</span><span class="n">fd</span><span class="p">,</span>
                                                            <span class="n">victim</span><span class="p">))</span> <span class="o">!=</span> <span class="n">victim</span><span class="p">);</span>
        <span class="c1">// There are chunks that can be used</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">victim</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
            <span class="c1">// Check if the chunk size retrieved is consistent with the corresponding fastbin index.</span>
            <span class="c1">// Calculate its size using chunksize based on the obtained victim.</span>
            <span class="c1">// Calculate the index of the chunk using fastbin_index.</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">__builtin_expect</span><span class="p">(</span><span class="n">fastbin_index</span><span class="p">(</span><span class="n">chunksize</span><span class="p">(</span><span class="n">victim</span><span class="p">))</span> <span class="o">!=</span> <span class="n">idx</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
                <span class="n">errstr</span> <span class="o">=</span> <span class="s">&quot;malloc(): memory corruption (fast)&quot;</span><span class="p">;</span>

            <span class="nl">errout</span><span class="p">:</span>
                <span class="n">malloc_printerr</span><span class="p">(</span><span class="n">check_action</span><span class="p">,</span> <span class="n">errstr</span><span class="p">,</span> <span class="n">chunk2mem</span><span class="p">(</span><span class="n">victim</span><span class="p">),</span> <span class="n">av</span><span class="p">);</span>
                <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="c1">// Careful inspection. . Useful only when DEBUG</span>
            <span class="n">check_remalloced_chunk</span><span class="p">(</span><span class="n">av</span><span class="p">,</span> <span class="n">victim</span><span class="p">,</span> <span class="n">nb</span><span class="p">);</span>
            <span class="c1">// Convert the obtained chunk to mem mode</span>
            <span class="kt">void</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">chunk2mem</span><span class="p">(</span><span class="n">victim</span><span class="p">);</span>
            <span class="c1">// If perturb_type is set, the obtained chunk is initialized to perturb_type ^ 0xff</span>
            <span class="n">alloc_perturb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">bytes</span><span class="p">);</span>
            <span class="k">return</span> <span class="n">p</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
</code></pre></div>

<h3 id="small-bin">small bin<a class="headerlink" href="#small-bin" title="Permanent link">&para;</a></h3>
<p>If the range of the obtained memory block is in the range of the small bin, then the following process is performed.</p>
<div class="codehilite"><pre><span></span><code>    <span class="cm">/*</span>
<span class="cm">       If a small request, check regular bin.  Since these &quot;smallbins&quot;</span>
<span class="cm">       hold one size each, no searching within bins is necessary.</span>
<span class="cm">       (For a large request, we need to wait until unsorted chunks are</span>
<span class="cm">       processed to find best fit. But for small ones, fits are exact</span>
<span class="cm">       anyway, so we can check now, which is faster.)</span>
<span class="cm">     */</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">in_smallbin_range</span><span class="p">(</span><span class="n">nb</span><span class="p">))</span> <span class="p">{</span>
        <span class="c1">// Get the index of the small bin</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="n">smallbin_index</span><span class="p">(</span><span class="n">nb</span><span class="p">);</span>
        <span class="c1">// Get the corresponding chunk pointer in the small bin</span>
        <span class="n">bin</span> <span class="o">=</span> <span class="n">bin_at</span><span class="p">(</span><span class="n">av</span><span class="p">,</span> <span class="n">idx</span><span class="p">);</span>
        <span class="c1">// first execute victim = last(bin) to get the last chunk of the small bin</span>
        <span class="c1">// If victim = bin , then the bin is empty.</span>
        <span class="c1">// If they are not equal, then there will be two cases</span>
        <span class="k">if</span> <span class="p">((</span><span class="n">victim</span> <span class="o">=</span> <span class="n">last</span><span class="p">(</span><span class="n">bin</span><span class="p">))</span> <span class="o">!=</span> <span class="n">bin</span><span class="p">)</span> <span class="p">{</span>
            <span class="c1">// In the first case, the small bin has not yet been initialized.</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">victim</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="cm">/* initialization check */</span>
                <span class="c1">// Perform initialization to merge chunks in fast bins</span>
                <span class="n">malloc_consolidate</span><span class="p">(</span><span class="n">av</span><span class="p">);</span>
            <span class="c1">// In the second case, there is a free chunk in the small bin</span>
            <span class="k">else</span> <span class="p">{</span>
                <span class="c1">// Get the second-to-last chunk in the small bin.</span>
                <span class="n">bck</span> <span class="o">=</span> <span class="n">victim</span><span class="o">-&gt;</span><span class="n">bk</span><span class="p">;</span>
                <span class="c1">// Check if bck-&gt;fd is victim, prevent forgery</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">__glibc_unlikely</span><span class="p">(</span><span class="n">bck</span><span class="o">-&gt;</span><span class="n">fd</span> <span class="o">!=</span> <span class="n">victim</span><span class="p">))</span> <span class="p">{</span>
                    <span class="n">errstr</span> <span class="o">=</span> <span class="s">&quot;malloc(): smallbin double linked list corrupted&quot;</span><span class="p">;</span>
                    <span class="k">goto</span> <span class="n">errout</span><span class="p">;</span>
                <span class="p">}</span>
                <span class="c1">// Set the corresponding inuse bit of victim</span>
                <span class="n">set_inuse_bit_at_offset</span><span class="p">(</span><span class="n">victim</span><span class="p">,</span> <span class="n">nb</span><span class="p">);</span>
                <span class="c1">// Modify the small bin list, take the last chunk of the small bin</span>
                <span class="n">bin</span><span class="o">-&gt;</span><span class="n">bk</span> <span class="o">=</span> <span class="n">bck</span><span class="p">;</span>
                <span class="n">bck</span><span class="o">-&gt;</span><span class="n">fd</span> <span class="o">=</span> <span class="n">bin</span><span class="p">;</span>
                <span class="c1">// If it is not main_arena, set the corresponding flag</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">av</span> <span class="o">!=</span> <span class="o">&amp;</span><span class="n">main_arena</span><span class="p">)</span> <span class="n">set_non_main_arena</span><span class="p">(</span><span class="n">victim</span><span class="p">);</span>
                <span class="c1">// Detailed inspection, non-debug status has no effect</span>
                <span class="n">check_malloced_chunk</span><span class="p">(</span><span class="n">av</span><span class="p">,</span> <span class="n">victim</span><span class="p">,</span> <span class="n">nb</span><span class="p">);</span>
                <span class="c1">// Convert the requested chunk to the corresponding mem state</span>
                <span class="kt">void</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">chunk2mem</span><span class="p">(</span><span class="n">victim</span><span class="p">);</span>
                <span class="c1">// If perturb_type is set, the obtained chunk is initialized to perturb_type ^ 0xff</span>
                <span class="n">alloc_perturb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">bytes</span><span class="p">);</span>
                <span class="k">return</span> <span class="n">p</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
</code></pre></div>

<h3 id="large-bin">large bin<a class="headerlink" href="#large-bin" title="Permanent link">&para;</a></h3>
<p>When the chunks in the fast bin and small bin cannot satisfy the user request chunk hour, it will consider whether it is a large bin. However, in the large bin, there is no direct scan of the chunk in the corresponding bin. Instead, the malloc_consolidate(see malloc_state related function) function is used to process the chunk in the fast bin, and the chunks that may be merged are merged and then placed. In the unsorted bin, if you can't merge, put it directly into the unsorted bin, and then process it in the big loop below. <strong> Why not just take the large chunk directly from the corresponding bin? This is the mechanism of ptmalloc, which merges fragment chunks in the heap before allocating large chunks to reduce fragmentation in the heap. </strong></p>
<div class="codehilite"><pre><span></span><code>    <span class="cm">/*</span>
<span class="cm">       If this is a large request, consolidate fastbins before continuing.</span>
<span class="cm">       While it might look excessive to kill all fastbins before</span>
<span class="cm">       even seeing if there is space available, this avoids</span>
<span class="cm">       fragmentation problems normally associated with fastbins.</span>
<span class="cm">       Also, in practice, programs tend to have runs of either small or</span>
<span class="cm">       large requests, but less often mixtures, so consolidation is not</span>
<span class="cm">       invoked all that often in most programs. And the programs that</span>
<span class="cm">       it is called frequently in otherwise tend to fragment.</span>
<span class="cm">     */</span>

    <span class="k">else</span> <span class="p">{</span>
        <span class="c1">// Get the subscript of the large bin.</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="n">largebin_index</span><span class="p">(</span><span class="n">nb</span><span class="p">);</span>
        <span class="c1">// If there is fastbin, it will handle fastbin</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">have_fastchunks</span><span class="p">(</span><span class="n">av</span><span class="p">))</span> <span class="n">malloc_consolidate</span><span class="p">(</span><span class="n">av</span><span class="p">);</span>
    <span class="p">}</span>
</code></pre></div>

<h3 id="big-loop-traversing-unsorted-bin">Big loop - traversing unsorted bin<a class="headerlink" href="#big-loop-traversing-unsorted-bin" title="Permanent link">&para;</a></h3>
<p>**If the program is executed here, it means that there is no chunk in the bin (fast bin, small bin) that is exactly the same as the chunk size, which can directly satisfy the demand, but the large chunk is processed in this big loop.</p>
<p>In the next cycle, the main operations are as follows</p>
<ul>
<li>Take the chunks in the unsorted bin one by one in the FIFO mode</li>
<li>If it is a small request, consider whether it is just satisfied, if it is, return directly.</li>
<li>If not, put it in the corresponding bin.</li>
<li>Try to allocate the memory required by the user from the large bin</li>
</ul>
<p>This part is a big loop, this is to try to redistribute the small bin chunk, because we will first use the large bin, top chunk to try to satisfy the user's request, but if it is not satisfied, because we did not assign it successfully Small bin, we didn't merge the chunks in the fast bin, so we'll merge the fast bin chunks and use a big loop to try to allocate the small bin chunk again.</p>
<div class="codehilite"><pre><span></span><code>    <span class="cm">/*</span>
<span class="cm">       Process recently freed or remaindered chunks, taking one only if</span>
<span class="cm">       it is exact fit, or, if this a small request, the chunk is remainder from</span>
<span class="cm">       the most recent non-exact fit.  Place other traversed chunks in</span>
<span class="cm">       bins.  Note that this step is the only place in any routine where</span>
<span class="cm">       chunks are placed in bins.</span>

<span class="cm">       The outer loop here is needed because we might not realize until</span>
<span class="cm">       near the end of malloc that we should have consolidated, so must</span>
<span class="cm">       do so and retry. This happens at most once, and only when we would</span>
<span class="cm">       otherwise need to expand memory to service a &quot;small&quot; request.</span>
<span class="cm">     */</span>

    <span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>
        <span class="kt">int</span> <span class="n">iters</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</code></pre></div>

<h4 id="unsorted-bin-traversing">unsorted bin Traversing<a class="headerlink" href="#unsorted-bin-traversing" title="Permanent link">&para;</a></h4>
<p>Consider the unsorted bin first, then consider the last remainder, but there are exceptions to the request for the small bin chunk.</p>
<p><strong> Note that the traversal order of unsorted bin is bk. </strong></p>
<div class="codehilite"><pre><span></span><code>        <span class="c1">// If the unsorted bin is not empty</span>
        <span class="c1">// First In First Out</span>
        <span class="k">while</span> <span class="p">((</span><span class="n">victim</span> <span class="o">=</span> <span class="n">unsorted_chunks</span><span class="p">(</span><span class="n">av</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">bk</span><span class="p">)</span><span class="o">!</span> <span class="o">=</span> <span class="n">unsorted_chunks</span><span class="p">(</span><span class="n">av</span><span class="p">))</span> <span class="p">{</span>
            <span class="c1">// victim is the last chunk of unsorted bin</span>
            <span class="c1">// bck is the penultimate chunk of unsorted bin</span>
            <span class="n">bck</span> <span class="o">=</span> <span class="n">victim</span><span class="o">-&gt;</span><span class="n">bk</span><span class="p">;</span>

            <span class="c1">// Determine whether the obtained chunk meets the requirements, can not be too small, can not be too large</span>
            <span class="c1">// The size of the general system_mem is 132K</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">__builtin_expect</span><span class="p">(</span><span class="n">chunksize_nomask</span><span class="p">(</span><span class="n">victim</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">SIZE_SZ</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span>
                <span class="n">__builtin_expect</span><span class="p">(</span><span class="n">chunksize_nomask</span><span class="p">(</span><span class="n">victim</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">av</span><span class="o">-&gt;</span><span class="n">system_mem</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
                <span class="n">malloc_printerr</span><span class="p">(</span><span class="n">check_action</span><span class="p">,</span> <span class="s">&quot;malloc(): memory corruption&quot;</span><span class="p">,</span>
                                <span class="n">chunk2mem</span><span class="p">(</span><span class="n">victim</span><span class="p">),</span> <span class="n">av</span><span class="p">);</span>
            <span class="c1">// Get the chunk size corresponding to the victim.</span>
            <span class="n">size</span> <span class="o">=</span> <span class="n">chunksize</span><span class="p">(</span><span class="n">victim</span><span class="p">);</span>
</code></pre></div>

<h5 id="small-request">small request<a class="headerlink" href="#small-request" title="Permanent link">&para;</a></h5>
<p>If the user's request is a small bin chunk, then we first consider the last remainder. If the last remainder is the only one in the unsorted bin, and the size of the last remainder is enough to be a chunk, why is there no equal sign**?</p>
<div class="codehilite"><pre><span></span><code>            <span class="cm">/*</span>
<span class="cm">               If a small request, try to use last remainder if it is the</span>
<span class="cm">               only chunk in unsorted bin.  This helps promote locality for</span>
<span class="cm">               runs of consecutive small requests. This is the only</span>
<span class="cm">               exception to best-fit, and applies only when there is</span>
<span class="cm">               no exact fit for a small chunk.</span>
<span class="cm">             */</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">in_smallbin_range</span><span class="p">(</span><span class="n">nb</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">bck</span> <span class="o">==</span> <span class="n">unsorted_chunks</span><span class="p">(</span><span class="n">av</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
                <span class="n">victim</span> <span class="o">==</span> <span class="n">av</span><span class="o">-&gt;</span><span class="n">last_remainder</span> <span class="o">&amp;&amp;</span>
                <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="p">(</span><span class="n">size</span><span class="p">)</span> <span class="o">&gt;</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="p">(</span><span class="n">nb</span> <span class="o">+</span> <span class="n">MINSIZE</span><span class="p">))</span> <span class="p">{</span>
                <span class="cm">/* split and reattach remainder */</span>
                <span class="c1">// Get the size of the new retriever</span>
                <span class="n">remainder_size</span>          <span class="o">=</span> <span class="n">size</span> <span class="o">-</span> <span class="n">nb</span><span class="p">;</span>
                <span class="c1">// Get the location of the new retriever</span>
                <span class="n">remainder</span>               <span class="o">=</span> <span class="n">chunk_at_offset</span><span class="p">(</span><span class="n">victim</span><span class="p">,</span> <span class="n">nb</span><span class="p">);</span>
                <span class="c1">// update the unsorted bin</span>
                <span class="n">unsorted_chunks</span><span class="p">(</span><span class="n">av</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">bk</span> <span class="o">=</span> <span class="n">unsorted_chunks</span><span class="p">(</span><span class="n">av</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">fd</span> <span class="o">=</span> <span class="n">remainder</span><span class="p">;</span>
                <span class="c1">// update the last_remainder recorded in av</span>
                <span class="n">av</span><span class="o">-&gt;</span><span class="n">last_remainder</span> <span class="o">=</span> <span class="n">remainder</span><span class="p">;</span>
                <span class="c1">// Update the pointer of the last remainder</span>
                <span class="n">remainder</span><span class="o">-&gt;</span><span class="n">bk</span> <span class="o">=</span> <span class="n">remainder</span><span class="o">-&gt;</span><span class="n">fd</span> <span class="o">=</span> <span class="n">unsorted_chunks</span><span class="p">(</span><span class="n">av</span><span class="p">);</span>
                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">in_smallbin_range</span><span class="p">(</span><span class="n">remainder_size</span><span class="p">))</span> <span class="p">{</span>
                    <span class="n">remainder</span><span class="o">-&gt;</span><span class="n">fd_nextsize</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
                    <span class="n">remainder</span><span class="o">-&gt;</span><span class="n">bk_nextsize</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
                <span class="p">}</span>
                <span class="c1">// Set the victim&#39;s head,</span>
                <span class="n">set_head</span><span class="p">(</span><span class="n">victim</span><span class="p">,</span> <span class="n">nb</span> <span class="o">|</span> <span class="n">PREV_INUSE</span> <span class="o">|</span>
                                    <span class="p">(</span><span class="n">av</span><span class="o">!</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">main_arena</span><span class="o">?</span> <span class="nl">NON_MAIN_ARENA</span><span class="p">:</span> <span class="mi">0</span><span class="p">));</span>
                <span class="c1">// Set the head of the remainder</span>
                <span class="n">set_head</span><span class="p">(</span><span class="n">remainder</span><span class="p">,</span> <span class="n">remainder_size</span> <span class="o">|</span> <span class="n">PREV_INUSE</span><span class="p">);</span>
                <span class="c1">// Set the prev_size field of the record remainder size because the retriever is idle at this time.</span>
                <span class="n">set_foot</span><span class="p">(</span><span class="n">remainder</span><span class="p">,</span> <span class="n">remainder_size</span><span class="p">);</span>
                <span class="c1">// Detailed inspection, no effect in non-debug mode</span>
                <span class="n">check_malloced_chunk</span><span class="p">(</span><span class="n">av</span><span class="p">,</span> <span class="n">victim</span><span class="p">,</span> <span class="n">nb</span><span class="p">);</span>
                <span class="c1">// Convert victim from chunk mode to mem mode</span>
                <span class="kt">void</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">chunk2mem</span><span class="p">(</span><span class="n">victim</span><span class="p">);</span>
                <span class="c1">// If perturb_type is set, the obtained chunk is initialized to perturb_type ^ 0xff</span>
                <span class="n">alloc_perturb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">bytes</span><span class="p">);</span>
                <span class="k">return</span> <span class="n">p</span><span class="p">;</span>
            <span class="p">}</span>
</code></pre></div>

<h5 id="initial-take-out">Initial take out<a class="headerlink" href="#initial-take-out" title="Permanent link">&para;</a></h5>
<div class="codehilite"><pre><span></span><code>            <span class="cm">/* remove from unsorted list */</span>
            <span class="n">unsorted_chunks</span><span class="p">(</span><span class="n">av</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">bk</span> <span class="o">=</span> <span class="n">bck</span><span class="p">;</span>
            <span class="n">bck</span><span class="o">-&gt;</span><span class="n">fd</span> <span class="o">=</span> <span class="n">unsorted_chunks</span><span class="p">(</span><span class="n">av</span><span class="p">);</span>
</code></pre></div>

<h5 id="exact-fit">exact fit<a class="headerlink" href="#exact-fit" title="Permanent link">&para;</a></h5>
<p>If the chunk size taken from the unsorted bin is just right, use it directly. Here we should have allocated the appropriate chunks after the merger.</p>
<div class="codehilite"><pre><span></span><code>            <span class="cm">/* Take now instead of binning if exact fit */</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">==</span> <span class="n">nb</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">set_inuse_bit_at_offset</span><span class="p">(</span><span class="n">victim</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">av</span> <span class="o">!=</span> <span class="o">&amp;</span><span class="n">main_arena</span><span class="p">)</span> <span class="n">set_non_main_arena</span><span class="p">(</span><span class="n">victim</span><span class="p">);</span>
                <span class="n">check_malloced_chunk</span><span class="p">(</span><span class="n">av</span><span class="p">,</span> <span class="n">victim</span><span class="p">,</span> <span class="n">nb</span><span class="p">);</span>
                <span class="kt">void</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">chunk2mem</span><span class="p">(</span><span class="n">victim</span><span class="p">);</span>
                <span class="n">alloc_perturb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">bytes</span><span class="p">);</span>
                <span class="k">return</span> <span class="n">p</span><span class="p">;</span>
            <span class="p">}</span>
</code></pre></div>

<h5 id="place-chunk-in-small-bin">place chunk in small bin<a class="headerlink" href="#place-chunk-in-small-bin" title="Permanent link">&para;</a></h5>
<p>Put the extracted chunk into the corresponding small bin.</p>
<div class="codehilite"><pre><span></span><code>            <span class="cm">/* place chunk in bin */</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">in_smallbin_range</span><span class="p">(</span><span class="n">size</span><span class="p">))</span> <span class="p">{</span>
                <span class="n">victim_index</span> <span class="o">=</span> <span class="n">smallbin_index</span><span class="p">(</span><span class="n">size</span><span class="p">);</span>
                <span class="n">bck</span> <span class="o">=</span> <span class="n">bin_at</span><span class="p">(</span><span class="n">av</span><span class="p">,</span> <span class="n">victim_index</span><span class="p">);</span>
                <span class="n">fwd</span>          <span class="o">=</span> <span class="n">bck</span><span class="o">-&gt;</span><span class="n">fd</span><span class="p">;</span>
</code></pre></div>

<h5 id="place-chunk-in-large-bin">place chunk in large bin<a class="headerlink" href="#place-chunk-in-large-bin" title="Permanent link">&para;</a></h5>
<p>Put the fetched chunks into the corresponding large bin.</p>
<div class="codehilite"><pre><span></span><code>            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="c1">// large bin range</span>
                <span class="n">victim_index</span> <span class="o">=</span> <span class="n">largebin_index</span><span class="p">(</span><span class="n">size</span><span class="p">);</span>
                <span class="n">bck</span> <span class="o">=</span> <span class="n">bin_at</span><span class="p">(</span><span class="n">av</span><span class="p">,</span> <span class="n">victim_index</span><span class="p">);</span> <span class="c1">// the head of the current large bin</span>
                <span class="n">fwd</span>          <span class="o">=</span> <span class="n">bck</span><span class="o">-&gt;</span><span class="n">fd</span><span class="p">;</span>

                <span class="cm">/* maintain large bins in sorted order */</span>
                <span class="cm">/* From here we can conclude that largebin is sorted in descending order by fd_nextsize.</span>
<span class="cm">                The same size chunk, later will only be inserted into the same size chunk before.</span>
<span class="cm">                It is easy to understand without modifying the same size fd/bk_nextsize.</span>
<span class="cm">                Can reduce overhead. In addition, the bin header does not participate in the nextsize link. */</span>
                <span class="c1">// If the large bin list is not empty</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">fwd</span> <span class="o">!=</span> <span class="n">bck</span><span class="p">)</span> <span class="p">{</span>
                    <span class="cm">/* Or with inuse bit to speed comparisons */</span>
                    <span class="c1">// Accelerate comparisons, not only should this be considered, because the chunks in the list will set this bit.</span>
                    <span class="n">size</span> <span class="o">|=</span> <span class="n">PREV_INUSE</span><span class="p">;</span>
                    <span class="cm">/* if smaller than smallest, bypass loop below */</span>
                    <span class="c1">// bck-&gt;bk stores the smallest chunk in the corresponding large bin.</span>
                    <span class="c1">// If the traversed chunk is smaller than the current minimum, then it only needs to be inserted at the end of the list.</span>
                    <span class="c1">// Determine if bck-&gt;bk is in main arena.</span>
                    <span class="n">assert</span><span class="p">(</span><span class="n">chunk_main_arena</span><span class="p">(</span><span class="n">bck</span><span class="o">-&gt;</span><span class="n">bk</span><span class="p">));</span>
                    <span class="k">if</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="p">(</span><span class="n">size</span><span class="p">)</span> <span class="o">&lt;</span>
                        <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">chunksize_nomask</span><span class="p">(</span><span class="n">bck</span><span class="o">-&gt;</span><span class="n">bk</span><span class="p">))</span> <span class="p">{</span>
                        <span class="c1">// Let fwd point to the big bin header</span>
                        <span class="n">fwd</span> <span class="o">=</span> <span class="n">bck</span><span class="p">;</span>
                        <span class="c1">// Let bck point to the largin bin tail chunk</span>
                        <span class="n">bck</span> <span class="o">=</span> <span class="n">bck</span><span class="o">-&gt;</span><span class="n">bk</span><span class="p">;</span>
                        <span class="c1">// victim&#39;s fd_nextsize points to the first chunk of largin bin</span>
                        <span class="n">victim</span><span class="o">-&gt;</span><span class="n">fd_nextsize</span> <span class="o">=</span> <span class="n">fwd</span><span class="o">-&gt;</span><span class="n">fd</span><span class="p">;</span>
                        <span class="c1">// victim&#39;s bk_nextsize points to the bk_nextsize pointed to by the first chunk of the original list.</span>
                        <span class="n">victim</span><span class="o">-&gt;</span><span class="n">bk_nextsize</span> <span class="o">=</span> <span class="n">fwd</span><span class="o">-&gt;</span><span class="n">fd</span><span class="o">-&gt;</span><span class="n">bk_nextsize</span><span class="p">;</span>
                        <span class="c1">// The bk_nextsize of the first chunk of the original list points to the victim</span>
                        <span class="c1">// The original fd_nextsize pointing to the first chunk of the list points to victim</span>
                        <span class="n">fwd</span><span class="o">-&gt;</span><span class="n">fd</span><span class="o">-&gt;</span><span class="n">bk_nextsize</span> <span class="o">=</span>
                            <span class="n">victim</span><span class="o">-&gt;</span><span class="n">bk_nextsize</span><span class="o">-&gt;</span><span class="n">fd_nextsize</span> <span class="o">=</span> <span class="n">victim</span><span class="p">;</span>
                    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                        <span class="c1">// The size of the victim currently being inserted is larger than the smallest chunk</span>
                        <span class="c1">// Determine if fwd is in main arena</span>
                        <span class="n">assert</span><span class="p">(</span><span class="n">chunk_main_arena</span><span class="p">(</span><span class="n">fwd</span><span class="p">));</span>
                        <span class="c1">// Start from the head of the list to find a chunk that is no bigger than the victim.</span>
                        <span class="k">while</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">size</span> <span class="o">&lt;</span> <span class="n">chunksize_nomask</span><span class="p">(</span><span class="n">fwd</span><span class="p">))</span> <span class="p">{</span>
                            <span class="n">fwd</span> <span class="o">=</span> <span class="n">fwd</span><span class="o">-&gt;</span><span class="n">fd_nextsize</span><span class="p">;</span>
                            <span class="n">assert</span><span class="p">(</span><span class="n">chunk_main_arena</span><span class="p">(</span><span class="n">fwd</span><span class="p">));</span>
                        <span class="p">}</span>
                        <span class="c1">// If you find a chunk that is as big as the victim,</span>
                        <span class="c1">// Then insert the chunk directly after the chunk and don&#39;t modify the nextsize pointer.</span>
                        <span class="k">if</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">size</span> <span class="o">==</span>
                            <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">chunksize_nomask</span><span class="p">(</span><span class="n">fwd</span><span class="p">))</span>
                            <span class="cm">/* Always insert in the second position.  */</span>
                            <span class="n">fwd</span> <span class="o">=</span> <span class="n">fwd</span><span class="o">-&gt;</span><span class="n">fd</span><span class="p">;</span>
                        <span class="k">else</span> <span class="p">{</span>
                            <span class="c1">// If the chunk found is not the same size as the current victim</span>
                            <span class="c1">// Then you need to construct a nextsize doubly linked list.</span>
                            <span class="n">victim</span><span class="o">-&gt;</span><span class="n">fd_nextsize</span>              <span class="o">=</span> <span class="n">fwd</span><span class="p">;</span>
                            <span class="n">victim</span><span class="o">-&gt;</span><span class="n">bk_nextsize</span>              <span class="o">=</span> <span class="n">fwd</span><span class="o">-&gt;</span><span class="n">bk_nextsize</span><span class="p">;</span>
                            <span class="n">fwd</span><span class="o">-&gt;</span><span class="n">bk_nextsize</span>                 <span class="o">=</span> <span class="n">victim</span><span class="p">;</span>
                            <span class="n">victim</span><span class="o">-&gt;</span><span class="n">bk_nextsize</span><span class="o">-&gt;</span><span class="n">fd_nextsize</span> <span class="o">=</span> <span class="n">victim</span><span class="p">;</span>
                        <span class="p">}</span>
                        <span class="n">bck</span> <span class="o">=</span> <span class="n">fwd</span><span class="o">-&gt;</span><span class="n">bk</span><span class="p">;</span>
                    <span class="p">}</span>
                <span class="p">}</span> <span class="k">else</span>
                    <span class="c1">// If it is empty, simply make fd_nextsize and bk_nextsize form a doubly linked list.</span>
                    <span class="n">victim</span><span class="o">-&gt;</span><span class="n">fd_nextsize</span> <span class="o">=</span> <span class="n">victim</span><span class="o">-&gt;</span><span class="n">bk_nextsize</span> <span class="o">=</span> <span class="n">victim</span><span class="p">;</span>

            <span class="p">}</span>
</code></pre></div>

<h5 id="final-take-out">Final take out<a class="headerlink" href="#final-take-out" title="Permanent link">&para;</a></h5>
<div class="codehilite"><pre><span></span><code>            <span class="c1">// Put it in the corresponding bin to form bck&lt;--&gt;victim&lt;--&gt;fwd.</span>
            <span class="n">mark_bin</span><span class="p">(</span><span class="n">av</span><span class="p">,</span> <span class="n">victim_index</span><span class="p">);</span>
            <span class="n">victim</span><span class="o">-&gt;</span><span class="n">bk</span> <span class="o">=</span> <span class="n">bck</span><span class="p">;</span>
            <span class="n">victim</span><span class="o">-&gt;</span><span class="n">fd</span> <span class="o">=</span> <span class="n">fwd</span><span class="p">;</span>
            <span class="n">fwd</span><span class="o">-&gt;</span><span class="n">bk</span>    <span class="o">=</span> <span class="n">victim</span><span class="p">;</span>
            <span class="n">bck</span><span class="o">-&gt;</span><span class="n">fd</span>    <span class="o">=</span> <span class="n">victim</span><span class="p">;</span>
</code></pre></div>

<h5 id="while-iterations">while Iterations<a class="headerlink" href="#while-iterations" title="Permanent link">&para;</a></h5>
<p>While exits up to 10,000 iterations and exits.</p>
<div class="codehilite"><pre><span></span><code>            <span class="c1">// # define MAX_ITERS 10000</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">iters</span> <span class="o">&gt;=</span> <span class="n">MAX_ITERS</span><span class="p">)</span> <span class="k">break</span><span class="p">;</span>
                    <span class="p">}</span>
</code></pre></div>

<h4 id="large-chunk">large chunk<a class="headerlink" href="#large-chunk" title="Permanent link">&para;</a></h4>
<p><strong>Note: It may be very strange, why not go to see if the small chunk meets the new requirements first? This is because the small bin has already been judged before the loop. If there is one, the chunk will appear after the merge. But outside the big loop, the large chunk simply finds its index, so it feels reasonable to judge directly here, and also to find larger chunks for the following. </strong></p>
<p>If the requested chunk is in the large chunk range, it is scanned from small to large in the corresponding bin to find the first one.</p>
<div class="codehilite"><pre><span></span><code>        <span class="cm">/*</span>
<span class="cm">           If a large request, scan through the chunks of current bin in</span>
<span class="cm">           sorted order to find smallest that fits.  Use the skip list for this.</span>
<span class="cm">         */</span>

        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">in_smallbin_range</span><span class="p">(</span><span class="n">nb</span><span class="p">))</span> <span class="p">{</span>
            <span class="n">bin</span> <span class="o">=</span> <span class="n">bin_at</span><span class="p">(</span><span class="n">av</span><span class="p">,</span> <span class="n">idx</span><span class="p">);</span>
            <span class="cm">/* skip scan if empty or largest chunk is too small */</span>
            <span class="c1">// If the corresponding bin is empty or the chunks in it are the smallest, skip it</span>
            <span class="c1">// first(bin)=bin-&gt;fd means the largest chunk in the current list.</span>
            <span class="k">if</span> <span class="p">((</span><span class="n">victim</span> <span class="o">=</span> <span class="n">first</span><span class="p">(</span><span class="n">bin</span><span class="p">))</span> <span class="o">!=</span> <span class="n">bin</span> <span class="o">&amp;&amp;</span>
                <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">chunksize_nomask</span><span class="p">(</span><span class="n">victim</span><span class="p">)</span> <span class="o">&gt;=</span>
                    <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="p">(</span><span class="n">nb</span><span class="p">))</span> <span class="p">{</span>
                <span class="c1">// Reverse traversing the list until the first chunk is found that is not less than the desired chunk size</span>
                <span class="n">victim</span> <span class="o">=</span> <span class="n">victim</span><span class="o">-&gt;</span><span class="n">bk_nextsize</span><span class="p">;</span>
                <span class="k">while</span> <span class="p">(((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="p">(</span><span class="n">size</span> <span class="o">=</span> <span class="n">chunksize</span><span class="p">(</span><span class="n">victim</span><span class="p">))</span> <span class="o">&lt;</span>
                        <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="p">(</span><span class="n">nb</span><span class="p">)))</span>
                    <span class="n">victim</span> <span class="o">=</span> <span class="n">victim</span><span class="o">-&gt;</span><span class="n">bk_nextsize</span><span class="p">;</span>

                <span class="cm">/* Avoid removing the first entry for a size so that the skip</span>
<span class="cm">                   list does not have to be rerouted.  */</span>
                <span class="c1">// If the final chunk is not the last chunk in the bin, and the chunk is in front of the chunk</span>
                <span class="c1">// The size is the same, then we take the chunk in front of it, so we can avoid adjusting bk_nextsize, fd_nextsize</span>
                <span class="c1">// linked list. Because only one chunk of the same size will be chained to the nextsize chain.</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">victim</span> <span class="o">!=</span> <span class="n">last</span><span class="p">(</span><span class="n">bin</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
                    <span class="n">chunksize_nomask</span><span class="p">(</span><span class="n">victim</span><span class="p">)</span> <span class="o">==</span> <span class="n">chunksize_nomask</span><span class="p">(</span><span class="n">victim</span><span class="o">-&gt;</span><span class="n">fd</span><span class="p">))</span>
                    <span class="n">victim</span> <span class="o">=</span> <span class="n">victim</span><span class="o">-&gt;</span><span class="n">fd</span><span class="p">;</span>
                <span class="c1">// Calculate the remaining size after the allocation</span>
                <span class="n">remainder_size</span> <span class="o">=</span> <span class="n">size</span> <span class="o">-</span> <span class="n">nb</span><span class="p">;</span>
                <span class="c1">// unlink</span>
                <span class="n">unlink</span><span class="p">(</span><span class="n">av</span><span class="p">,</span> <span class="n">victim</span><span class="p">,</span> <span class="n">bck</span><span class="p">,</span> <span class="n">fwd</span><span class="p">);</span>
                <span class="cm">/* Exhaust */</span>
                <span class="c1">// The remaining size is not enough to be a block</span>
                <span class="c1">// Very curious what will happen next?</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">remainder_size</span> <span class="o">&lt;</span> <span class="n">MINSIZE</span><span class="p">)</span> <span class="p">{</span>
                    <span class="n">set_inuse_bit_at_offset</span><span class="p">(</span><span class="n">victim</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">av</span> <span class="o">!=</span> <span class="o">&amp;</span><span class="n">main_arena</span><span class="p">)</span> <span class="n">set_non_main_arena</span><span class="p">(</span><span class="n">victim</span><span class="p">);</span>
                <span class="p">}</span>
                <span class="cm">/* Split */</span>
                <span class="c1">// The remaining size can also be split as a chunk.</span>
                <span class="k">else</span> <span class="p">{</span>
                    <span class="c1">// Get the pointer to the remaining chunk, called the reducer</span>
                    <span class="n">remainder</span> <span class="o">=</span> <span class="n">chunk_at_offset</span><span class="p">(</span><span class="n">victim</span><span class="p">,</span> <span class="n">nb</span><span class="p">);</span>
                    <span class="cm">/* We cannot assume the unsorted list is empty and therefore</span>
<span class="cm">                       have to perform a complete insert here.  */</span>
                    <span class="c1">// Insert in unsorted bin</span>
                    <span class="n">bck</span> <span class="o">=</span> <span class="n">unsorted_chunks</span><span class="p">(</span><span class="n">av</span><span class="p">);</span>
                    <span class="n">fwd</span> <span class="o">=</span> <span class="n">bck</span><span class="o">-&gt;</span><span class="n">fd</span><span class="p">;</span>

                    <span class="c1">// Determine if the unsorted bin is destroyed.</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">__glibc_unlikely</span><span class="p">(</span><span class="n">fwd</span><span class="o">-&gt;</span><span class="n">bk</span> <span class="o">!=</span> <span class="n">bck</span><span class="p">))</span> <span class="p">{</span>
                        <span class="n">errstr</span> <span class="o">=</span> <span class="s">&quot;malloc(): corrupted unsorted chunks&quot;</span><span class="p">;</span>
                        <span class="k">goto</span> <span class="n">errout</span><span class="p">;</span>
                    <span class="p">}</span>
                    <span class="n">remainder</span><span class="o">-&gt;</span><span class="n">bk</span> <span class="o">=</span> <span class="n">bck</span><span class="p">;</span>
                    <span class="n">remainder</span><span class="o">-&gt;</span><span class="n">fd</span> <span class="o">=</span> <span class="n">fwd</span><span class="p">;</span>
                    <span class="n">bck</span><span class="o">-&gt;</span><span class="n">fd</span>       <span class="o">=</span> <span class="n">remainder</span><span class="p">;</span>
                    <span class="n">fwd</span><span class="o">-&gt;</span><span class="n">bk</span>       <span class="o">=</span> <span class="n">remainder</span><span class="p">;</span>
                    <span class="c1">// If it is not in the range of small bin, set the corresponding field</span>
                    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">in_smallbin_range</span><span class="p">(</span><span class="n">remainder_size</span><span class="p">))</span> <span class="p">{</span>
                        <span class="n">remainder</span><span class="o">-&gt;</span><span class="n">fd_nextsize</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
                        <span class="n">remainder</span><span class="o">-&gt;</span><span class="n">bk_nextsize</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
                    <span class="p">}</span>

                    <span class="c1">// Set the flag of the assigned chunk</span>
                    <span class="n">set_head</span><span class="p">(</span><span class="n">victim</span><span class="p">,</span>
                             <span class="n">nb</span> <span class="o">|</span> <span class="n">PREV_INUSE</span> <span class="o">|</span>
                                <span class="p">(</span><span class="n">av</span><span class="o">!</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">main_arena</span><span class="o">?</span> <span class="nl">NON_MAIN_ARENA</span><span class="p">:</span> <span class="mi">0</span><span class="p">));</span>
                    <span class="c1">// Set the last chunk of the remainder, that is, the usage status of the allocated chunk</span>
                    <span class="c1">// The rest of the rules are inherited directly from above.</span>
                    <span class="n">set_head</span><span class="p">(</span><span class="n">remainder</span><span class="p">,</span> <span class="n">remainder_size</span> <span class="o">|</span> <span class="n">PREV_INUSE</span><span class="p">);</span>
                    <span class="c1">// Set the size of the remainder</span>
                    <span class="n">set_foot</span><span class="p">(</span><span class="n">remainder</span><span class="p">,</span> <span class="n">remainder_size</span><span class="p">);</span>
                <span class="p">}</span>
                <span class="c1">// an examination</span>
                <span class="n">check_malloced_chunk</span><span class="p">(</span><span class="n">av</span><span class="p">,</span> <span class="n">victim</span><span class="p">,</span> <span class="n">nb</span><span class="p">);</span>
                <span class="c1">// Convert to mem state</span>
                <span class="kt">void</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">chunk2mem</span><span class="p">(</span><span class="n">victim</span><span class="p">);</span>
                <span class="c1">// If perturb_type is set, the obtained chunk is initialized to perturb_type ^ 0xff</span>
                <span class="n">alloc_perturb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">bytes</span><span class="p">);</span>
                <span class="k">return</span> <span class="n">p</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>
</code></pre></div>

<h4 id="looking-for-a-larger-chunk">Looking for a larger chunk<a class="headerlink" href="#looking-for-a-larger-chunk" title="Permanent link">&para;</a></h4>
<p>If you get here, it means that for the chunks that the user needs, you can't get the chunk directly from the corresponding bin, so we need to find the faster bin, small bin or large bin larger than the current bin.</p>
<div class="codehilite"><pre><span></span><code>        <span class="cm">/*</span>
<span class="cm">           Search for a chunk by scanning bins, starting with next largest</span>
<span class="cm">           bin. This search is strictly by best-fit; i.e., the smallest</span>
<span class="cm">           (with ties going to approximately the least recently used) chunk</span>
<span class="cm">           that fits is selected.</span>

<span class="cm">           The bitmap avoids needing to check that most blocks are nonempty.</span>
<span class="cm">           The particular case of skipping all bins during warm-up phases</span>
<span class="cm">           when no chunks have been returned yet is faster than it might look.</span>
<span class="cm">         */</span>

        <span class="o">++</span><span class="n">idx</span><span class="p">;</span>
        <span class="c1">// Get the corresponding bin</span>
        <span class="n">bin</span> <span class="o">=</span> <span class="n">bin_at</span><span class="p">(</span><span class="n">av</span><span class="p">,</span> <span class="n">idx</span><span class="p">);</span>
        <span class="c1">// Get the current index in the binmap block index</span>
        <span class="c1">// #define idx2block(i) ((i) &gt;&gt; BINMAPSHIFT)  ,BINMAPSHIFT=5</span>
        <span class="c1">// Binmap is managed by block. Each block is an int with a total of 32 bits. It can indicate whether there are free chunks in 32 bins.</span>
        <span class="c1">// So here is the right shift 5</span>
        <span class="n">block</span> <span class="o">=</span> <span class="n">idx2block</span><span class="p">(</span><span class="n">idx</span><span class="p">);</span>
        <span class="c1">// Get the mapping corresponding to the current block size, here you can know whether there is a free block in the corresponding bin</span>
        <span class="n">map</span> <span class="o">=</span> <span class="n">av</span><span class="o">-&gt;</span><span class="n">binmap</span> <span class="p">[</span><span class="n">block</span><span class="p">];</span>
        <span class="c1">// #define idx2bit(i) ((1U &lt;&lt; ((i) &amp; ((1U &lt;&lt; BINMAPSHIFT) - 1))))</span>
        <span class="c1">// Set the bit corresponding to idx to 1, and the other bits to 0.</span>
        <span class="n">bit</span>   <span class="o">=</span> <span class="n">idx2bit</span><span class="p">(</span><span class="n">idx</span><span class="p">);</span>
        <span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>
</code></pre></div>

<h5 id="find-a-suitable-map">Find a suitable map<a class="headerlink" href="#find-a-suitable-map" title="Permanent link">&para;</a></h5>
<div class="codehilite"><pre><span></span><code>            <span class="cm">/* Skip rest of block if there are no more set bits in this block.</span>
<span class="cm">             */</span>

            <span class="c1">// If bit&gt;map, it means that there is no free block in the map that is larger than the current required chunk.</span>
            <span class="c1">// If the bit is 0, then the parameter brought by idx2bit above is 0.</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">bit</span> <span class="o">&gt;</span> <span class="n">map</span> <span class="o">||</span> <span class="n">bit</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">do</span> <span class="p">{</span>
                    <span class="c1">// Find the next block until its corresponding map is not 0.</span>
                    <span class="c1">// If it doesn&#39;t exist, you can only use the top chunk.</span>
                    <span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">block</span> <span class="o">&gt;=</span> <span class="n">BINMAPSIZE</span><span class="p">)</span> <span class="cm">/* out of bins */</span>
                        <span class="k">goto</span> <span class="n">use_top</span><span class="p">;</span>
                <span class="p">}</span> <span class="k">while</span> <span class="p">((</span><span class="n">map</span> <span class="o">=</span> <span class="n">av</span><span class="o">-&gt;</span><span class="n">binmap</span><span class="p">[</span> <span class="n">block</span> <span class="p">])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span>
                <span class="c1">// Get its corresponding bin, because the chunk size in the map is larger than the required chunk, and</span>
                <span class="c1">// map itself is not 0, so there must be a chunk that meets the requirements.</span>
                <span class="n">bin</span> <span class="o">=</span> <span class="n">bin_at</span><span class="p">(</span><span class="n">av</span><span class="p">,</span> <span class="p">(</span><span class="n">block</span> <span class="o">&lt;&lt;</span> <span class="n">BINMAPSHIFT</span><span class="p">));</span>
                <span class="n">bit</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
            <span class="p">}</span>
</code></pre></div>

<h5 id="find-the-right-bin">Find the right bin<a class="headerlink" href="#find-the-right-bin" title="Permanent link">&para;</a></h5>
<div class="codehilite"><pre><span></span><code>            <span class="cm">/* Advance to bin with set bit. There must be one. */</span>

            <span class="c1">// Find from the smallest bin of the current map until you find the appropriate bin.</span>
            <span class="c1">// This is definitely there.</span>
            <span class="k">while</span> <span class="p">((</span><span class="n">bit</span> <span class="o">&amp;</span> <span class="n">map</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">bin</span> <span class="o">=</span> <span class="n">next_bin</span><span class="p">(</span><span class="n">bin</span><span class="p">);</span>
                <span class="n">bit</span> <span class="o">&lt;&lt;=</span> <span class="mi">1</span><span class="p">;</span>
                <span class="n">assert</span><span class="p">(</span><span class="n">bit</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">);</span>
            <span class="p">}</span>
</code></pre></div>

<h5 id="simple-check-chunk">Simple check chunk<a class="headerlink" href="#simple-check-chunk" title="Permanent link">&para;</a></h5>
<div class="codehilite"><pre><span></span><code>            <span class="cm">/* Inspect the bin. It is likely to be non-empty */</span>

            <span class="c1">// Get the corresponding bin</span>
            <span class="n">victim</span> <span class="o">=</span> <span class="n">last</span><span class="p">(</span><span class="n">bin</span><span class="p">);</span>

            <span class="cm">/*  If a false alarm(empty bin), clear the bit. */</span>
            <span class="c1">// If victim=bin, then we clear the bit corresponding to the map to 0 and then get the next bin.</span>
            <span class="c1">// The probability of this happening should be small.</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">victim</span> <span class="o">==</span> <span class="n">bin</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">av</span><span class="o">-&gt;</span><span class="n">binmap</span><span class="p">[</span> <span class="n">block</span> <span class="p">]</span> <span class="o">=</span> <span class="n">map</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">bit</span><span class="p">;</span> <span class="cm">/* Write through */</span>
                <span class="n">bin</span>                 <span class="o">=</span> <span class="n">next_bin</span><span class="p">(</span><span class="n">bin</span><span class="p">);</span>
                <span class="n">bit</span> <span class="o">&lt;&lt;=</span> <span class="mi">1</span><span class="p">;</span>
            <span class="p">}</span>
</code></pre></div>

<h5 id="really-take-out-chunk">Really take out chunk<a class="headerlink" href="#really-take-out-chunk" title="Permanent link">&para;</a></h5>
<div class="codehilite"><pre><span></span><code>            <span class="k">else</span> <span class="p">{</span>
                <span class="c1">// Get the size of the corresponding victim</span>
                <span class="n">size</span> <span class="o">=</span> <span class="n">chunksize</span><span class="p">(</span><span class="n">victim</span><span class="p">);</span>

                <span class="cm">/*  We know the first chunk in this bin is big enough to use. */</span>
                <span class="n">assert</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="p">(</span><span class="n">size</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="p">(</span><span class="n">nb</span><span class="p">));</span>
                <span class="c1">// Calculate the remaining size after splitting</span>
                <span class="n">remainder_size</span> <span class="o">=</span> <span class="n">size</span> <span class="o">-</span> <span class="n">nb</span><span class="p">;</span>

                <span class="cm">/* unlink */</span>
                <span class="n">unlink</span><span class="p">(</span><span class="n">av</span><span class="p">,</span> <span class="n">victim</span><span class="p">,</span> <span class="n">bck</span><span class="p">,</span> <span class="n">fwd</span><span class="p">);</span>

                <span class="cm">/* Exhaust */</span>
                <span class="c1">// What if there is not enough chunk after splitting?</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">remainder_size</span> <span class="o">&lt;</span> <span class="n">MINSIZE</span><span class="p">)</span> <span class="p">{</span>
                    <span class="n">set_inuse_bit_at_offset</span><span class="p">(</span><span class="n">victim</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">av</span> <span class="o">!=</span> <span class="o">&amp;</span><span class="n">main_arena</span><span class="p">)</span> <span class="n">set_non_main_arena</span><span class="p">(</span><span class="n">victim</span><span class="p">);</span>
                <span class="p">}</span>

                <span class="cm">/* Split */</span>
                <span class="c1">// If enough, despite the segmentation</span>
                <span class="k">else</span> <span class="p">{</span>
                    <span class="c1">// Calculate the offset of the remaining chunk</span>
                    <span class="n">remainder</span> <span class="o">=</span> <span class="n">chunk_at_offset</span><span class="p">(</span><span class="n">victim</span><span class="p">,</span> <span class="n">nb</span><span class="p">);</span>

                    <span class="cm">/* We cannot assume the unsorted list is empty and therefore</span>
<span class="cm">                       have to perform a complete insert here.  */</span>

                    <span class="c1">// Insert the remaining chunks into the unsorted bin</span>
                    <span class="n">bck</span> <span class="o">=</span> <span class="n">unsorted_chunks</span><span class="p">(</span><span class="n">av</span><span class="p">);</span>
                    <span class="n">fwd</span> <span class="o">=</span> <span class="n">bck</span><span class="o">-&gt;</span><span class="n">fd</span><span class="p">;</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">__glibc_unlikely</span><span class="p">(</span><span class="n">fwd</span><span class="o">-&gt;</span><span class="n">bk</span> <span class="o">!=</span> <span class="n">bck</span><span class="p">))</span> <span class="p">{</span>
                        <span class="n">errstr</span> <span class="o">=</span> <span class="s">&quot;malloc(): corrupted unsorted chunks 2&quot;</span><span class="p">;</span>
                        <span class="k">goto</span> <span class="n">errout</span><span class="p">;</span>
                    <span class="p">}</span>
                    <span class="n">remainder</span><span class="o">-&gt;</span><span class="n">bk</span> <span class="o">=</span> <span class="n">bck</span><span class="p">;</span>
                    <span class="n">remainder</span><span class="o">-&gt;</span><span class="n">fd</span> <span class="o">=</span> <span class="n">fwd</span><span class="p">;</span>
                    <span class="n">bck</span><span class="o">-&gt;</span><span class="n">fd</span>       <span class="o">=</span> <span class="n">remainder</span><span class="p">;</span>
                    <span class="n">fwd</span><span class="o">-&gt;</span><span class="n">bk</span>       <span class="o">=</span> <span class="n">remainder</span><span class="p">;</span>

                    <span class="cm">/* advertise as last remainder */</span>
                    <span class="c1">// If it is in the range of small bin, mark it as a remainder</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">in_smallbin_range</span><span class="p">(</span><span class="n">nb</span><span class="p">))</span> <span class="n">av</span><span class="o">-&gt;</span><span class="n">last_remainder</span> <span class="o">=</span> <span class="n">remainder</span><span class="p">;</span>
                    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">in_smallbin_range</span><span class="p">(</span><span class="n">remainder_size</span><span class="p">))</span> <span class="p">{</span>
                        <span class="n">remainder</span><span class="o">-&gt;</span><span class="n">fd_nextsize</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
                        <span class="n">remainder</span><span class="o">-&gt;</span><span class="n">bk_nextsize</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
                    <span class="p">}</span>
                    <span class="c1">// Set the use status of the victim</span>
                    <span class="n">set_head</span><span class="p">(</span><span class="n">victim</span><span class="p">,</span>
                             <span class="n">nb</span> <span class="o">|</span> <span class="n">PREV_INUSE</span> <span class="o">|</span>
                                <span class="p">(</span><span class="n">av</span><span class="o">!</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">main_arena</span><span class="o">?</span> <span class="nl">NON_MAIN_ARENA</span><span class="p">:</span> <span class="mi">0</span><span class="p">));</span>
                    <span class="c1">// Set the usage status of the remainder. Why is this?</span>
                    <span class="n">set_head</span><span class="p">(</span><span class="n">remainder</span><span class="p">,</span> <span class="n">remainder_size</span> <span class="o">|</span> <span class="n">PREV_INUSE</span><span class="p">);</span>
                    <span class="c1">// Set the size of the remainder</span>
                    <span class="n">set_foot</span><span class="p">(</span><span class="n">remainder</span><span class="p">,</span> <span class="n">remainder_size</span><span class="p">);</span>
                <span class="p">}</span>
                <span class="c1">// an examination</span>
                <span class="n">check_malloced_chunk</span><span class="p">(</span><span class="n">av</span><span class="p">,</span> <span class="n">victim</span><span class="p">,</span> <span class="n">nb</span><span class="p">);</span>
                <span class="c1">// The chunk state is converted to the mem state.</span>
                <span class="kt">void</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">chunk2mem</span><span class="p">(</span><span class="n">victim</span><span class="p">);</span>
                <span class="c1">// If perturb_type is set, the obtained chunk is initialized to perturb_type ^ 0xff</span>
                <span class="n">alloc_perturb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">bytes</span><span class="p">);</span>
                <span class="k">return</span> <span class="n">p</span><span class="p">;</span>
            <span class="p">}</span>
</code></pre></div>

<h3 id="using-top-chunk">Using top chunk<a class="headerlink" href="#using-top-chunk" title="Permanent link">&para;</a></h3>
<p>If all the chunks in the bin have no way to directly meet the requirements (that is, not merged), or there are no free chunks. Then we can only use the top chunk.</p>
<div class="codehilite"><pre><span></span><code>    <span class="nl">use_top</span><span class="p">:</span>
        <span class="cm">/*</span>
<span class="cm">           If large enough, split off the chunk bordering the end of memory</span>
<span class="cm">           (held in av-&gt;top). Note that this is in accord with the best-fit</span>
<span class="cm">           search rule.  In effect, av-&gt;top is treated as larger (and thus</span>
<span class="cm">           less well fitting) than any other available chunk since it can</span>
<span class="cm">           be extended to be as large as necessary (up to system</span>
<span class="cm">           limitations).</span>

<span class="cm">           We require that av-&gt;top always exists (i.e., has size &gt;=</span>
<span class="cm">           MINSIZE) after initialization, so if it would otherwise be</span>
<span class="cm">           exhausted by current request, it is replenished. (The main</span>
<span class="cm">           reason for ensuring it exists is that we may need MINSIZE space</span>
<span class="cm">           to put in fenceposts in sysmalloc.)</span>
<span class="cm">         */</span>

        <span class="c1">// Get the current top chunk and calculate its corresponding size</span>
        <span class="n">victim</span> <span class="o">=</span> <span class="n">av</span><span class="o">-&gt;</span><span class="n">top</span><span class="p">;</span>
        <span class="n">size</span>   <span class="o">=</span> <span class="n">chunksize</span><span class="p">(</span><span class="n">victim</span><span class="p">);</span>
        <span class="c1">// If the top chunk size still satisfies the minimum size of chunk after splitting, then you can split directly.</span>
        <span class="k">if</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="p">(</span><span class="n">size</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="p">(</span><span class="n">nb</span> <span class="o">+</span> <span class="n">MINSIZE</span><span class="p">))</span> <span class="p">{</span>
            <span class="n">remainder_size</span> <span class="o">=</span> <span class="n">size</span> <span class="o">-</span> <span class="n">nb</span><span class="p">;</span>
            <span class="n">remainder</span>      <span class="o">=</span> <span class="n">chunk_at_offset</span><span class="p">(</span><span class="n">victim</span><span class="p">,</span> <span class="n">nb</span><span class="p">);</span>
            <span class="n">av</span><span class="o">-&gt;</span><span class="n">top</span> <span class="o">=</span> <span class="n">remainder</span><span class="p">;</span>
            <span class="c1">// Here, set PREV_INUSE because if the previous chunk of the top chunk is bound to be fastbin,</span>
            <span class="c1">// The top chunk will merged, so PREV_INUSE is set here.</span>
            <span class="n">set_head</span><span class="p">(</span><span class="n">victim</span><span class="p">,</span> <span class="n">nb</span> <span class="o">|</span> <span class="n">PREV_INUSE</span> <span class="o">|</span>
                                <span class="p">(</span><span class="n">av</span><span class="o">!</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">main_arena</span><span class="o">?</span> <span class="nl">NON_MAIN_ARENA</span><span class="p">:</span> <span class="mi">0</span><span class="p">));</span>
            <span class="n">set_head</span><span class="p">(</span><span class="n">remainder</span><span class="p">,</span> <span class="n">remainder_size</span> <span class="o">|</span> <span class="n">PREV_INUSE</span><span class="p">);</span>
            <span class="n">check_malloced_chunk</span><span class="p">(</span><span class="n">av</span><span class="p">,</span> <span class="n">victim</span><span class="p">,</span> <span class="n">nb</span><span class="p">);</span>
            <span class="kt">void</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">chunk2mem</span><span class="p">(</span><span class="n">victim</span><span class="p">);</span>
            <span class="n">alloc_perturb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">bytes</span><span class="p">);</span>
            <span class="k">return</span> <span class="n">p</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="c1">// Otherwise, determine if there is a fast chunk</span>
        <span class="cm">/* When we are using atomic ops to free fast chunks we can get</span>
<span class="cm">           here for all block sizes.  */</span>
        <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">have_fastchunks</span><span class="p">(</span><span class="n">av</span><span class="p">))</span> <span class="p">{</span>
            <span class="c1">// Perform a fast bin merge first</span>
            <span class="n">malloc_consolidate</span><span class="p">(</span><span class="n">av</span><span class="p">);</span>
            <span class="cm">/* restore original bin index */</span>
            <span class="c1">// Determine whether the required chunk is in the range of small bin or large bin</span>
            <span class="c1">// and calculate the corresponding index</span>
            <span class="c1">// Wait for the next time to see if you can</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">in_smallbin_range</span><span class="p">(</span><span class="n">nb</span><span class="p">))</span>
                <span class="n">idx</span> <span class="o">=</span> <span class="n">smallbin_index</span><span class="p">(</span><span class="n">nb</span><span class="p">);</span>
            <span class="k">else</span>
                <span class="n">idx</span> <span class="o">=</span> <span class="n">largebin_index</span><span class="p">(</span><span class="n">nb</span><span class="p">);</span>
        <span class="p">}</span>
</code></pre></div>

<h3 id="heap-memory-is-not-enough">Heap memory is not enough<a class="headerlink" href="#heap-memory-is-not-enough" title="Permanent link">&para;</a></h3>
<p>If the heap memory is not enough, we need to use <code>sysmalloc</code> to apply for memory.</p>
<div class="codehilite"><pre><span></span><code>        <span class="cm">/*</span>
<span class="cm">           Otherwise, relay to handle system-dependent cases</span>
<span class="cm">         */</span>

        <span class="c1">// Otherwise, we can only apply for a bit of memory from the system again.</span>
        <span class="k">else</span> <span class="p">{</span>
            <span class="kt">void</span> <span class="o">*</span> <span class="n">p</span> <span class="o">=</span> <span class="n">sysmalloc</span><span class="p">(</span><span class="n">nb</span><span class="p">,</span> <span class="n">av</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">p</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="n">alloc_perturb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">bytes</span><span class="p">);</span>
            <span class="k">return</span> <span class="n">p</span><span class="p">;</span>
        <span class="p">}</span>
</code></pre></div>

<h2 id="_libc_calloc">_libc_calloc<a class="headerlink" href="#_libc_calloc" title="Permanent link">&para;</a></h2>
<p>Calloc is also a function in libc that requests memory blocks. The package in <code>libc</code> is <code>_libc_calloc</code>, which is described below.</p>
<div class="codehilite"><pre><span></span><code><span class="cm">/*</span>
<span class="cm">  calloc(size_t n_elements, size_t element_size);</span>
<span class="cm">  Returns a pointer to n_elements * element_size bytes, with all locations</span>
<span class="cm">  set to zero.</span>
<span class="cm">*/</span>
<span class="kt">void</span><span class="o">*</span>  <span class="nf">__libc_calloc</span><span class="p">(</span><span class="kt">size_t</span><span class="p">,</span> <span class="kt">size_t</span><span class="p">);</span>
</code></pre></div>

<h2 id="sysmalloc">sysmalloc<a class="headerlink" href="#sysmalloc" title="Permanent link">&para;</a></h2>
<p>As the comment in the function header says, this function is used to request more memory from the system when the current heap is out of memory.</p>
<div class="codehilite"><pre><span></span><code><span class="cm">/*</span>
<span class="cm">   sysmalloc handles malloc cases requiring more memory from the system.</span>
<span class="cm">   On entry, it is assumed that av-&gt;top does not have enough</span>
<span class="cm">   space to service request for nb bytes, thus requiring that av-&gt;top</span>
<span class="cm">   be extended or replaced.</span>
<span class="cm"> */</span>
</code></pre></div>

<h3 id="basic-definition">Basic definition<a class="headerlink" href="#basic-definition" title="Permanent link">&para;</a></h3>
<div class="codehilite"><pre><span></span><code><span class="k">static</span> <span class="kt">void</span> <span class="o">*</span><span class="nf">sysmalloc</span><span class="p">(</span><span class="n">INTERNAL_SIZE_T</span> <span class="n">nb</span><span class="p">,</span> <span class="n">mstate</span> <span class="n">av</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">mchunkptr</span> <span class="n">old_top</span><span class="p">;</span>        <span class="cm">/* incoming value of av-&gt;top */</span>
  <span class="n">INTERNAL_SIZE_T</span> <span class="n">old_size</span><span class="p">;</span> <span class="cm">/* its size */</span>
  <span class="kt">char</span> <span class="o">*</span><span class="n">old_end</span><span class="p">;</span>            <span class="cm">/* its end address */</span>

  <span class="kt">long</span> <span class="n">size</span><span class="p">;</span> <span class="cm">/* arg to first MORECORE or mmap call */</span>
  <span class="kt">char</span> <span class="o">*</span><span class="n">brk</span><span class="p">;</span> <span class="cm">/* return value from MORECORE */</span>

  <span class="kt">long</span> <span class="n">correction</span><span class="p">;</span> <span class="cm">/* arg to 2nd MORECORE call */</span>
  <span class="kt">char</span> <span class="o">*</span><span class="n">snd_brk</span><span class="p">;</span>   <span class="cm">/* 2nd return val */</span>

  <span class="n">INTERNAL_SIZE_T</span> <span class="n">front_misalign</span><span class="p">;</span> <span class="cm">/* unusable bytes at front of new space */</span>
  <span class="n">INTERNAL_SIZE_T</span> <span class="n">end_misalign</span><span class="p">;</span>   <span class="cm">/* partial page left at end of new space */</span>
  <span class="kt">char</span> <span class="o">*</span><span class="n">aligned_brk</span><span class="p">;</span>              <span class="cm">/* aligned offset into brk */</span>

  <span class="n">mchunkptr</span> <span class="n">p</span><span class="p">;</span>                  <span class="cm">/* the allocated/returned chunk */</span>
  <span class="n">mchunkptr</span> <span class="n">remainder</span><span class="p">;</span>          <span class="cm">/* remainder frOm allocation */</span>
  <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">remainder_size</span><span class="p">;</span> <span class="cm">/* its size */</span>

  <span class="kt">size_t</span> <span class="n">pagesize</span> <span class="o">=</span> <span class="n">GLRO</span><span class="p">(</span><span class="n">dl_pagesize</span><span class="p">);</span>
  <span class="kt">bool</span> <span class="n">tried_mmap</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
</code></pre></div>

<p>We can mainly focus on <code>pagesize</code>, which</p>
<div class="codehilite"><pre><span></span><code><span class="cp">#ifndef EXEC_PAGESIZE</span>
<span class="cp">#define EXEC_PAGESIZE   4096</span>
<span class="cp">#endif</span>
<span class="cp"># define GLRO(name) _##name</span>
<span class="kt">size_t</span> <span class="n">_dl_pagesize</span> <span class="o">=</span> <span class="n">EXEC_PAGESIZE</span><span class="p">;</span>
</code></pre></div>

<p>So, <code>pagesize=4096=0x1000</code>.</p>
<h3 id="consider-mmap">Consider mmap<a class="headerlink" href="#consider-mmap" title="Permanent link">&para;</a></h3>
<p>As stated in the opening comment, if any of the following conditions are met</p>
<ol>
<li>There is no heap allocated.</li>
<li>If the requested memory is larger than <code>mp_.mmap_threshold</code> and the number of mmap is less than the maximum value, you can try to use mmap.</li>
</ol>
<p>By default, the threshold is</p>
<div class="codehilite"><pre><span></span><code><span class="k">static</span> <span class="k">struct</span> <span class="n">malloc_par</span> <span class="n">mp_</span> <span class="o">=</span> <span class="p">{</span>
    <span class="p">.</span><span class="n">top_pad</span> <span class="o">=</span> <span class="n">DEFAULT_TOP_PAD</span><span class="p">,</span>
    <span class="p">.</span><span class="n">n_mmaps_max</span> <span class="o">=</span> <span class="n">DEFAULT_MMAP_MAX</span><span class="p">,</span>
    <span class="p">.</span><span class="n">mmap_threshold</span> <span class="o">=</span> <span class="n">DEFAULT_MMAP_THRESHOLD</span><span class="p">,</span>
    <span class="p">.</span><span class="n">trim_threshold</span> <span class="o">=</span> <span class="n">DEFAULT_TRIM_THRESHOLD</span><span class="p">,</span>
<span class="cp">#define NARENAS_FROM_NCORES(n) ((n) * (sizeof(long) == 4 ? 2 : 8))</span>
    <span class="p">.</span><span class="n">arena_test</span> <span class="o">=</span> <span class="n">NARENAS_FROM_NCORES</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="cp">#if USE_TCACHE</span>
        <span class="p">,</span>
    <span class="p">.</span><span class="n">tcache_count</span> <span class="o">=</span> <span class="n">TCACHE_FILL_COUNT</span><span class="p">,</span>
    <span class="p">.</span><span class="n">tcache_bins</span> <span class="o">=</span> <span class="n">TCACHE_MAX_BINS</span><span class="p">,</span>
    <span class="p">.</span><span class="n">tcache_max_bytes</span> <span class="o">=</span> <span class="n">tidx2usize</span><span class="p">(</span><span class="n">TCACHE_MAX_BINS</span> <span class="o">-</span> <span class="mi">1</span><span class="p">),</span>
    <span class="p">.</span><span class="n">tcache_unsorted_limit</span> <span class="o">=</span> <span class="mi">0</span> <span class="cm">/* No limit.  */</span>
<span class="cp">#endif</span>
<span class="p">};</span>
</code></pre></div>

<p><code>DEFAULT_MMAP_THRESHOLD</code> is 128*1024 bytes, or 128 K.</p>
<div class="codehilite"><pre><span></span><code><span class="cp">#ifndef DEFAULT_MMAP_THRESHOLD</span>
<span class="cp">#define DEFAULT_MMAP_THRESHOLD DEFAULT_MMAP_THRESHOLD_MIN</span>
<span class="cp">#endif</span>
<span class="cm">/*</span>
<span class="cm">  MMAP_THRESHOLD_MAX and _MIN are the bounds on the dynamically</span>
<span class="cm">  adjusted MMAP_THRESHOLD.</span>
<span class="cm">*/</span>

<span class="cp">#ifndef DEFAULT_MMAP_THRESHOLD_MIN</span>
<span class="cp">#define DEFAULT_MMAP_THRESHOLD_MIN (128 * 1024)</span>
<span class="cp">#endif</span>

<span class="cp">#ifndef DEFAULT_MMAP_THRESHOLD_MAX</span>
<span class="cm">/* For 32-bit platforms we cannot increase the maximum mmap</span>
<span class="cm">   threshold much because it is also the minimum value for the</span>
<span class="cm">   maximum heap size and its alignment.  Going above 512k (i.e., 1M</span>
<span class="cm">   for new heaps) wastes too much address space.  */</span>
<span class="cp">#if __WORDSIZE == 32</span>
<span class="cp">#define DEFAULT_MMAP_THRESHOLD_MAX (512 * 1024)</span>
<span class="cp">#else</span>
<span class="cp">#define DEFAULT_MMAP_THRESHOLD_MAX (4 * 1024 * 1024 * sizeof(long))</span>
<span class="cp">#endif</span>
<span class="cp">#endif</span>
</code></pre></div>

<p>The following is part of the code, which is not the focus of our concern at present, and can be skipped temporarily.</p>
<div class="codehilite"><pre><span></span><code>  <span class="cm">/*</span>
<span class="cm">     If have mmap, and the request size meets the mmap threshold, and</span>
<span class="cm">     the system supports mmap, and there are few enough currently</span>
<span class="cm">     allocated mmapped regions, try to directly map this request</span>
<span class="cm">     rather than expanding top.</span>
<span class="cm">   */</span>

<span class="k">if</span> <span class="p">(</span><span class="n">av</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span>
      <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)(</span><span class="n">nb</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)(</span><span class="n">mp_</span><span class="p">.</span><span class="n">mmap_threshold</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
      <span class="p">(</span><span class="n">mp_</span><span class="p">.</span><span class="n">n_mmaps</span> <span class="o">&lt;</span><span class="n">mp_</span><span class="p">.</span><span class="n">n_mmaps_max</span><span class="p">))</span> <span class="p">{</span>
    <span class="kt">char</span> <span class="o">*</span><span class="n">mm</span><span class="p">;</span> <span class="cm">/* return value from mmap call*/</span>

  <span class="nl">try_mmap</span><span class="p">:</span>
    <span class="cm">/*</span>
<span class="cm">       Round up size to nearest page.  For mmapped chunks, the overhead</span>
<span class="cm">       is one SIZE_SZ unit larger than for normal chunks, because there</span>
<span class="cm">       is no following chunk whose prev_size field could be used.</span>

<span class="cm">       See the front_misalign handling below, for glibc there is no</span>
<span class="cm">       need for further alignments unless we have have high alignment.</span>
<span class="cm">     */</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">MALLOC_ALIGNMENT</span> <span class="o">==</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">SIZE_SZ</span><span class="p">)</span>
      <span class="n">size</span> <span class="o">=</span> <span class="n">ALIGN_UP</span><span class="p">(</span><span class="n">nb</span> <span class="o">+</span> <span class="n">SIZE_SZ</span><span class="p">,</span> <span class="n">pagesize</span><span class="p">);</span>
    <span class="k">else</span>
      <span class="n">size</span> <span class="o">=</span> <span class="n">ALIGN_UP</span><span class="p">(</span><span class="n">nb</span> <span class="o">+</span> <span class="n">SIZE_SZ</span> <span class="o">+</span> <span class="n">MALLOC_ALIGN_MASK</span><span class="p">,</span> <span class="n">pagesize</span><span class="p">);</span>
    <span class="n">tried_mmap</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

    <span class="cm">/* Don&#39;t try if size wraps around 0 */</span>
    <span class="k">if</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)(</span><span class="n">size</span><span class="p">)</span> <span class="o">&gt;</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)(</span><span class="n">nb</span><span class="p">))</span> <span class="p">{</span>
      <span class="n">mm</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)(</span><span class="n">MMAP</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">PROT_READ</span> <span class="o">|</span> <span class="n">PROT_WRITE</span><span class="p">,</span> <span class="mi">0</span><span class="p">));</span>

      <span class="k">if</span> <span class="p">(</span><span class="n">mm</span> <span class="o">!=</span> <span class="n">MAP_FAILED</span><span class="p">)</span> <span class="p">{</span>
        <span class="cm">/*</span>
<span class="cm">           The offset to the start of the mmapped region is stored</span>
<span class="cm">           in the prev_size field of the chunk. This allows us to adjust</span>
<span class="cm">           returned start address to meet alignment requirements here</span>
<span class="cm">           and in memalign(), and still be able to compute proper</span>
<span class="cm">           address argument for later munmap in free() and realloc().</span>
<span class="cm">         */</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">MALLOC_ALIGNMENT</span> <span class="o">==</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">SIZE_SZ</span><span class="p">)</span> <span class="p">{</span>
          <span class="cm">/* For glibc, chunk2mem increases the address by 2*SIZE_SZ and</span>
<span class="cm">             MALLOC_ALIGN_MASK is 2*SIZE_SZ-1.  Each mmap&#39;ed area is page</span>
<span class="cm">             aligned and therefore definitely MALLOC_ALIGN_MASK-aligned.  */</span>
          <span class="n">assert</span><span class="p">(((</span><span class="n">INTERNAL_SIZE_T</span><span class="p">)</span><span class="n">chunk2mem</span><span class="p">(</span><span class="n">mm</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">MALLOC_ALIGN_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span>
          <span class="n">front_misalign</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span>
          <span class="n">front_misalign</span> <span class="o">=</span> <span class="p">(</span><span class="n">INTERNAL_SIZE_T</span><span class="p">)</span><span class="n">chunk2mem</span><span class="p">(</span><span class="n">mm</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">MALLOC_ALIGN_MASK</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">front_misalign</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
          <span class="n">correction</span> <span class="o">=</span> <span class="n">MALLOC_ALIGNMENT</span> <span class="o">-</span> <span class="n">front_misalign</span><span class="p">;</span>
          <span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="n">mchunkptr</span><span class="p">)(</span><span class="n">mm</span> <span class="o">+</span> <span class="n">correction</span><span class="p">);</span>
          <span class="n">set_prev_size</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">correction</span><span class="p">);</span>
          <span class="n">set_head</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="p">(</span><span class="n">size</span> <span class="o">-</span> <span class="n">correction</span><span class="p">)</span> <span class="o">|</span> <span class="n">IS_MMAPPED</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
          <span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="n">mchunkptr</span><span class="p">)</span><span class="n">mm</span><span class="p">;</span>
          <span class="n">set_prev_size</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
          <span class="n">set_head</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">size</span> <span class="o">|</span> <span class="n">IS_MMAPPED</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="cm">/* update statistics */</span>

        <span class="kt">int</span> <span class="n">new</span> <span class="o">=</span> <span class="n">atomic_exchange_and_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mp_</span><span class="p">.</span><span class="n">n_mmaps</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
        <span class="n">atomic_max</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mp_</span><span class="p">.</span><span class="n">max_n_mmaps</span><span class="p">,</span> <span class="n">new</span><span class="p">);</span>

        <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">sum</span><span class="p">;</span>
        <span class="n">sum</span> <span class="o">=</span> <span class="n">atomic_exchange_and_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mp_</span><span class="p">.</span><span class="n">mmapped_mem</span><span class="p">,</span> <span class="n">size</span><span class="p">)</span> <span class="o">+</span> <span class="n">size</span><span class="p">;</span>
        <span class="n">atomic_max</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mp_</span><span class="p">.</span><span class="n">max_mmapped_mem</span><span class="p">,</span> <span class="n">sum</span><span class="p">);</span>

        <span class="n">check_chunk</span><span class="p">(</span><span class="n">av</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>

        <span class="k">return</span> <span class="nf">chunk2mem</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
</code></pre></div>

<h3 id="mmap-failed-or-unallocated-heap">mmap failed or unallocated heap<a class="headerlink" href="#mmap-failed-or-unallocated-heap" title="Permanent link">&para;</a></h3>
<div class="codehilite"><pre><span></span><code>  <span class="cm">/* There are no usable arenas and mmap also failed.  */</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">av</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</code></pre></div>

<p>If it is any of these two situations, you can actually quit. .</p>
<h3 id="recording-old-heap-information">Recording old heap information<a class="headerlink" href="#recording-old-heap-information" title="Permanent link">&para;</a></h3>
<div class="codehilite"><pre><span></span><code>  <span class="cm">/* Record incoming configuration of top */</span>
  <span class="n">old_top</span> <span class="o">=</span> <span class="n">av</span><span class="o">-&gt;</span><span class="n">top</span><span class="p">;</span>
  <span class="n">old_size</span> <span class="o">=</span> <span class="n">chunksize</span><span class="p">(</span><span class="n">old_top</span><span class="p">);</span>
  <span class="n">old_end</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)(</span><span class="n">chunk_at_offset</span><span class="p">(</span><span class="n">old_top</span><span class="p">,</span> <span class="n">old_size</span><span class="p">));</span>

  <span class="n">brk</span> <span class="o">=</span> <span class="n">snd_brk</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)(</span><span class="n">MORECORE_FAILURE</span><span class="p">);</span>
</code></pre></div>

<h3 id="check-old-heap-information-1">Check old heap information 1<a class="headerlink" href="#check-old-heap-information-1" title="Permanent link">&para;</a></h3>
<div class="codehilite"><pre><span></span><code>  <span class="cm">/*</span>
<span class="cm">     If not the first time through, we require old_size to be</span>
<span class="cm">     at least MINSIZE and to have prev_inuse set.</span>
<span class="cm">   */</span>

  <span class="n">assert</span><span class="p">((</span><span class="n">old_top</span> <span class="o">==</span> <span class="n">initial_top</span><span class="p">(</span><span class="n">av</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">old_size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span>
         <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)(</span><span class="n">old_size</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">MINSIZE</span> <span class="o">&amp;&amp;</span> <span class="n">prev_inuse</span><span class="p">(</span><span class="n">old_top</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
          <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">old_end</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">pagesize</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">));</span>
</code></pre></div>

<p>This check requires that any one of the conditions be met</p>
<ol>
<li><code>old_top == initial_top(av) &amp;&amp; old_size == 0</code>, ie if it is the first time, the heap size needs to be 0.</li>
<li>The new heap, then</li>
<li><code>(unsigned long)(old_size) &gt;= MINSIZE &amp;&amp; prev_inuse(old_top)</code>, the heap size should be no smaller than <code>MINSIZE</code>, and the previous heap block should be in use.</li>
<li><code>((unsigned long)old_end &amp;(pagesize - 1)) == 0)</code>, the end address of the heap should be page-aligned. Since the page alignment size defaults to 0x1000, the lower 12 bits need to be 0.</li>
</ol>
<h3 id="check-old-heap-information-2">Check old heap information 2<a class="headerlink" href="#check-old-heap-information-2" title="Permanent link">&para;</a></h3>
<div class="codehilite"><pre><span></span><code>  <span class="cm">/* Precondition: not enough current space to satisfy nb request */</span>
  <span class="n">assert</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)(</span><span class="n">old_size</span><span class="p">)</span> <span class="o">&lt;</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)(</span><span class="n">nb</span> <span class="o">+</span> <span class="n">MINSIZE</span><span class="p">));</span>
</code></pre></div>

<p>According to the definition in malloc</p>
<div class="codehilite"><pre><span></span><code><span class="k">static</span> <span class="kt">void</span> <span class="o">*</span><span class="nf">_int_malloc</span><span class="p">(</span><span class="n">mstate</span> <span class="n">av</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">bytes</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">INTERNAL_SIZE_T</span> <span class="n">nb</span><span class="p">;</span>  <span class="cm">/* normalized request size */</span>
</code></pre></div>

<p><code>nb</code> should be the byte that has been added to the chunk header. Why add <code>MINSIZE</code>? This is because the size of the top chunk should at least reserve the MINSIZE space for easy merging.</p>
<h3 id="non-main_arena">Non main_arena<a class="headerlink" href="#non-main_arena" title="Permanent link">&para;</a></h3>
<p>This is not the focus of care for the time being, and it will not be analyzed for the time being.</p>
<div class="codehilite"><pre><span></span><code>  <span class="k">if</span> <span class="p">(</span><span class="n">av</span><span class="o">!</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">main_arena</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">heap_info</span> <span class="o">*</span><span class="n">old_heap</span><span class="p">,</span> <span class="o">*</span><span class="n">heap</span><span class="p">;</span>
    <span class="kt">size_t</span> <span class="n">old_heap_size</span><span class="p">;</span>

    <span class="cm">/* First try to extend the current heap. */</span>
    <span class="n">old_heap</span> <span class="o">=</span> <span class="n">heap_for_ptr</span><span class="p">(</span><span class="n">old_top</span><span class="p">);</span>
    <span class="n">old_heap_size</span> <span class="o">=</span> <span class="n">old_heap</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">((</span><span class="kt">long</span><span class="p">)(</span><span class="n">MINSIZE</span> <span class="o">+</span> <span class="n">nb</span> <span class="o">-</span> <span class="n">old_size</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
        <span class="n">grow_heap</span><span class="p">(</span><span class="n">old_heap</span><span class="p">,</span> <span class="n">MINSIZE</span> <span class="o">+</span> <span class="n">nb</span> <span class="o">-</span> <span class="n">old_size</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">av</span><span class="o">-&gt;</span><span class="n">system_mem</span> <span class="o">+=</span> <span class="n">old_heap</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">-</span> <span class="n">old_heap_size</span><span class="p">;</span>
      <span class="n">set_head</span><span class="p">(</span><span class="n">old_top</span><span class="p">,</span>
               <span class="p">(((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">old_heap</span> <span class="o">+</span> <span class="n">old_heap</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">old_top</span><span class="p">)</span> <span class="o">|</span>
                   <span class="n">PREV_INUSE</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">heap</span> <span class="o">=</span> <span class="n">new_heap</span><span class="p">(</span><span class="n">nb</span> <span class="o">+</span> <span class="p">(</span><span class="n">MINSIZE</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">heap</span><span class="p">)),</span> <span class="n">mp_</span><span class="p">.</span><span class="n">top_pad</span><span class="p">)))</span> <span class="p">{</span>
      <span class="cm">/* Use a newly allocated heap.  */</span>
      <span class="n">heap</span><span class="o">-&gt;</span><span class="n">ar_ptr</span> <span class="o">=</span> <span class="n">av</span><span class="p">;</span>
      <span class="n">heap</span><span class="o">-&gt;</span><span class="n">prev</span> <span class="o">=</span> <span class="n">old_heap</span><span class="p">;</span>
      <span class="n">av</span><span class="o">-&gt;</span><span class="n">system_mem</span> <span class="o">+</span> <span class="o">=</span> <span class="n">heap</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">;</span>
      <span class="cm">/* Set up the new top.  */</span>
      <span class="n">top</span><span class="p">(</span><span class="n">av</span><span class="p">)</span> <span class="o">=</span> <span class="n">chunk_at_offset</span><span class="p">(</span><span class="n">heap</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">heap</span><span class="p">));</span>
      <span class="n">set_head</span><span class="p">(</span><span class="n">top</span><span class="p">(</span><span class="n">av</span><span class="p">),</span> <span class="p">(</span><span class="n">heap</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">-</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">heap</span><span class="p">))</span> <span class="o">|</span> <span class="n">PREV_INUSE</span><span class="p">);</span>

      <span class="cm">/* Setup fencepost and free the old top chunk with a multiple of</span>
<span class="cm">         MALLOC_ALIGNMENT in size. */</span>
      <span class="cm">/* The fencepost takes at least MINSIZE bytes, because it might</span>
<span class="cm">         become the top chunk again later.  Note that a footer is set</span>
<span class="cm">         up, too, although the chunk is marked in use. */</span>
      <span class="n">old_size</span> <span class="o">=</span> <span class="p">(</span><span class="n">old_size</span> <span class="o">-</span> <span class="n">MINSIZE</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">MALLOC_ALIGN_MASK</span><span class="p">;</span>
      <span class="n">set_head</span><span class="p">(</span><span class="n">chunk_at_offset</span><span class="p">(</span><span class="n">old_top</span><span class="p">,</span> <span class="n">old_size</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">SIZE_SZ</span><span class="p">),</span>
               <span class="mi">0</span> <span class="o">|</span> <span class="n">PREV_INUSE</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">old_size</span> <span class="o">&gt;=</span> <span class="n">MINSIZE</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">set_head</span><span class="p">(</span><span class="n">chunk_at_offset</span><span class="p">(</span><span class="n">old_top</span><span class="p">,</span> <span class="n">old_size</span><span class="p">),</span>
                 <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">SIZE_SZ</span><span class="p">)</span> <span class="o">|</span> <span class="n">PREV_INUSE</span><span class="p">);</span>
        <span class="n">set_foot</span><span class="p">(</span><span class="n">chunk_at_offset</span><span class="p">(</span><span class="n">old_top</span><span class="p">,</span> <span class="n">old_size</span><span class="p">),</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">SIZE_SZ</span><span class="p">));</span>
        <span class="n">set_head</span><span class="p">(</span><span class="n">old_top</span><span class="p">,</span> <span class="n">old_size</span> <span class="o">|</span> <span class="n">PREV_INUSE</span> <span class="o">|</span> <span class="n">NON_MAIN_ARENA</span><span class="p">);</span>
        <span class="n">_int_free</span><span class="p">(</span><span class="n">av</span><span class="p">,</span> <span class="n">old_top</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="n">set_head</span><span class="p">(</span><span class="n">old_top</span><span class="p">,</span> <span class="p">(</span><span class="n">old_size</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">SIZE_SZ</span><span class="p">)</span> <span class="o">|</span> <span class="n">PREV_INUSE</span><span class="p">);</span>
        <span class="n">set_foot</span><span class="p">(</span><span class="n">old_top</span><span class="p">,</span> <span class="p">(</span><span class="n">old_size</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">SIZE_SZ</span><span class="p">));</span>
      <span class="p">}</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tried_mmap</span><span class="p">)</span>
      <span class="cm">/* We can at least try to use to mmap memory.  */</span>
      <span class="k">goto</span> <span class="n">try_mmap</span><span class="p">;</span>
  <span class="p">}</span>
</code></pre></div>

<h3 id="main_arena-processing">Main_arena Processing<a class="headerlink" href="#main_arena-processing" title="Permanent link">&para;</a></h3>
<h4 id="calculating-memory">Calculating memory<a class="headerlink" href="#calculating-memory" title="Permanent link">&para;</a></h4>
<p>The calculation can satisfy the requested memory size.</p>
<div class="codehilite"><pre><span></span><code><span class="k">else</span> <span class="p">{</span><span class="o">/</span> <span class="o">*</span> <span class="n">by</span> <span class="o">==</span> <span class="n">main_arena</span> <span class="o">*</span> <span class="o">/</span>

    <span class="cm">/* Request enough space for nb + pad + overhead */</span>
    <span class="n">size</span> <span class="o">=</span> <span class="n">nb</span> <span class="o">+</span> <span class="n">mp_</span><span class="p">.</span><span class="n">top_pad</span> <span class="o">+</span> <span class="n">MINSIZE</span><span class="p">;</span>
</code></pre></div>

<p>By default <code>top_pad</code> is defined as</p>
<div class="codehilite"><pre><span></span><code><span class="cp">#ifndef DEFAULT_TOP_PAD</span>
<span class="cp"># define DEFAULT_TOP_PAD 131072</span>
<span class="cp">#endif</span>
</code></pre></div>

<p>That is, 131072 bytes, 0x20000 bytes.</p>
<h4 id="whether-it-is-continuous">Whether it is continuous<a class="headerlink" href="#whether-it-is-continuous" title="Permanent link">&para;</a></h4>
<p>If we want the heap space to be continuous, then we can actually reuse the previous memory.</p>
<div class="codehilite"><pre><span></span><code>    <span class="cm">/*</span>
<span class="cm">       If contiguous, we can subtract out existing space that we hope to</span>
<span class="cm">       combine with new space. We add it back later only if</span>
<span class="cm">       we don&#39;t actually get contiguous space.</span>
<span class="cm">     */</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">contiguous</span><span class="p">(</span><span class="n">av</span><span class="p">))</span>
      <span class="n">size</span> <span class="o">-=</span> <span class="n">old_size</span><span class="p">;</span>
</code></pre></div>

<h4 id="align-page-size">Align page size<a class="headerlink" href="#align-page-size" title="Permanent link">&para;</a></h4>
<div class="codehilite"><pre><span></span><code>    <span class="cm">/*</span>
<span class="cm">       Round to a multiple of page size.</span>
<span class="cm">       If MORECORE is not contiguous, this ensures that we only call it</span>
<span class="cm">       with whole-page arguments.  And if MORECORE is contiguous and</span>
<span class="cm">       this is not first time through, this preserves page-alignment of</span>
<span class="cm">       previous calls. Otherwise, we correct to page-align below.</span>

<span class="cm">     */</span>

    <span class="n">size</span> <span class="o">=</span> <span class="n">ALIGN_UP</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">pagesize</span><span class="p">);</span>
</code></pre></div>

<h4 id="applying-for-memory">Applying for memory<a class="headerlink" href="#applying-for-memory" title="Permanent link">&para;</a></h4>
<div class="codehilite"><pre><span></span><code>    <span class="cm">/*</span>
<span class="cm">       Don&#39;t try to call MORECORE if argument is so big as to appear</span>
<span class="cm">       negative. Note that since mmap takes size_t arg, it may succeed</span>
<span class="cm">       below even if we cannot call MORECORE.</span>
<span class="cm">     */</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">brk</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)(</span><span class="n">MORECORE</span><span class="p">(</span><span class="n">size</span><span class="p">));</span>
      <span class="n">LIBC_PROBE</span><span class="p">(</span><span class="n">memory_sbrk_more</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">brk</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
    <span class="p">}</span>
</code></pre></div>

<h5 id="may-succeed">May succeed<a class="headerlink" href="#may-succeed" title="Permanent link">&para;</a></h5>
<div class="codehilite"><pre><span></span><code>    <span class="k">if</span> <span class="p">(</span><span class="n">brk</span> <span class="o">!=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)(</span><span class="n">MORECORE_FAILURE</span><span class="p">))</span> <span class="p">{</span>
      <span class="cm">/* Call the `morecore&#39; hook if necessary.  */</span>
      <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">hook</span><span class="p">)(</span><span class="kt">void</span><span class="p">)</span> <span class="o">=</span> <span class="n">atomic_forced_read</span><span class="p">(</span><span class="n">__after_morecore_hook</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">__builtin_expect</span><span class="p">(</span><span class="n">hook</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
        <span class="p">(</span><span class="o">*</span><span class="n">hook</span><span class="p">)();</span>
    <span class="p">}</span>
</code></pre></div>

<p>It is a bit of a meaning to call a hook here.</p>
<h5 id="failed">Failed<a class="headerlink" href="#failed" title="Permanent link">&para;</a></h5>
<p>Failure, consider mmap.</p>
<div class="codehilite"><pre><span></span><code><span class="k">else</span> <span class="p">{</span>
      <span class="cm">/*</span>
<span class="cm">         If have mmap, try using it as a backup when MORECORE fails or</span>
<span class="cm">         cannot be used. This is worth doing on systems that have &quot;holes&quot; in</span>
<span class="cm">         address space, so sbrk cannot extend to give contiguous space, but</span>
<span class="cm">         space is available elsewhere.  Note that we ignore mmap max count</span>
<span class="cm">         and threshold limits, since the space will not be used as a</span>
<span class="cm">         segregated mmap region.</span>
<span class="cm">       */</span>

      <span class="cm">/* Cannot merge with old top, so add its size back in */</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">contiguous</span><span class="p">(</span><span class="n">av</span><span class="p">))</span>
        <span class="n">size</span> <span class="o">=</span> <span class="n">ALIGN_UP</span><span class="p">(</span><span class="n">size</span> <span class="o">+</span> <span class="n">old_size</span><span class="p">,</span> <span class="n">pagesize</span><span class="p">);</span>

      <span class="cm">/* If we are relying on mmap as backup, then use larger units */</span>
      <span class="k">if</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)(</span><span class="n">size</span><span class="p">)</span> <span class="o">&lt;</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)(</span><span class="n">MMAP_AS_MORECORE_SIZE</span><span class="p">))</span>
        <span class="n">size</span> <span class="o">=</span> <span class="n">MMAP_AS_MORECORE_SIZE</span><span class="p">;</span>

      <span class="cm">/* Don&#39;t try if size wraps around 0 */</span>
      <span class="k">if</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)(</span><span class="n">size</span><span class="p">)</span> <span class="o">&gt;</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)(</span><span class="n">nb</span><span class="p">))</span> <span class="p">{</span>
        <span class="kt">char</span> <span class="o">*</span><span class="n">mbrk</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)(</span><span class="n">MMAP</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">PROT_READ</span> <span class="o">|</span> <span class="n">PROT_WRITE</span><span class="p">,</span> <span class="mi">0</span><span class="p">));</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">mbrk</span> <span class="o">!=</span> <span class="n">MAP_FAILED</span><span class="p">)</span> <span class="p">{</span>
          <span class="cm">/* We do not need, and cannot use, another sbrk call to find end */</span>
          <span class="n">brk</span> <span class="o">=</span> <span class="n">mbrk</span><span class="p">;</span>
          <span class="n">snd_brk</span> <span class="o">=</span> <span class="n">brk</span> <span class="o">+</span> <span class="n">size</span><span class="p">;</span>

          <span class="cm">/*</span>
<span class="cm">             Record that we no longer have a contiguous sbrk region.</span>
<span class="cm">             After the first time mmap is used as backup, we do not</span>
<span class="cm">             ever rely on contiguous space since this could incorrectly</span>
<span class="cm">             bridge regions.</span>
<span class="cm">           */</span>

          <span class="n">set_noncontiguous</span><span class="p">(</span><span class="n">av</span><span class="p">);</span>
        <span class="p">}</span>

      <span class="p">}</span>

    <span class="p">}</span>
</code></pre></div>

<h4 id="memory-may-be-applied-successfully">Memory may be applied successfully<a class="headerlink" href="#memory-may-be-applied-successfully" title="Permanent link">&para;</a></h4>
<div class="codehilite"><pre><span></span><code>    <span class="k">if</span> <span class="p">(</span><span class="n">brk</span> <span class="o">!=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)(</span><span class="n">MORECORE_FAILURE</span><span class="p">))</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">mp_</span><span class="p">.</span><span class="n">sbrk_base</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">mp_srk_base</span> <span class="o">=</span> <span class="n">brk</span><span class="p">;</span>
        <span class="n">av</span><span class="o">-&gt;</span><span class="n">system_mem</span> <span class="o">+</span> <span class="o">=</span> <span class="n">size</span><span class="p">;</span>
</code></pre></div>

<h5 id="situation-1">Situation 1<a class="headerlink" href="#situation-1" title="Permanent link">&para;</a></h5>
<div class="codehilite"><pre><span></span><code>      <span class="cm">/*</span>
<span class="cm">         If MORECORE extends previous space, we can likewise extend top size.</span>
<span class="cm">       */</span>

      <span class="k">if</span> <span class="p">(</span><span class="n">brk</span> <span class="o">==</span> <span class="n">old_end</span> <span class="o">&amp;&amp;</span> <span class="n">snd_brk</span> <span class="o">==</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)(</span><span class="n">MORECORE_FAILURE</span><span class="p">))</span>
        <span class="n">set_head</span><span class="p">(</span><span class="n">old_top</span><span class="p">,</span> <span class="p">(</span><span class="n">size</span> <span class="o">+</span> <span class="n">old_size</span><span class="p">)</span> <span class="o">|</span> <span class="n">PREV_INUSE</span><span class="p">);</span>
</code></pre></div>

<h5 id="case-2-unexpected-memory-exhaustion">Case 2 - Unexpected memory exhaustion<a class="headerlink" href="#case-2-unexpected-memory-exhaustion" title="Permanent link">&para;</a></h5>
<div class="codehilite"><pre><span></span><code>      <span class="k">else</span> <span class="nf">if</span> <span class="p">(</span><span class="n">contiguous</span><span class="p">(</span><span class="n">av</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">old_size</span> <span class="o">&amp;&amp;</span> <span class="n">brk</span> <span class="o">&lt;</span> <span class="n">old_end</span><span class="p">)</span>
        <span class="cm">/* Oops!  Someone else killed our space..  Can&#39;t touch anything.  */</span>
        <span class="n">malloc_printerr</span><span class="p">(</span><span class="s">&quot;break adjusted to free malloc space&quot;</span><span class="p">);</span>
</code></pre></div>

<h5 id="handling-other-unexpected-situations">Handling other unexpected situations<a class="headerlink" href="#handling-other-unexpected-situations" title="Permanent link">&para;</a></h5>
<div class="codehilite"><pre><span></span><code>      <span class="cm">/*</span>
<span class="cm">         Otherwise, make adjustments:</span>

<span class="cm">       * If the first time through or noncontiguous, we need to call sbrk</span>
<span class="cm">          just to find out where the end of memory lies.</span>

<span class="cm">       * We need to ensure that all returned chunks from malloc will meet</span>
<span class="cm">          MALLOC_ALIGNMENT</span>

<span class="cm">       * If there was an intervening foreign sbrk, we need to adjust sbrk</span>
<span class="cm">          request size to account for fact that we will not be able to</span>
<span class="cm">          combine new space with existing space in old_top.</span>

<span class="cm">       * Almost all systems internally allocate whole pages at a time, in</span>
<span class="cm">          which case we might as well use the whole last page of request.</span>
<span class="cm">          So we allocate enough more memory to hit a page boundary now,</span>
<span class="cm">          which in turn causes future contiguous calls to page-align.</span>
<span class="cm">       */</span>

      <span class="k">else</span> <span class="p">{</span>
        <span class="n">front_misalign</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="n">end_misalign</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="n">correction</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="n">aligned_brk</span> <span class="o">=</span> <span class="n">brk</span><span class="p">;</span>
</code></pre></div>

<h6 id="processing-contiguous-memory">Processing contiguous memory<a class="headerlink" href="#processing-contiguous-memory" title="Permanent link">&para;</a></h6>
<div class="codehilite"><pre><span></span><code>        <span class="cm">/* handle contiguous cases */</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">contiguous</span><span class="p">(</span><span class="n">av</span><span class="p">))</span> <span class="p">{</span>
          <span class="cm">/* Count foreign sbrk as system_mem.  */</span>
          <span class="k">if</span> <span class="p">(</span><span class="n">old_size</span><span class="p">)</span>
            <span class="n">av</span><span class="o">-&gt;</span><span class="n">system_mem</span> <span class="o">+</span> <span class="o">=</span> <span class="n">brk</span> <span class="o">-</span> <span class="n">old_end</span><span class="p">;</span>

          <span class="cm">/* Guarantee alignment of first new chunk made from this space */</span>

          <span class="n">front_misalign</span> <span class="o">=</span> <span class="p">(</span><span class="n">INTERNAL_SIZE_T</span><span class="p">)</span><span class="n">chunk2mem</span><span class="p">(</span><span class="n">brk</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">MALLOC_ALIGN_MASK</span><span class="p">;</span>
          <span class="k">if</span> <span class="p">(</span><span class="n">front_misalign</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
            <span class="cm">/*</span>
<span class="cm">               Skip over some bytes to arrive at an aligned position.</span>
<span class="cm">               We don&#39;t need to specially mark these wasted front bytes.</span>
<span class="cm">               They will never be accessed anyway because</span>
<span class="cm">               prev_inuse of av-&gt;top (and any chunk created from its start)</span>
<span class="cm">               is always true after initialization.</span>
<span class="cm">             */</span>

            <span class="n">correction</span> <span class="o">=</span> <span class="n">MALLOC_ALIGNMENT</span> <span class="o">-</span> <span class="n">front_misalign</span><span class="p">;</span>
            <span class="n">aligned_brk</span> <span class="o">+=</span> <span class="n">correction</span><span class="p">;</span>
          <span class="p">}</span>
          <span class="cm">/*</span>
<span class="cm">             If this isn&#39;t adjacent to existing space, then we will not</span>
<span class="cm">             be able to merge with old_top space, so must add to 2nd request.</span>
<span class="cm">           */</span>

          <span class="n">correction</span> <span class="o">+=</span> <span class="n">old_size</span><span class="p">;</span>

          <span class="cm">/* Extend the end address to hit a page boundary */</span>
          <span class="n">end_misalign</span> <span class="o">=</span> <span class="p">(</span><span class="n">INTERNAL_SIZE_T</span><span class="p">)(</span><span class="n">brk</span> <span class="o">+</span> <span class="n">size</span> <span class="o">+</span> <span class="n">correction</span><span class="p">);</span>
          <span class="n">correction</span> <span class="o">+=</span> <span class="p">(</span><span class="n">ALIGN_UP</span><span class="p">(</span><span class="n">end_misalign</span><span class="p">,</span> <span class="n">pagesize</span><span class="p">))</span> <span class="o">-</span> <span class="n">end_misalign</span><span class="p">;</span>

          <span class="n">assert</span><span class="p">(</span><span class="n">correction</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">);</span>
          <span class="n">snd_brk</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)(</span><span class="n">MORECORE</span><span class="p">(</span><span class="n">correction</span><span class="p">));</span>

          <span class="cm">/*</span>
<span class="cm">             If can&#39;t allocate correction, try to at least find out current</span>
<span class="cm">             brk.  It might be enough to proceed without failing.</span>

<span class="cm">             Note that if second sbrk did NOT fail, we assume that space</span>
<span class="cm">             is contiguous with first sbrk. This is a safe assumption unless</span>
<span class="cm">             program is multithreaded but doesn&#39;t use locks and a foreign sbrk</span>
<span class="cm">             occurred between our first and second calls.</span>
<span class="cm">           */</span>

          <span class="k">if</span> <span class="p">(</span><span class="n">snd_brk</span> <span class="o">==</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)(</span><span class="n">MORECORE_FAILURE</span><span class="p">))</span> <span class="p">{</span>
            <span class="n">correction</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
            <span class="n">snd_brk</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">MORECORE</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>
          <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="cm">/* Call the `morecore&#39; hook if necessary.  */</span>
            <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">hook</span><span class="p">)(</span><span class="kt">void</span><span class="p">)</span> <span class="o">=</span> <span class="n">atomic_forced_read</span><span class="p">(</span><span class="n">__after_morecore_hook</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">__builtin_expect</span><span class="p">(</span><span class="n">hook</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
              <span class="p">(</span><span class="o">*</span><span class="n">hook</span><span class="p">)();</span>
          <span class="p">}</span>
        <span class="p">}</span>
</code></pre></div>

<h6 id="handling-discontinuous-memory">Handling discontinuous memory<a class="headerlink" href="#handling-discontinuous-memory" title="Permanent link">&para;</a></h6>
<div class="codehilite"><pre><span></span><code>        <span class="cm">/* handle non-contiguous cases */</span>
        <span class="k">else</span> <span class="p">{</span>
          <span class="k">if</span> <span class="p">(</span><span class="n">MALLOC_ALIGNMENT</span> <span class="o">==</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">SIZE_SZ</span><span class="p">)</span>
            <span class="cm">/* MORECORE/mmap must correctly align */</span>
            <span class="n">assert</span><span class="p">(((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">chunk2mem</span><span class="p">(</span><span class="n">brk</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">MALLOC_ALIGN_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span>
          <span class="k">else</span> <span class="p">{</span>
            <span class="n">front_misalign</span> <span class="o">=</span>
                <span class="p">(</span><span class="n">INTERNAL_SIZE_T</span><span class="p">)</span><span class="n">chunk2mem</span><span class="p">(</span><span class="n">brk</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">MALLOC_ALIGN_MASK</span><span class="p">;</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">front_misalign</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
              <span class="cm">/*</span>
<span class="cm">                 Skip over some bytes to arrive at an aligned position.</span>
<span class="cm">                 We don&#39;t need to specially mark these wasted front bytes.</span>
<span class="cm">                 They will never be accessed anyway because</span>
<span class="cm">                 prev_inuse of av-&gt;top (and any chunk created from its start)</span>
<span class="cm">                 is always true after initialization.</span>
<span class="cm">               */</span>

              <span class="n">aligned_brk</span> <span class="o">+=</span> <span class="n">MALLOC_ALIGNMENT</span> <span class="o">-</span> <span class="n">front_misalign</span><span class="p">;</span>
            <span class="p">}</span>
          <span class="p">}</span>

          <span class="cm">/* Find out current end of memory */</span>
          <span class="k">if</span> <span class="p">(</span><span class="n">snd_brk</span> <span class="o">==</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)(</span><span class="n">MORECORE_FAILURE</span><span class="p">))</span> <span class="p">{</span>
            <span class="n">snd_brk</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">MORECORE</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>
          <span class="p">}</span>
        <span class="p">}</span>
</code></pre></div>

<h6 id="adjustment">Adjustment<a class="headerlink" href="#adjustment" title="Permanent link">&para;</a></h6>
<div class="codehilite"><pre><span></span><code>        <span class="cm">/* Adjust top based on results of second sbrk */</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">snd_brk</span> <span class="o">!=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)(</span><span class="n">MORECORE_FAILURE</span><span class="p">))</span> <span class="p">{</span>
          <span class="n">av</span><span class="o">-&gt;</span><span class="n">top</span> <span class="o">=</span> <span class="p">(</span><span class="n">mchunkptr</span><span class="p">)</span> <span class="n">aligned_brk</span><span class="p">;</span>
          <span class="n">set_head</span><span class="p">(</span><span class="n">av</span><span class="o">-&gt;</span><span class="n">top</span><span class="p">,</span> <span class="p">(</span><span class="n">snd_brk</span> <span class="o">-</span> <span class="n">aligned_brk</span> <span class="o">+</span> <span class="n">correction</span><span class="p">)</span> <span class="o">|</span> <span class="n">PREV_INUSE</span><span class="p">);</span>
          <span class="n">av</span><span class="o">-&gt;</span><span class="n">system_mem</span> <span class="o">+</span> <span class="o">=</span> <span class="n">correction</span><span class="p">;</span>

          <span class="cm">/*</span>
<span class="cm">             If not the first time through, we either have a</span>
<span class="cm">             gap due to foreign sbrk or a non-contiguous region.  Insert a</span>
<span class="cm">             double fencepost at old_top to prevent consolidation with space</span>
<span class="cm">             we don&#39;t own. These fenceposts are artificial chunks that are</span>
<span class="cm">             marked as inuse and are in any case too small to use.  We need</span>
<span class="cm">             two to make sizes and alignments work out.</span>
<span class="cm">           */</span>

          <span class="k">if</span> <span class="p">(</span><span class="n">old_size</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
            <span class="cm">/*</span>
<span class="cm">               Shrink old_top to insert fenceposts, keeping size a</span>
<span class="cm">               multiple of MALLOC_ALIGNMENT. We know there is at least</span>
<span class="cm">               enough space in old_top to do this.</span>
<span class="cm">             */</span>
            <span class="n">old_size</span> <span class="o">=</span> <span class="p">(</span><span class="n">old_size</span> <span class="o">-</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">SIZE_SZ</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">MALLOC_ALIGN_MASK</span><span class="p">;</span>
            <span class="n">set_head</span><span class="p">(</span><span class="n">old_top</span><span class="p">,</span> <span class="n">old_size</span> <span class="o">|</span> <span class="n">PREV_INUSE</span><span class="p">);</span>

            <span class="cm">/*</span>
<span class="cm">               Note that the following assignments completely overwrite</span>
<span class="cm">               old_top when old_size was previously MINSIZE.  This is</span>
<span class="cm">               intentional. We need the fencepost, even if old_top otherwise</span>
<span class="cm">               gets lost.</span>
<span class="cm">             */</span>
            <span class="n">set_head</span><span class="p">(</span><span class="n">chunk_at_offset</span><span class="p">(</span><span class="n">old_top</span><span class="p">,</span> <span class="n">old_size</span><span class="p">),</span>
                     <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">SIZE_SZ</span><span class="p">)</span> <span class="o">|</span> <span class="n">PREV_INUSE</span><span class="p">);</span>
            <span class="n">set_head</span><span class="p">(</span><span class="n">chunk_at_offset</span><span class="p">(</span><span class="n">old_top</span><span class="p">,</span> <span class="n">old_size</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">SIZE_SZ</span><span class="p">),</span>
                     <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">SIZE_SZ</span><span class="p">)</span> <span class="o">|</span> <span class="n">PREV_INUSE</span><span class="p">);</span>

            <span class="cm">/* If possible, release the rest. */</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">old_size</span> <span class="o">&gt;=</span> <span class="n">MINSIZE</span><span class="p">)</span> <span class="p">{</span>
              <span class="n">_int_free</span><span class="p">(</span><span class="n">av</span><span class="p">,</span> <span class="n">old_top</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
            <span class="p">}</span>
          <span class="p">}</span>
        <span class="p">}</span>
      <span class="p">}</span>
</code></pre></div>

<p>It should be noted that here the program releases the old top chunk, and it will enter different bins or tcaches depending on the size.</p>
<h4 id="update-maximum-memory">Update maximum memory<a class="headerlink" href="#update-maximum-memory" title="Permanent link">&para;</a></h4>
<div class="codehilite"><pre><span></span><code>  <span class="k">if</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">av</span><span class="o">-&gt;</span><span class="n">system_mem</span> <span class="o">&gt;</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="p">(</span><span class="n">av</span><span class="o">-&gt;</span><span class="n">max_system_mem</span><span class="p">))</span>
    <span class="n">av</span><span class="o">-&gt;</span><span class="n">max_system_mem</span> <span class="o">=</span> <span class="n">av</span><span class="o">-&gt;</span><span class="n">system_mem</span><span class="p">;</span>
  <span class="n">check_malloc_state</span><span class="p">(</span><span class="n">av</span><span class="p">);</span>
</code></pre></div>

<h4 id="allocating-memory-blocks">Allocating memory blocks<a class="headerlink" href="#allocating-memory-blocks" title="Permanent link">&para;</a></h4>
<h5 id="get-the-size">Get the size<a class="headerlink" href="#get-the-size" title="Permanent link">&para;</a></h5>
<div class="codehilite"><pre><span></span><code>  <span class="cm">/* finally, do the allocation */</span>
  <span class="n">p</span> <span class="o">=</span> <span class="n">av</span><span class="o">-&gt;</span><span class="n">top</span><span class="p">;</span>
  <span class="n">size</span> <span class="o">=</span> <span class="n">chunksize</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
</code></pre></div>

<h5 id="top">切分 top<a class="headerlink" href="#top" title="Permanent link">&para;</a></h5>
<div class="codehilite"><pre><span></span><code>  <span class="cm">/* check that one of the above allocation paths succeeded */</span>
  <span class="k">if</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)(</span><span class="n">size</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)(</span><span class="n">nb</span> <span class="o">+</span> <span class="n">MINSIZE</span><span class="p">))</span> <span class="p">{</span>
    <span class="n">remainder_size</span> <span class="o">=</span> <span class="n">size</span> <span class="o">-</span> <span class="n">nb</span><span class="p">;</span>
    <span class="n">remainder</span> <span class="o">=</span> <span class="n">chunk_at_offset</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">nb</span><span class="p">);</span>
    <span class="n">av</span><span class="o">-&gt;</span><span class="n">top</span> <span class="o">=</span> <span class="n">remainder</span><span class="p">;</span>
    <span class="n">set_head</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">nb</span> <span class="o">|</span> <span class="n">PREV_INUSE</span> <span class="o">|</span> <span class="p">(</span><span class="n">av</span> <span class="o">!=</span> <span class="o">&amp;</span><span class="n">main_arena</span> <span class="o">?</span> <span class="nl">NON_MAIN_ARENA</span> <span class="p">:</span> <span class="mi">0</span><span class="p">));</span>
    <span class="n">set_head</span><span class="p">(</span><span class="n">remainder</span><span class="p">,</span> <span class="n">remainder_size</span> <span class="o">|</span> <span class="n">PREV_INUSE</span><span class="p">);</span>
    <span class="n">check_malloced_chunk</span><span class="p">(</span><span class="n">av</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">nb</span><span class="p">);</span>
    <span class="k">return</span> <span class="nf">chunk2mem</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
  <span class="p">}</span>
</code></pre></div>

<h4 id="capture-all-errors">Capture all errors<a class="headerlink" href="#capture-all-errors" title="Permanent link">&para;</a></h4>
<div class="codehilite"><pre><span></span><code>  <span class="cm">/* catch all failure paths */</span>
  <span class="n">__set_errno</span><span class="p">(</span><span class="n">ENOMEM</span><span class="p">);</span>
  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</code></pre></div>









  <h2 id="__comments">评论</h2>
  <div id="disqus_thread"></div>
  <script>
    var disqus_config = function () {
      this.page.url = "https://ctf-wiki.github.io/ctf-wiki/pwn/linux/glibc-heap/implementation/malloc/";
      this.page.identifier =
        "pwn/linux/glibc-heap/implementation/malloc/";
    };
    (function() {
      var d = document, s = d.createElement("script");
      s.src = "//ctf-wiki.disqus.com/embed.js";
      s.setAttribute("data-timestamp", +new Date());
      (d.head || d.body).appendChild(s);
    })();
  </script>


            </article>
          </div>
        </div>
      </main>


<footer class="md-footer">

  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">

          <div class="md-footer-copyright__highlight">
            Copyright &copy; 2016 - 2020 CTF Wiki Team
          </div>

        powered by
        <a href="https://www.mkdocs.org" target="_blank" rel="noopener">MkDocs</a>
        and
        <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
          Material for MkDocs</a>
      </div>

    </div>
  </div>
</footer>

    </div>

      <script src="../../../../../assets/javascripts/application.c33a9706.js"></script>




          <script src="../../../../../assets/javascripts/lunr/lunr.stemmer.support.js"></script>









      <script>app.initialize({version:"1.0.4",url:{base:"../../../../.."}})</script>

        <script src="https://cdnjs.loli.net/ajax/libs/pangu/3.3.0/pangu.min.js"></script>

        <script src="../../../../../_static/js/extra.js"></script>

        <script src="https://cdnjs.loli.net/ajax/libs/mathjax/2.7.2/MathJax.js?config=TeX-MML-AM_CHTML"></script>


  </body>
</html>
